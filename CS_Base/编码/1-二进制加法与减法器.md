# 12. 二进制加法器

加法是算术运算中最基本的运算，因此如果想搭建一台计算机（这也正是本书所隐含的内容），那么首先就要造出可以计算两个数的和的器件。当你真正面对它时，就会发现，原来加法计算就是计算机要做的唯一工作。如果我们可以造出加法器，同样地，就可以利用加法来实现减法、乘法和除法，计算按揭付款，引导火箭飞到火星、下棋，以及填写我们的话费账单。

这一章中我们要创建的加法器与现代的计算器和计算机来比，将会很庞大、很笨拙、很慢，而且运转起来噪声不断。最有趣的是我们用来制作加法器的全部零件，都是像开关、灯泡、导线、电池、逻辑门等这些在之前的章节中学过的非常简单的电子器件。这个加法器所包含的所有器件早在120多年前就已经被发明出来了。我们并不用在房间中实际搭建出什么，相反地，可以在纸上以及我们的头脑中来搭建这个加法器。

## 二进制加法表分析

二进制数加法与十进制数加法最大的不同就在于二进制数加法中用到了一个更为简单的加法表。

<img src="image/image-20241208201030782.png" alt="image-20241208201030782" style="zoom: 33%;" />

如果你是一头鲸鱼并且在学校中学习了这个表格，你会大声说出：

<img src="image/image-20241208201109806.png" alt="image-20241208201109806" style="zoom:33%;" />

以上加法表可以重新写为下面带有前导零的形式，这样每个结果就都是一个2位的值。

<img src="image/image-20241208201148193.png" alt="image-20241208201148193" style="zoom:33%;" />

像这样，一对二进制数相加的结果中具有两个数位，其中一位叫做加法位(sum bit)，另一位则叫做进位位（carry bit，例如，1加1等于0，进位为1）。下面我们将二进制数加法表分成两个表格，第一个是表示加法的。

<img src="image/image-20241208201232279.png" alt="image-20241208201232279" style="zoom:33%;" />

第二个是表示进位的。

<img src="image/image-20241208203301437.png" alt="image-20241208203301437" style="zoom:33%;" />

搭建一个二进制加法器需要我们首先设计一个电路，通过该电路执行这些操作。

与十进制数加法一样，我们将两个二进制数字串由右向左依次逐列相加。

<img src="image/image-20241208204208772.png" alt="image-20241208204208772" style="zoom:33%;" />

注意，在我们将从右边数的第3列的数相加的时候，会有一个1进位到下一列中。这在第6、第7、第8列也是一样的。

我们决定让搭建起来的二进制加法器最高能够执行的加法长度为8位。也就是说，我们想要相加的二进制数，其范围是从0000-0000到1111-1111，即十进制数的0到255。两个8位二进制的和最大可为1-1111-1110，即510。

加法器的控制面板如下图所示。

<img src="image/image-20241208204316247.png" alt="image-20241208204316247" style="zoom:33%;" />

在这个面板中，有两排开关，每排8个。这些开关就是输入设备，我们将用它们来“输入”两个8位二进制数。在这套输入设备中，开关断开（关）即表示0，闭合（开）表示1，这与你房间墙上的开关是一样的。面板底部的输出设备是一排灯泡，共9个。这些灯泡用来显示结果。不发光的灯泡表示0，发光的灯泡表示1。这里有9个灯泡，因为两个8位二进制数的相加结果可能是一个9位的二进制数。

**加法器的其他部分是以各种形式连接起来的逻辑门，开关将触发逻辑门中的继电器来点亮相应的灯泡。**例如，如果我们要将0110-0101和1011-0110（之前例子中的两个数）相加，则要将相应的开关置于下图所示位置。

<img src="image/image-20241208204350113.png" alt="image-20241208204350113" style="zoom:33%;" />

灯泡发光显示结果为：1-0001-1011（然而，这只是一个希望的结果，因为我们还没有将加法器真正搭建出来！）

## 逻辑门与二进制加法

当看到进位（两个1相加就会产生一个进位）结果表的时候，或许你已经看出来逻辑门和二进制加法的一些相关性了。

<img src="image/image-20241208204541550.png" alt="image-20241208204541550" style="zoom:33%;" />

你可能意识到了，这和上一章中与门的输出结果是一样的。

<img src="image/image-20241208204636091.png" alt="image-20241208204636091" style="zoom:33%;" />

因此，利用与门可以计算两个二进制数加法的进位。

到此，我们着实取得了一些进展，下面我们要做的就是利用继电器来实现下表。

<img src="image/image-20241208204700942.png" alt="image-20241208204700942" style="zoom:33%;" />

这是在做两个二进制数加法时需要解决的另一个问题。加法位的情况并不像进位位那样简单，但是我们即将实现它。

首先我们要知道，或门和我们想要的结果很相似，除了右下角的结果。

<img src="image/image-20241208204738703.png" alt="image-20241208204738703" style="zoom:33%;" />

与非门同样和我们想要的结果很相似，除了左上角的结果。

<img src="image/image-20241208204949782.png" alt="image-20241208204949782" style="zoom:33%;" />

下面我们将或门和与非门连接到相同的输入上，如下图所示。

<img src="image/image-20241208205023358.png" alt="image-20241208205023358" style="zoom:33%;" />

下表总结了或门和与非门的输出，并将其与我们想要的结果进行了对比。

<img src="image/image-20241208205107116.png" alt="image-20241208205107116" style="zoom:33%;" />

### 异或门

注意，我们想要的是1，那么这种情况只有在或门和与非门的输出都为1时才会出现。这表明两个输出端可以通过一个与门连接到一起。

<img src="image/image-20241208205354692.png" alt="image-20241208205354692" style="zoom:33%;" />

这就是我们想要的结果。

注意，在整个电路中仍然有两个输入和一个输出，两个输入同时作为或门和与非门的输入，或门和与非门的输出又分别作为一个与门的输入，最后得出了我们想要的结果。

<img src="image/image-20241208205506479.png" alt="image-20241208205506479" style="zoom:33%;" />

实际上这个电路有个专门的名称，叫做异或门，简写为XOR。之所以称为异或门是因为若想其输出结果为1，要么仅让输入A为1，要么仅让输入B为1，两输入端都为1则输出为0。为了不把或门、与非门和与门都画出来，我们可以使用一个电气工程师所采用的特定电气符号来表示异或门。

<img src="image/image-20241208205650687.png" alt="image-20241208205650687" style="zoom:33%;" />

异或门在输入端比或门多出了一条曲线，除此之外它看上去和或门非常相像，异或门的特征如下表所示。

<img src="image/image-20241208205714457.png" alt="image-20241208205714457" style="zoom:33%;" />

异或门是本书中详细介绍的最后一个逻辑门（第6个门有时会在电气工程中介绍到。它称做同或门，因为只有当两个输入相同的时候，其输出才为1。同或门所给出的输出刚好与异或门相反，因此同或门的符号和异或门相同，但在输出端多了个小圆圈）。

### 半加器

让我们回顾一下到目前为止所了解的内容，将两个二进制数相加将产生一个加法位和一个进位位。

<img src="image/image-20241208205812074.png" alt="image-20241208205812074" style="zoom:33%;" />

可以利用下面这两个逻辑门来实现这些结果。

<img src="image/image-20241208205850718.png" alt="image-20241208205850718" style="zoom:33%;" />

两个二进制数相加的加和是由异或门的输出给出的，而进位位是由与门的输出给出的。因此我们可以将与门和异或门连在一起来计算两个二进制数（即A和B）的和。

<img src="image/image-20241208205912465.png" alt="image-20241208205912465" style="zoom:33%;" />

为了避免重复画与门和异或门，你可以采用如下这种简单的表示方式。

<img src="image/image-20241208210010533.png" alt="image-20241208210010533" style="zoom:33%;" />

这个符号被称为半加器(Half Adder)。之所以叫半加器是有原因的，它将两个二进制数相加，得出一个加法位和一个进位位。半加器没有做到的是将之前一次的加法可能产生的进位位纳入下一次运算。例如，假设我们要将如下两个二进制数相加。

<img src="image/image-20241208210511927.png" alt="image-20241208210511927" style="zoom:33%;" />

我们只能将半加器用于最右面一列的相加：1加1等于0，进位1。对于从右面算起的第二列，由于进位位的存在，实际上需要将三个二进制数相加，而随后每一列的加法都是这样的，随后的每一列二进制数相加都需要将进位位算进来。

### 全加器

为了对三个二进制数进行加法运算，我们需要将两个半加器和一个或门做如下连接。

<img src="image/image-20241208210652521.png" alt="image-20241208210652521" style="zoom:33%;" />

至于原理我这里直接跳过。。。

我们用以下形式来替代上图中的一堆符号，它称为全加器(Full Adder)。

<img src="image/image-20241208211158376.png" alt="image-20241208211158376" style="zoom:33%;" />

以下表格总结了全加法器所有可能的输入组合以及对应的输出结果。

<img src="image/image-20241208211459929.png" alt="image-20241208211459929" style="zoom:33%;" />

我们的8位二进制加法器需要144个继电器。下面就来解释一下这个数目是如何得到的。每个与门、或门和与非门都需要两个继电器，因此一个异或门中就包含6个继电器。一个半加器是由一个异或门和一个与门组成的，因此一个半加器就需要8个继电器。每个全加器由两个半加器和一个或门组成，所以它要18个继电器。我们需要8个全加器来制作8位二进制加法器。因而总共需要144个继电器。

## 控制面板

再来看看之前提到的由灯泡和开关所组成的控制面板。现在我们可以开始将开关和灯泡连接到全加器了。

<img src="image/image-20241208211644941.png" alt="image-20241208211644941" style="zoom:33%;" />

首先将最右端的两个开关和最右端的一个灯泡连接到一个全加器上。

<img src="image/image-20241208211707561.png" alt="image-20241208211707561" style="zoom: 25%;" />

当把两个二进制数相加时，第1列的处理方式与其他列有所不同。因为后面的几列可能包括来自前面加法的进位，而第1列不会，所以全加器的进位输入端是接地的，这表示第1列的进位输入是一个0。第1列二进制数相加后很可能会产生一个进位输出，这个进位输出是下一列加法的输入。

对于接下来的两个二进制位和灯泡，可以按如下办法来连接全加器。

<img src="image/image-20241208211849224.png" alt="image-20241208211849224" style="zoom:25%;" />

第一个全加器的进位输出就是第二个全加器的进位输入，随后的每列二进制数都以同样的方式连接，每一列进位输出都是下一列的进位输入。

最终，第8个灯泡和最后一对开关将以如下方式连接到全加法器上。

<img src="image/image-20241208211913990.png" alt="image-20241208211913990" style="zoom:25%;" />

这里，最后一个进位输出将被连接到第9个灯泡上。至此，我们就大功告成了。

### 8位加法器

还可以用另一种方式来看这8个全加器的连接，每个全加器的进位输出都作为下一个全加器的进位输入。

<img src="image/image-20241208212036763.png" alt="image-20241208212036763" style="zoom:33%;" />

下面是画成一个盒子的完整的8位二进制加法器，输入标记为A0～A7和B0～B7，输出标记为S0～S7。

<img src="image/image-20241208212104955.png" alt="image-20241208212104955" style="zoom:33%;" />

这就是表示多位数字中各位数字的常用方法。A0、B0和S0是最低有效位，或者说是最右边的一位。A7、B7和S7是最高有效位，或者说是最左边的一位。

另一种8位二进制加法器可用下图表示。

<img src="image/image-20241208212631308.png" alt="image-20241208212631308" style="zoom:33%;" />

双线箭头包含了8个输入端，代表一组8个独立的信号，它们被标识为A7…A0、B7…B0。

### 16位加法器

一旦你搭建起了8位二进制加法器，你就可以再搭建另外一个加法器，把它们级联起来就可以很容易地扩展出一个16位加法器。

<img src="image/image-20241208212904704.png" alt="image-20241208212904704" style="zoom:33%;" />

右边加法器的进位输出被连接到了左边加法器的进位输入上，左边加法器的输入包含了两个加数的高8位，而得到的结果也是最终加和的高8位。

## 总结

你可能会问：“这真的就是计算机进行加法运算时所采用的方式么？”

基本上来说，是的，但也并不完全是。

首先，可以制作一个比这个算得更快的加法器。如果你看一下这个电路是如何工作的，最低有效位的一对数字相加所得出的一个进位输出，将要参与接下来的一对数字的加法运算，由此得到的一个进位输出又要参与再下一对数字的加法运算，依此类推。**加法器的总体速度等于数字的位数乘以全加器器件的速度，这被称做行波进位（ripple carry，或脉冲进位），更快的加法器运用了一个被称为“前置进位”的电路来提高运算的速度。**

**其次，也是最重要的，计算机已经不再使用继电器了！尽管它曾经被使用过。第一台数字计算机在20世纪30年代被建造完成，当时所使用的就是继电器，后来也使用过真空管，今天的计算机使用的是晶体管。**在被用到计算机中时，晶体管的工作方式与继电器基本相同，但是正如我们即将了解到的，晶体管要比继电器计算速度更快、体积更小，而且噪声更弱、耗能也更低，而且更便宜。搭建一个8位加法器依然需要144个晶体管（如果你用前置进位法代替行波进位，将会用到更多的晶体管），但是电路却是极小的。

# 13. 如何实现减法

当你确信继电器连接到一起真的可以实现二进制数加法的时候，你可能会问：“那么如何实现减法呢？”本章后续的内容会帮你解答这个问题，因此提出这样的问题并不是说你在没事找事，而实际上这表明你是相当有察觉力的。加法和减法在某些方面相互补充，但在机制方面这两个运算则是不同的。加法是始终从两个加数的最右列向最左列进行计算的，每一列的进位加到下一列中。在减法中没有进位，而是有借位——一种与加法存在本质区别的麻烦机制。

例如，我们来看一个典型的借位减法的题目：

<img src="image/image-20241208213727919.png" alt="image-20241208213727919" style="zoom: 33%;" />

要解决这个问题，首先从最右列着手。我们看到，6是大于3的，因此从5上借1，再用13减去6，得到结果为7。由于我们已经在5上借了1，因此，现在实际上那一位是4，而4是小于7的，因此继续从2上借1, 14减7结果为7。而由于在2上借了1，实际上这一位是1，从中减去1，结果为0。因此，最后的结果应为77：

<img src="image/image-20241208213946823.png" alt="image-20241208213946823" style="zoom:33%;" />

如何才能通过一连串逻辑门来实现这个逻辑呢？

## 避免借位

然而，我们并不打算这样做，相反，我们打算用一个小技巧来让减法不涉及借位。此外，由于减法与二进制编码的存储有关，详细地了解减法也是很重要的。

为了便于表达，将进行减法的两个数分别用被减数(minuend)和减数(subtrahend)表示。从被减数中减去减数，得到的结果叫做差(difference)。

<img src="image/image-20241208214023738.png" alt="image-20241208214023738" style="zoom:33%;" />

为了避免借位，首先要从999中减去减数，而不是从原来的被减数中减去减数。

<img src="image/image-20241208214042633.png" alt="image-20241208214042633" style="zoom:33%;" />

由于操作数是三位数，所以这里使用999，如果操作数是4位，则用9999。**从一串9中减去一个数叫做对9求补数。**176对9的补数是823，反之亦然：823对9的补数是176。这样的好处就是无论减数是多少，计算对9的补数都不需要借位。

计算出减数对9的补数后，将补数与原来的被减数相加：

<img src="image/image-20241208214105654.png" alt="image-20241208214105654" style="zoom:33%;" />

最后再将结果加1，并减去1000。

<img src="image/image-20241208214123180.png" alt="image-20241208214123180" style="zoom:33%;" />

到此，我们就得到了结果，答案与先前的相同，而且没有用到借位。为什么这种方法行得通呢？

- 原题目是这样的：253-176 在这个式子中加上一个数再减去这个数，结果是相同的。

- 因此先加上1000，再减去1000：253-176+1000-1000 这个式子与下式等价：253-176+999+1-1000

- 然后用以下方式将数字重新组合：253+(999-176)+1-1000


这个逻辑与刚才描述过的用9的补数进行的计算是相同的。我们用两个减法和两个加法来替代一个减法，而在这个过程中避免了烦琐的借位。如果减数大于被减数会怎么样呢？例如以下问题：

<img src="image/image-20241208214144149.png" alt="image-20241208214144149" style="zoom:33%;" />

## 结果为负数的减法

通常遇到这个问题时你可能会说：“这里减数大于被减数，因此要将减数和被减数交换来执行减法，然后给结果取个相反数。” 

如果希望求解这个问题而不使用借位的话，就要采用与之前稍微不同的方法。首先要像前面一样，用999减去减数253，计算出对9的补数：

<img src="image/image-20241208214220401.png" alt="image-20241208214220401" style="zoom:33%;" />

把该数对9的补数与被减数相加：

<img src="image/image-20241208214241799.png" alt="image-20241208214241799" style="zoom:33%;" />

在前面的例子中，下一步应该加1，并减去1000来得到最终结果。但是在这里，这种方法并不适用，因为你会遇到923减去1000的情况，这又导致了借位。

由于我们之前已经加了999，这里再减去999：

<img src="image/image-20241208214301674.png" alt="image-20241208214301674" style="zoom:33%;" />

到这里，我们会意识到这个问题的结果是负数，因此需要将减数与被减数交换，用999减去922。这里没有用到借位，结果与我们期望的相同：

<img src="image/image-20241208214323523.png" alt="image-20241208214323523" style="zoom:33%;" />

（注释：这里说白了就是两种情况：当被减数 > 减数时，要求减数对10的补数，也就是对9的补数加一，这样才能避免借位；而对被减数 < 减数时，只需要求减数对9的补数就行了，可以完全避免借位）

## 二进制减法

同样的技巧可以用于二进制数中，而且实际上这要比十进制数简单。让我们一起来看看该如何操作。原来的减法题目是：

<img src="image/image-20241208214343201.png" alt="image-20241208214343201" style="zoom:33%;" />

将这些数字转化为二进制数，问题变为：

<img src="image/image-20241208214400278.png" alt="image-20241208214400278" style="zoom:33%;" />

第一步，用11111111（即255）减去减数：

<img src="image/image-20241208214417783.png" alt="image-20241208214417783" style="zoom:33%;" />

当计算十进制数减法的时候，减数是从一串9中减去的，结果称为9的补数。在二进制数减法中，减数是从一串1中减去的，结果称为1的补数。**但是请注意，我们在求对1的补数时并不需要用到减法。在求对1的补数时，只需将原来的二进制数中的1变为0，将0变为1即可。因此对1求补数有时也会称为相反数(negation)或反码(inverse)。**

第二步，将减数对1的补数与被减数相加：

<img src="image/image-20241208214535081.png" alt="image-20241208214535081" style="zoom:33%;" />

第三步，将上式所得结果加1：

<img src="image/image-20241208214551929.png" alt="image-20241208214551929" style="zoom:33%;" />

第四步，减去100000000（即256）：

<img src="image/image-20241208221823905.png" alt="image-20241208221823905" style="zoom:33%;" />

结果就等于十进制数的77。

我们把这两个数颠倒位置后再做一遍。在十进制中，减法题目对应于：

<img src="image/image-20241208221847120.png" alt="image-20241208221847120" style="zoom:33%;" />

而用二进制表示为：

<img src="image/image-20241208221903456.png" alt="image-20241208221903456" style="zoom:33%;" />

第一步，用11111111减去减数，得到对1的补数：

<img src="image/image-20241208221927851.png" alt="image-20241208221927851" style="zoom:33%;" />

第二步，将减数对1的补数与被减数相加：

<img src="image/image-20241208221946866.png" alt="image-20241208221946866" style="zoom:33%;" />

现在我们要用某种方法在结果中减去11111111。当减数小于被减数的时候，我们将结果加1再减100000000来完成计算。但是现在你无法在不借位的情况下做到这一点，所以，我们直接用11111111减去所得结果即可：

<img src="image/image-20241208222004032.png" alt="image-20241208222004032" style="zoom:33%;" />

但是这个结果是77，而真正的答案应该是-77。

## 加法器中增加减法

到这里，我们已经有了足够的条件来改造上一章所搭建的加法器，并让它像实现加法一样来实现减法运算。为了不让问题太复杂，这个新的加/减法器只执行在减数小于被减数的减法操作，即结果为正数的操作。

该加法器的核心是由逻辑门集成的8位全加器。

<img src="image/image-20241208222034457.png" alt="image-20241208222034457" style="zoom:33%;" />

你可能还记得，输入A0～A7及B0～B7与两排分别表示两个要相加的8位二进制数的开关相连，进位输入接地。S0～S7与表示结果的8个灯泡相连。由于这个加法有可能得到9位数值，进位输出端也连接了一个灯泡。

控制面板示意如下图所示。

<img src="image/image-20241208222054289.png" alt="image-20241208222054289" style="zoom:33%;" />

在上图中，开关所表示的是183（即10110111）与22（即00010110）相加，结果如灯泡所示为205（即11001101）。

8位加/减法器所用的新面板较从前做了些许的改动，它增设了一个开关，用以选择做加法还是做减法。

<img src="image/image-20241208222117900.png" alt="image-20241208222117900" style="zoom:33%;" />

如上图所示，这个开关向下断开时表示选择加法运算，反之向上接通则表示选择减法运算。此外，右侧的8个灯泡用于表示计算结果，这里，第9个灯泡表示“上溢/下溢”。这个灯泡表明了正在计算的数字是一个不能用8个灯泡来表示的数字。如果在加法中得到了大于255（上溢，overflow）或在减法中得到了负数（下溢，underflow）这个灯泡就会发光，当减数大于被减数的时候，就会得到一个负数。

### 求补器

加法器中新增的主要部分就是一个用来求8位二进制数对1补数的电路。之前提到，二进制数对1求补数相当于对其每位取反，因此我们计算8位二进制数补数的时候可以简单地应用8个反向器。

<img src="image/image-20241208222143645.png" alt="image-20241208222143645" style="zoom:33%;" />

问题是，该电路只会对输入求反，而我们要的是一台既能做加法又能做减法的机器，因此就要求该电路当且仅当进行减法运算时才实现反转，电路可以改造为如下图所示。

<img src="image/image-20241208222204338.png" alt="image-20241208222204338" style="zoom:33%;" />

标记为“取反”的信号将被输入到每一个异或门中，回想一下异或门的工作方式，如下表所示。

<img src="image/image-20241208222224495.png" alt="image-20241208222224495" style="zoom:33%;" />

因此，如果“取反”信号是0，则8个异或门输出与输入相同。例如，如果输入是01100001，那么输出也为01100001。如果“取反”信号为1，则输出信号反置。例如，如果输入为01100001，输出则为10011110。

将8个异或门合并起来画成一个器件，称为求补器(One's Complement)，如下所示。

<img src="image/image-20241208222248685.png" alt="image-20241208222248685" style="zoom:33%;" />

### 加 / 减法器

将一个求补器，一个8位二进制加法器和一个异或门做如下连接。

<img src="image/image-20241208222317731.png" alt="image-20241208222317731" style="zoom: 50%;" />

注意，这里三个信号都标识为“SUB”，这就是加/减法转换开关。当该信号为0的时候，其进行的是加法运算，为1时进行的则是减法运算。在减法中，输入B（第二排开关）在送入加法器之前，需先通过求补电路进行取反。此外，在做减法时，我们通过设定CI（进位输入）为1来使得结果加1，而在加法中，求补电路将不起作用，且输入CI为0。

加法器的SUB信号和CO（进位输出）输出作为异或门的输入来控制表示上溢/下溢的灯泡。如果SUB信号为0（表示进行加法运算），则当加法器CO输出为1时灯亮，意思是加法计算结果大于255。

**当进行减法运算的时候，如果减数（输入B）小于被减数（输入A），这时加法器的CO输出为1，这表示减法的最后一步要减去1 0000 0000。**当减数 > 被减数，加法器的CO输出为0，SUB为1，下溢（减法得到了负数），计算无效，上面所示器件现在还不能表示负数。

## 负数的表示

现在，二进制数可以有两种不同的使用方法。二进制数可以是有符号的，也可以是无符号的。无符号的8位二进制数所表示的范围是0～255，有符号的8位二进制表示的范围是-128～127。如果有一个人问：“有一个8位二进制数，值为10110110。它相当于十进制的多少？”你必须先问：“它是有符号数还是无符号数？它可能为-74或者182。”

这就是二进制数的麻烦之处，它们只是一些0和1，本身并没有任何含义。
