# Pod åŸºç¡€åŸç†

å‰é¢å·²ç»æ­å»ºäº† Kubernetes é›†ç¾¤ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥æ­£å¼å¼€å§‹å­¦ä¹  Kubernetes çš„ä½¿ç”¨ï¼Œåœ¨è¿™ä¹‹å‰è¿˜éœ€è¦å…ˆäº†è§£ä¸‹ YAML æ–‡ä»¶ã€‚è¦åœ¨ K8s é›†ç¾¤é‡Œé¢è¿è¡Œè‡ªå·±çš„åº”ç”¨ï¼Œé¦–å…ˆéœ€è¦çŸ¥é“å‡ ä¸ªæ¦‚å¿µã€‚

ç¬¬ä¸€ä¸ªå½“ç„¶å°±æ˜¯åº”ç”¨çš„é•œåƒï¼Œå› ä¸ºåœ¨é›†ç¾¤ä¸­è¿è¡Œçš„æ˜¯å®¹å™¨ï¼Œæ‰€ä»¥é¦–å…ˆéœ€è¦å°†åº”ç”¨æ‰“åŒ…æˆé•œåƒã€‚é•œåƒã€Kubernetes é›†ç¾¤éƒ½å‡†å¤‡å¥½ä¹‹åï¼Œå…¶å®å°±å¯ä»¥æŠŠåº”ç”¨éƒ¨ç½²åˆ°é›†ç¾¤ä¸­äº†ã€‚ä½†æ˜¯é•œåƒåˆ°é›†ç¾¤ä¸­è¿è¡Œè¿™ä¸ªè¿‡ç¨‹å¦‚ä½•å®Œæˆå‘¢ï¼Ÿå¿…ç„¶æœ‰ä¸€ä¸ªåœ°æ–¹å¯ä»¥æ¥æè¿°åº”ç”¨ï¼Œç„¶åæŠŠè¿™ä»½æè¿°å‘Šè¯‰é›†ç¾¤ï¼Œæœ€åé›†ç¾¤æŒ‰ç…§è¿™ä¸ªæè¿°æ¥éƒ¨ç½²åº”ç”¨ã€‚

åœ¨ Docker ç¯å¢ƒä¸‹é¢æ˜¯ç›´æ¥é€šè¿‡å‘½ä»¤ `docker run` æ¥è¿è¡Œåº”ç”¨ï¼Œåœ¨ Kubernetes ç¯å¢ƒä¸‹åŒæ ·ä¹Ÿå¯ä»¥ç”¨ç±»ä¼¼ `kubectl run` è¿™æ ·çš„å‘½ä»¤æ¥è¿è¡Œåº”ç”¨ï¼Œä½†åœ¨ Kubernetes ä¸­å´æ˜¯ä¸æ¨èä½¿ç”¨å‘½ä»¤è¡Œçš„æ–¹å¼ï¼Œè€Œæ˜¯å¸Œæœ›ä½¿ç”¨ç§°ä¸ºèµ„æºæ¸…å•çš„ä¸œè¥¿æ¥æè¿°åº”ç”¨ï¼Œèµ„æºæ¸…å•å¯ä»¥ç”¨ YAML æˆ–è€… JSON æ–‡ä»¶æ¥ç¼–å†™ï¼Œä¸€èˆ¬æ¥è¯´ YAML æ–‡ä»¶æ›´æ–¹ä¾¿é˜…è¯»å’Œç†è§£ï¼Œæ‰€ä»¥è¯¾ç¨‹ä¸­éƒ½ä¼šä½¿ç”¨ YAML æ–‡ä»¶æ¥è¿›è¡Œæè¿°ã€‚

é€šè¿‡ä¸€ä¸ªèµ„æºæ¸…å•æ–‡ä»¶æ¥å®šä¹‰å¥½ä¸€ä¸ªåº”ç”¨åï¼Œå°±å¯ä»¥é€šè¿‡ kubectl å·¥å…·æ¥ç›´æ¥è¿è¡Œå®ƒï¼š

```shell
kubectl create -f xxxx.yaml
# æˆ–è€…
kubectl apply -f xxxx.yaml
```

æˆ‘ä»¬çŸ¥é“ kubectl æ˜¯ç›´æ¥æ“ä½œ APIServer çš„ï¼Œæ‰€ä»¥å°±ç›¸å½“äºæŠŠæ¸…å•æäº¤ç»™äº† APIServerï¼Œç„¶åé›†ç¾¤è·å–åˆ°æ¸…å•æè¿°çš„åº”ç”¨ä¿¡æ¯åå­˜å…¥åˆ° etcd æ•°æ®åº“ä¸­ï¼Œç„¶å kube-scheduler ç»„ä»¶å‘ç°è¿™ä¸ªæ—¶å€™æœ‰ä¸€ä¸ª Pod è¿˜æ²¡æœ‰ç»‘å®šåˆ°èŠ‚ç‚¹ä¸Šï¼Œå°±ä¼šå¯¹è¿™ä¸ª Pod è¿›è¡Œä¸€ç³»åˆ—çš„è°ƒåº¦ï¼ŒæŠŠå®ƒè°ƒåº¦åˆ°ä¸€ä¸ªæœ€åˆé€‚çš„èŠ‚ç‚¹ä¸Šï¼Œç„¶åæŠŠè¿™ä¸ªèŠ‚ç‚¹å’Œ Pod ç»‘å®šåˆ°ä¸€èµ·ï¼ˆå†™å›åˆ°etcdï¼‰ï¼Œç„¶åèŠ‚ç‚¹ä¸Šçš„ kubelet ç»„ä»¶è¿™ä¸ªæ—¶å€™ watch åˆ°æœ‰ä¸€ä¸ª Pod è¢«åˆ†é…è¿‡æ¥äº†ï¼Œå°±å»æŠŠè¿™ä¸ª Pod çš„ä¿¡æ¯æ‹‰å–ä¸‹æ¥ï¼Œç„¶åæ ¹æ®æè¿°é€šè¿‡å®¹å™¨è¿è¡Œæ—¶æŠŠå®¹å™¨åˆ›å»ºå‡ºæ¥ï¼Œæœ€åå½“ç„¶åŒæ ·æŠŠ Pod çŠ¶æ€å†å†™å›åˆ° etcd ä¸­å»ï¼Œè¿™æ ·å°±å®Œæˆäº†æ•´ä¸ªçš„åˆ›å»ºæµç¨‹ã€‚

## ç¬¬ä¸€ä¸ªå®¹å™¨åŒ–åº”ç”¨

ç°åœ¨é€šè¿‡ YAML æ–‡ä»¶ç¼–å†™äº†ä¸€ä¸ªå¦‚ä¸‹çš„èµ„æºæ¸…å•ï¼Œå‘½åä¸º `nginx-deployment.yaml`ï¼š

```yaml
apiVersion: apps/v1  # APIç‰ˆæœ¬
kind: Deployment  # APIå¯¹è±¡ç±»å‹
metadata:
  name: nginx-deploy
  labels:
    chapter: first-app
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 2  # Pod å‰¯æœ¬æ•°é‡
  template:  # Pod æ¨¡æ¿
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.7.9
        ports:
        - containerPort: 80
```

ç„¶åç›´æ¥ç”¨ kubectl å‘½ä»¤æ¥åˆ›å»ºè¿™ä¸ªåº”ç”¨ï¼š

```shell
[root@localhost ~]# kubectl create -f nginx-deployment.yaml
deployment.apps/nginx-deploy created
[root@localhost ~]# kubectl get pod -owide
NAME                            READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
nginx-deploy-7759cfdc55-8qblg   1/1     Running   0          52s   10.244.2.2   demo-worker  
```

å¯ä»¥çœ‹åˆ°åœ¨é›†ç¾¤ä¸­ç”Ÿæˆä¸¤ä¸ª Pod å‡ºæ¥ï¼Œè€Œæ•´ä¸ªèµ„æºæ¸…å•æ–‡ä»¶å¯¹åº”åˆ° Kubernetes ä¸­å°±æ˜¯ä¸€ä¸ª API Objectï¼ˆAPI å¯¹è±¡ï¼‰ï¼ŒæŒ‰ç…§è¿™äº›å¯¹è±¡çš„è¦æ±‚å¡«å……ä¸Šå¯¹åº”çš„å±æ€§åï¼Œæäº¤ç»™ Kubernetes é›†ç¾¤ï¼Œå°±å¯ä»¥åˆ›å»ºå‡ºå¯¹åº”çš„èµ„æºå¯¹è±¡ã€‚æ¯”å¦‚è¿™é‡Œå®šä¹‰çš„æ˜¯ä¸€ä¸ª Deployment ç±»å‹çš„ API å¯¹è±¡ï¼ŒæŒ‰ç…§è¿™ä¸ª API å¯¹è±¡çš„è¦æ±‚å¡«å……äº†ä¸€äº›å±æ€§ï¼Œå°±ä¼šåˆ›å»ºå‡ºå¯¹åº”çš„èµ„æºå¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥è·å–ï¼š

```shell
[root@localhost ~]# kubectl get deployment
NAME           READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deploy   2/2     2            2           100s
```

Deployment è¿™ä¸ªèµ„æºå¯¹è±¡å°±æ˜¯ç”¨æ¥å®šä¹‰å¤šå‰¯æœ¬åº”ç”¨çš„å¯¹è±¡ï¼Œè€Œä¸”è¿˜æ”¯æŒæ»šåŠ¨æ›´æ–°ï¼Œä¸Šé¢çš„èµ„æºæ¸…å•ä¸­çš„æè¿°ä¸­æœ‰ä¸€ä¸ªå±æ€§ `replicas: 2`ï¼Œæ‰€ä»¥æœ€åç”Ÿæˆä¸¤ä¸ªå‰¯æœ¬çš„ Podã€‚

è€Œè¿™ä¸ª Deployment å®šä¹‰çš„å‰¯æœ¬ Pod å…·ä½“æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œæ˜¯é€šè¿‡ä¸‹é¢çš„ Pod æ¨¡æ¿æ¥å®šä¹‰çš„ï¼Œå°±æ˜¯ `template` ä¸‹é¢çš„å®šä¹‰ï¼Œè¿™ä¸ªæ¨¡æ¿ä¸­å®šä¹‰çš„ Pod ä¸­åªæœ‰ä¸€ä¸ªåä¸º `nginx` çš„å®¹å™¨ï¼Œå®¹å™¨ä½¿ç”¨çš„é•œåƒæ˜¯ `nginx:1.7.9`ï¼ˆ`spec.containers[0].image`ï¼‰ï¼Œå¹¶ä¸”è¿™ä¸ªå®¹å™¨ç›‘å¬çš„ç«¯å£æ˜¯ 80ï¼ˆ`spec.containers[0].ports[0].containerPort`ï¼‰ï¼Œå¦å¤–è¿˜ä¸º Pod æ·»åŠ äº†ä¸€ä¸ª `app: nginx` è¿™æ ·çš„ Label æ ‡ç­¾ï¼Œè¿™é‡Œéœ€è¦éå¸¸æ³¨æ„çš„æ˜¯ä¸Šé¢çš„ `selector.matchLabels` åŒºåŸŸå°±æ˜¯æ¥è¡¨ç¤º Deployment æ¥ç®¡ç†å“ªäº› Pod çš„ï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹éœ€è¦å’Œ Pod æ¨¡æ¿ä¸­çš„ Label æ ‡ç­¾ä¿æŒä¸€è‡´ï¼Œè¿™ä¸ª Label æ ‡ç­¾æ˜¯éå¸¸é‡è¦çš„ã€‚

å¦å¤–ä¹Ÿå¯ä»¥å‘ç°æ¯ä¸ª API å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª Metadata çš„å­—æ®µï¼Œç”¨æ¥è¡¨ç¤ºè¯¥å¯¹è±¡çš„å…ƒæ•°æ®ï¼Œæ¯”å¦‚å®šä¹‰ nameã€namespace ç­‰ï¼Œæ¯”å¦‚ä¸Šé¢ Deployment å’Œ Pod æ¨¡æ¿ä¸­éƒ½æœ‰è¿™ä¸ªå­—æ®µï¼Œè‡³äºä¸ºä»€ä¹ˆ Pod æ¨¡æ¿ä¸­æ²¡æœ‰ name è¿™ä¸ªå…ƒä¿¡æ¯å‘¢ï¼Œè¿™æ˜¯å› ä¸º Deployment è¿™ä¸ªæ§åˆ¶å™¨ä¼šè‡ªåŠ¨åœ¨å®ƒè‡ªå·±çš„ name åŸºç¡€ä¸Šç”Ÿæˆ Pod åï¼Œä¸è¿‡ Deployment ä¸‹é¢å®šä¹‰çš„ Label æ ‡ç­¾å°±æ²¡æœ‰ Pod ä¸­å®šä¹‰çš„ Label æ ‡ç­¾é‚£ä¹ˆé‡è¦äº†ï¼Œåªæ˜¯èµ·åˆ°ä¸€ä¸ªå¯¹è¯¥å¯¹è±¡æ ‡è¯†å’Œè¿‡æ»¤çš„ä½œç”¨ï¼Œæ¯”å¦‚åœ¨æŸ¥è¯¢å¯¹è±¡çš„æ—¶å€™å¯ä»¥å¸¦ä¸Šæ ‡ç­¾æ¥è¿›è¡Œè¿‡æ»¤ï¼š

```shell
[root@localhost ~]# kubectl get deployment -l chapter=first-app
NAME           READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deploy   2/2     2            2           12m
[root@localhost ~]# kubectl get pods -l app=nginx
NAME                            READY   STATUS    RESTARTS   AGE
nginx-deploy-7759cfdc55-8qblg   1/1     Running   0          12m
nginx-deploy-7759cfdc55-rjm5j   1/1     Running   0          12m
[root@localhost ~]#
```

åˆ°è¿™é‡Œå°±å®Œæˆäº†ç¬¬ä¸€ä¸ªåº”ç”¨çš„å®¹å™¨åŒ–éƒ¨ç½²ï¼Œä½†æ˜¯å¾€å¾€åœ¨éƒ¨ç½²åº”ç”¨çš„è¿‡ç¨‹ä¸­æˆ–å¤šæˆ–å°‘ä¼šé‡åˆ°ä¸€äº›é—®é¢˜ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨ä¸€ä¸ª `kubectl describe` å‘½ä»¤æ¥æŸ¥çœ‹èµ„æºå¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ¯”å¦‚ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥æŸ¥çœ‹ Pod çš„è¯¦ç»†ä¿¡æ¯ï¼š

```shell
[root@localhost ~]# kubectl describe pod nginx-deploy-7759cfdc55-8qblg
Name:             nginx-deploy-7759cfdc55-8qblg
Namespace:        default
Priority:         0
Service Account:  default
Node:             demo-worker/172.19.0.4
Start Time:       Tue, 20 Feb 2024 02:47:51 -0500
Labels:           app=nginx
                  pod-template-hash=7759cfdc55
Annotations:      <none>
Status:           Running
IP:               10.244.2.2
IPs:
  IP:           10.244.2.2
Controlled By:  ReplicaSet/nginx-deploy-7759cfdc55
Containers:
  nginx:
    Container ID:   containerd://d75942dff7edd4f970bacef16b622101acc395e178f67b666c296144ae3a5227
    Image:          nginx:1.7.9
    Image ID:       sha256:35d28df486f6150fa3174367499d1eb01f22f5a410afe4b9581ac0e0e58b3eaf
    Port:           80/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Tue, 20 Feb 2024 02:48:27 -0500
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-kxbb2 (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-kxbb2:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  13m   default-scheduler  Successfully assigned default/nginx-deploy-7759cfdc55-8qblg to demo-worker
  Normal  Pulling    13m   kubelet            Pulling image "nginx:1.7.9"
  Normal  Pulled     13m   kubelet            Successfully pulled image "nginx:1.7.9" in 35.526955018s
  Normal  Created    13m   kubelet            Created container nginx
  Normal  Started    13m   kubelet            Started container nginx
[root@localhost ~]#
```

å¯ä»¥çœ‹åˆ°å¾ˆå¤šè¿™ä¸ª Pod çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ¯”å¦‚è°ƒåº¦åˆ°çš„èŠ‚ç‚¹ã€çŠ¶æ€ã€IP ç­‰ï¼Œä¸€èˆ¬æˆ‘ä»¬æ¯”è¾ƒå…³å¿ƒçš„æ˜¯ä¸‹é¢çš„ Events éƒ¨åˆ†ï¼Œå°±æ˜¯äº‹ä»¶ã€‚

åœ¨ Kubernetes åˆ›å»ºèµ„æºå¯¹è±¡çš„è¿‡ç¨‹ä¸­ï¼Œå¯¹è¯¥å¯¹è±¡çš„ä¸€äº›é‡è¦æ“ä½œï¼Œéƒ½ä¼šè¢«è®°å½•åœ¨è¿™ä¸ªå¯¹è±¡çš„ Events é‡Œé¢ï¼Œå¯ä»¥é€šè¿‡ `kubectl describe` æŒ‡ä»¤æŸ¥çœ‹å¯¹åº”çš„ç»“æœï¼Œæ‰€ä»¥è¿™ä¸ªæŒ‡ä»¤ä¹Ÿä¼šæ˜¯ä»¥åæ’é”™è¿‡ç¨‹ä¸­ç»å¸¸ä½¿ç”¨çš„å‘½ä»¤ï¼Œä¸€å®šè¦è®°ä½è¿™ä¸ªé‡è¦çš„å‘½ä»¤ã€‚æ¯”å¦‚ä¸Šé¢æè¿°çš„è¿™ä¸ª Podï¼Œå¯ä»¥çœ‹åˆ°å®ƒè¢«åˆ›å»ºä¹‹åï¼Œè¢«è°ƒåº¦å™¨è°ƒåº¦ï¼ˆSuccessfully assignedï¼‰åˆ°äº† `demo-work` èŠ‚ç‚¹ä¸Šï¼Œç„¶åå†å»æ‹‰å–é•œåƒï¼Œç„¶ååˆ›å»ºå®šä¹‰çš„ nginx å®¹å™¨ï¼Œæœ€åå¯åŠ¨å®šä¹‰çš„å®¹å™¨ã€‚

å¦å¤–ä¸€ä¸ªæ–¹é¢å¦‚æœæƒ³å¯¹åº”ç”¨è¿›è¡Œå‡çº§çš„è¯åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™ä¸ªæ“ä½œåœ¨æ—¥å¸¸å·¥ä½œä¸­è¿˜æ˜¯éå¸¸å¸¸è§çš„ï¼Œè€Œåœ¨ Kubernetes è¿™é‡Œä¹Ÿæ˜¯éå¸¸ç®€å•çš„ï¼Œåªéœ€è¦ä¿®æ”¹èµ„æºæ¸…å•æ–‡ä»¶å³å¯ï¼Œæ¯”å¦‚æŠŠé•œåƒå‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ `nginx:latest`ï¼š

```yaml
    spec:
      containers:
        - name: nginx
          image: nginx:latest # è¿™é‡Œè¢«ä» 1.7.9 ä¿®æ”¹ä¸ºlatest
          ports:
            - containerPort: 80
```

ç„¶åå¯ä»¥é€šè¿‡ `kubectl apply`å‘½ä»¤æ¥ç›´æ¥æ›´æ–°ï¼Œè¿™ä¸ªå‘½ä»¤ä¹Ÿæ˜¯æ¨èä½¿ç”¨çš„ï¼Œæˆ‘ä»¬ä¸å¿…å…³å¿ƒå½“å‰çš„æ“ä½œæ˜¯åˆ›å»ºï¼Œè¿˜æ˜¯æ›´æ–°ï¼Œæ‰§è¡Œçš„å‘½ä»¤å§‹ç»ˆæ˜¯ `kubectl apply`ï¼ŒKubernetes åˆ™ä¼šæ ¹æ® YAML æ–‡ä»¶çš„å†…å®¹å˜åŒ–ï¼Œè‡ªåŠ¨è¿›è¡Œå…·ä½“çš„å¤„ç†ï¼Œæ‰€ä»¥æ— è®ºæ˜¯åˆ›å»ºè¿˜æ˜¯æ›´æ–°éƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ï¼š

```shell
kubectl apply -f nginx-deployment.yaml
```

é€šè¿‡è¿™ä¸ªå‘½ä»¤å°±å¯ä»¥æ¥æ›´æ–°åº”ç”¨äº†ï¼Œç”±äºè¿™é‡Œä½¿ç”¨çš„æ˜¯ä¸€ä¸ª Deployment çš„æ§åˆ¶å™¨ï¼Œæ‰€ä»¥ä¼šæ»šåŠ¨æ›´æ–°åº”ç”¨ï¼Œå¯ä»¥é€šè¿‡åœ¨å‘½ä»¤åé¢åŠ ä¸Š `--watch` å‚æ•°æ¥æŸ¥çœ‹ Pod çš„æ›´æ–°è¿‡ç¨‹ï¼š

```shell
[root@localhost ~]# kubectl get pods -l app=nginx --watch
NAME                            READY   STATUS              RESTARTS   AGE
nginx-deploy-547d878d89-7whb5   0/1     ContainerCreating   0          11s
nginx-deploy-7759cfdc55-8qblg   1/1     Running             0          22m
nginx-deploy-7759cfdc55-rjm5j   1/1     Running             0          22m
nginx-deploy-547d878d89-7whb5   1/1     Running             0          31s
nginx-deploy-547d878d89-g5ndc   0/1     Pending             0          1s
nginx-deploy-547d878d89-g5ndc   0/1     Pending             0          1s
nginx-deploy-547d878d89-g5ndc   0/1     ContainerCreating   0          1s
nginx-deploy-7759cfdc55-8qblg   1/1     Terminating         0          22m
nginx-deploy-7759cfdc55-8qblg   0/1     Terminating         0          22m
nginx-deploy-7759cfdc55-8qblg   0/1     Terminating         0          22m
nginx-deploy-7759cfdc55-8qblg   0/1     Terminating         0          22m
```

å¯ä»¥çœ‹åˆ°æ›´æ–°è¿‡ç¨‹æ˜¯å…ˆæ€æ‰äº†ä¸€ä¸ª Podï¼Œç„¶ååˆé‡æ–°åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ Podï¼Œç„¶ååˆæ€æ‰ä¸€ä¸ªæ—§çš„ Podï¼Œå†åˆ›å»ºä¸€ä¸ªæ–°çš„ Podï¼Œè¿™æ ·äº¤æ›¿æ›¿æ¢çš„ï¼Œæœ€åå‰©ä¸‹ä¸¤ä¸ªæ–°çš„ Podï¼Œè¿™å°±æ˜¯æ‰€è¯´çš„æ»šåŠ¨æ›´æ–°ã€‚æ»šåŠ¨æ›´æ–°å¯¹äºåº”ç”¨æŒç»­æä¾›æœåŠ¡æ˜¯éå¸¸é‡è¦çš„æ‰‹æ®µï¼Œåœ¨æ—¥å¸¸å·¥ä½œä¸­æ›´æ–°åº”ç”¨è‚¯å®šä¼šé‡‡ç”¨è¿™ç§æ–¹å¼ã€‚

æœ€åï¼Œå¦‚æœéœ€è¦æŠŠåº”ç”¨ä»é›†ç¾¤ä¸­åˆ é™¤æ‰ï¼Œå¯ä»¥ç”¨ `kubectl delete` å‘½ä»¤æ¥æ¸…ç†ï¼š

```shell
[root@localhost ~]# kubectl delete -f nginx-deployment.yaml
deployment.apps "nginx-deploy" deleted
[root@localhost ~]# kubectl get pods -l app=nginx
No resources found in default namespace.
[root@localhost ~]#
```

# YAML æ–‡ä»¶

ä¸Šé¢åœ¨ Kubernetes ä¸­éƒ¨ç½²äº†æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªå®¹å™¨åŒ–åº”ç”¨ï¼Œè¦éƒ¨ç½²åº”ç”¨æœ€é‡è¦çš„å°±æ˜¯ç¼–å†™åº”ç”¨çš„èµ„æºæ¸…å•æ–‡ä»¶ã€‚é‚£ä¹ˆå¦‚ä½•ç¼–å†™èµ„æºæ¸…å•æ–‡ä»¶å‘¢ï¼Ÿæ—¥å¸¸ä½¿ç”¨çš„æ—¶å€™éƒ½æ˜¯ä½¿ç”¨ YAML æ–‡ä»¶æ¥ç¼–å†™ï¼Œä½†æ˜¯ç°çŠ¶å´æ˜¯å¤§éƒ¨åˆ†åŒå­¦å¯¹ JSON æ›´åŠ ç†Ÿæ‚‰ï¼Œå¯¹ YAML æ–‡ä»¶çš„æ ¼å¼ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œæ‰€ä»¥ä¹Ÿå¯¼è‡´å¾ˆå¤šåŒå­¦åœ¨ç¼–å†™èµ„æºæ¸…å•çš„æ—¶å€™ä¼¼æ‡‚éæ‡‚çš„æ„Ÿè§‰ï¼Œæ‰€ä»¥åœ¨äº†è§£å¦‚ä½•ç¼–å†™èµ„æºæ¸…å•ä¹‹å‰éå¸¸æœ‰å¿…è¦æ¥äº†è§£ä¸‹ YAML æ–‡ä»¶çš„ç”¨æ³•ã€‚

YAML æ˜¯ä¸“é—¨ç”¨æ¥å†™é…ç½®æ–‡ä»¶çš„è¯­è¨€ï¼Œéå¸¸ç®€æ´å’Œå¼ºå¤§ï¼Œè¿œæ¯” JSON æ ¼å¼æ–¹ä¾¿ã€‚YAMLè¯­è¨€ï¼ˆå‘éŸ³ /ËˆjÃ¦mÉ™l/ï¼‰çš„è®¾è®¡ç›®æ ‡ï¼Œå°±æ˜¯æ–¹ä¾¿äººç±»è¯»å†™ã€‚å®ƒå®è´¨ä¸Šæ˜¯ä¸€ç§é€šç”¨çš„æ•°æ®ä¸²è¡ŒåŒ–æ ¼å¼ã€‚

**å®ƒçš„åŸºæœ¬è¯­æ³•è§„åˆ™å¦‚ä¸‹**ï¼š

* å¤§å°å†™æ•æ„Ÿ
* ä½¿ç”¨ç¼©è¿›è¡¨ç¤ºå±‚çº§å…³ç³»
* ç¼©è¿›æ—¶ä¸å…è®¸ä½¿ç”¨Tabé”®ï¼Œåªå…è®¸ä½¿ç”¨ç©ºæ ¼
* ç¼©è¿›çš„ç©ºæ ¼æ•°ç›®ä¸é‡è¦ï¼Œåªè¦ç›¸åŒå±‚çº§çš„å…ƒç´ å·¦ä¾§å¯¹é½å³å¯
* `#` è¡¨ç¤ºæ³¨é‡Šï¼Œä»è¿™ä¸ªå­—ç¬¦ä¸€ç›´åˆ°è¡Œå°¾ï¼Œéƒ½ä¼šè¢«è§£æå™¨å¿½ç•¥

åœ¨ Kubernetes ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦äº†è§£ä¸¤ç§ç»“æ„ç±»å‹å°±è¡Œäº†ï¼š

* Listsï¼ˆåˆ—è¡¨ï¼‰
* Mapsï¼ˆå­—å…¸ï¼‰

ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯èƒ½ä¼šé‡åˆ° Lists çš„ Maps å’Œ Maps çš„ Listsï¼Œç­‰ç­‰ã€‚ä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œåªè¦æŒæ¡äº†è¿™ä¸¤ç§ç»“æ„ä¹Ÿå°±å¯ä»¥äº†ï¼Œå…¶ä»–æ›´åŠ å¤æ‚çš„æš‚ä¸è®¨è®ºã€‚

## Maps

é¦–å…ˆæ¥çœ‹çœ‹ Mapsï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ Map æ˜¯å­—å…¸ï¼Œå°±æ˜¯ä¸€ä¸ª `key:value` çš„é”®å€¼å¯¹ï¼ŒMaps å¯ä»¥è®©æˆ‘ä»¬æ›´åŠ æ–¹ä¾¿çš„å»ä¹¦å†™é…ç½®ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š

```yaml
---
apiVersion: v1
kind: Pod
```

ç¬¬ä¸€è¡Œçš„ `---`æ˜¯åˆ†éš”ç¬¦ï¼Œæ˜¯å¯é€‰çš„ï¼Œåœ¨å•ä¸€æ–‡ä»¶ä¸­ï¼Œå¯ç”¨è¿ç»­ä¸‰ä¸ªè¿å­—å· `---`åŒºåˆ†å¤šä¸ªæ–‡ä»¶ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸¤ä¸ªé”®ï¼škind å’Œ apiVersionï¼Œä»–ä»¬å¯¹åº”çš„å€¼åˆ†åˆ«æ˜¯ï¼šv1 å’Œ Podã€‚ä¸Šé¢çš„ YAML æ–‡ä»¶è½¬æ¢æˆ JSON æ ¼å¼çš„è¯ï¼Œä½ è‚¯å®šå°±å®¹æ˜“æ˜ç™½äº†ï¼š

```json
{
    "apiVersion": "v1",
    "kind": "pod"
}
```

å†åˆ›å»ºä¸€ä¸ªç›¸å¯¹å¤æ‚ä¸€ç‚¹çš„ YAML æ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ª KEY å¯¹åº”çš„å€¼ä¸æ˜¯å­—ç¬¦ä¸²è€Œæ˜¯ä¸€ä¸ª Mapsï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: ydzs-site
  labels:
    app: web
```

ä¸Šé¢çš„ YAML æ–‡ä»¶ï¼Œ`metadata` è¿™ä¸ª KEY å¯¹åº”çš„å€¼å°±æ˜¯ä¸€ä¸ª Mapsï¼Œè€Œä¸”åµŒå¥—çš„ labels è¿™ä¸ª KEY çš„å€¼åˆæ˜¯ä¸€ä¸ª Mapï¼Œä½ å¯ä»¥æ ¹æ®ä½ è‡ªå·±çš„æƒ…å†µè¿›è¡Œå¤šå±‚åµŒå¥—ã€‚

ä¸Šé¢ä¹Ÿæåˆ°äº† YAML æ–‡ä»¶çš„è¯­æ³•è§„åˆ™ï¼ŒYAML å¤„ç†å™¨æ˜¯æ ¹æ®è¡Œç¼©è¿›æ¥çŸ¥é“å†…å®¹ä¹‹é—´çš„å…³è”æ€§çš„ã€‚æ¯”å¦‚ä¸Šé¢çš„ YAML æ–‡ä»¶ï¼Œç”¨äº†ä¸¤ä¸ªç©ºæ ¼ä½œä¸ºç¼©è¿›ï¼Œç©ºæ ¼çš„æ•°é‡å¹¶ä¸é‡è¦ï¼Œä½†æ˜¯å¾—ä¿æŒä¸€è‡´ï¼Œå¹¶ä¸”è‡³å°‘è¦æ±‚ä¸€ä¸ªç©ºæ ¼ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ° name å’Œ labels æ˜¯ç›¸åŒçº§åˆ«çš„ç¼©è¿›ï¼Œæ‰€ä»¥ YAML å¤„ç†å™¨å°±çŸ¥é“äº†ä»–ä»¬å±äºåŒä¸€ä¸ª Mapï¼Œè€Œ app æ˜¯ labels çš„å€¼æ˜¯å› ä¸º app çš„ç¼©è¿›æ›´å¤§ã€‚

> æ³¨æ„ï¼šåœ¨ YAML æ–‡ä»¶ä¸­ç»å¯¹ä¸è¦ä½¿ç”¨ tab é”®æ¥è¿›è¡Œç¼©è¿›ã€‚

## Lists

Listså°±æ˜¯åˆ—è¡¨ï¼Œè¯´ç™½äº†å°±æ˜¯æ•°ç»„ï¼Œåœ¨ YAML æ–‡ä»¶ä¸­å¯ä»¥è¿™æ ·å®šä¹‰ï¼š

```yaml
args:
  - Cat
  - Dog
  - Fish

---
env:
- a
- b
- c 
```

ä½ å¯ä»¥æœ‰ä»»ä½•æ•°é‡çš„é¡¹åœ¨åˆ—è¡¨ä¸­ï¼Œæ¯ä¸ªé¡¹çš„å®šä¹‰ä»¥ç ´æŠ˜å·ï¼ˆ-ï¼‰å¼€å¤´çš„ï¼Œä¸çˆ¶å…ƒç´ ä¹‹é—´å¯ä»¥ç¼©è¿›ä¹Ÿå¯ä»¥ä¸ç¼©è¿›ã€‚å¯¹åº”çš„ JSON æ ¼å¼å¦‚ä¸‹ï¼š

```json
{
    "args": [ 'Cat', 'Dog', 'Fish' ]
}
```

å½“ç„¶ï¼ŒLists çš„å­é¡¹ä¹Ÿå¯ä»¥æ˜¯ Mapsï¼ŒMaps çš„å­é¡¹ä¹Ÿå¯ä»¥æ˜¯ Lists å¦‚ä¸‹æ‰€ç¤ºï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: ydzs-site
  labels:
    app: web
spec:
  containers:
    - name: front-end
      image: nginx
      ports:
        - containerPort: 80
    - name: flaskapp-demo
      image: cnych/flaskapp
      ports:
        - containerPort: 5000
```

æ¯”å¦‚è¿™ä¸ª YAML æ–‡ä»¶ï¼Œå®šä¹‰äº†ä¸€ä¸ªå« containers çš„ List å¯¹è±¡ï¼Œæ¯ä¸ªå­é¡¹éƒ½ç”± nameã€imageã€ports ç»„æˆã€‚æ˜¯ä¸æ˜¯è§‰å¾—ç”¨ JSON æ ¼å¼çš„è¯æ–‡ä»¶æ˜æ˜¾æ¯” YAML æ–‡ä»¶æ›´å¤æ‚äº†å‘¢ï¼Ÿ

## å¦‚ä½•ç¼–å†™èµ„æºæ¸…å•

ä¸Šé¢äº†è§£äº† YAML æ–‡ä»¶çš„åŸºæœ¬è¯­æ³•ï¼Œç°åœ¨è‡³å°‘å¯ä»¥ä¿è¯ç¼–å†™çš„ YAML æ–‡ä»¶è¯­æ³•æ˜¯åˆæ³•çš„ï¼Œé‚£è¦æ€ä¹ˆç¼–å†™ç¬¦åˆ Kubernetes API å¯¹è±¡çš„èµ„æºæ¸…å•å‘¢ï¼Ÿæ¯”å¦‚æˆ‘ä»¬æ€ä¹ˆçŸ¥é“ Podã€Deployment è¿™äº›èµ„æºå¯¹è±¡æœ‰å“ªäº›åŠŸèƒ½ã€æœ‰å“ªäº›å­—æ®µå‘¢ï¼Ÿ

ä¸€äº›ç®€å•çš„èµ„æºå¯¹è±¡å¯èƒ½å¯ä»¥å‡­å€Ÿè®°å¿†å†™å‡ºå¯¹åº”çš„èµ„æºæ¸…å•ï¼Œä½†æ˜¯ Kubernetes å‘å±•ä¹Ÿéå¸¸å¿«ï¼Œç‰ˆæœ¬è¿­ä»£ä¹Ÿå¾ˆå¿«ï¼Œæ¯ä¸ªç‰ˆæœ¬ä¸­èµ„æºå¯¹è±¡å¯èƒ½åˆæœ‰å¾ˆå¤šå˜åŒ–ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§åŠæ³•å¯ä»¥è®©æˆ‘ä»¬åšåˆ°æœ‰çš„æ”¾çŸ¢å‘¢ï¼Ÿ

å®é™…ä¸Šæ˜¯æœ‰çš„ï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯æŸ¥æ‰¾ Kubernetes API æ–‡æ¡£ï¼Œæ¯”å¦‚ç°åœ¨ä½¿ç”¨çš„æ˜¯ v1.25.4 ç‰ˆæœ¬çš„é›†ç¾¤ï¼Œå¯ä»¥é€šè¿‡åœ°å€ [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.25/](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.25/) æŸ¥æ‰¾åˆ°å¯¹åº”çš„ API æ–‡æ¡£ï¼Œåœ¨è¿™ä¸ªæ–‡æ¡£ä¸­å¯ä»¥æ‰¾åˆ°æ‰€æœ‰èµ„æºå¯¹è±¡çš„ä¸€äº›å­—æ®µã€‚

æ¯”å¦‚è¦äº†è§£åˆ›å»ºä¸€ä¸ª Deployment èµ„æºå¯¹è±¡éœ€è¦å“ªäº›å­—æ®µï¼Œå¯ä»¥æ‰“å¼€ä¸Šé¢çš„ API æ–‡æ¡£é¡µé¢ï¼Œåœ¨å·¦ä¾§ä¾§è¾¹æ æ‰¾åˆ° Deployment v1 appsï¼Œç‚¹å‡»ä¸‹é¢çš„ Write Operationsï¼Œç„¶åç‚¹å‡» Createï¼Œç„¶åæŸ¥æ‰¾åˆ°åˆ›å»º Deployment éœ€è¦æäº¤çš„ Body å‚æ•°ã€‚
![img](image/2024-04-01-16-11-43.png)

å°±å¯ä»¥çœ‹åˆ°åˆ›å»º Deployment éœ€è¦çš„ä¸€äº›å­—æ®µï¼Œæ¯”å¦‚ apiVersionã€kindã€metadataã€spec ç­‰ï¼Œè€Œä¸”æ¯ä¸ªå­—æ®µéƒ½æœ‰å¯¹åº”çš„æ–‡æ¡£è¯´æ˜ï¼Œæ¯”å¦‚æƒ³è¦äº†è§£ DeploymentSpec ä¸‹é¢æœ‰å“ªäº›å­—æ®µï¼Œç»§ç»­ç‚¹å‡»è¿›å»æŸ¥çœ‹å°±è¡Œï¼š
![img](image/2024-04-01-16-12-13.png)

æ¯ä¸ªå­—æ®µå…·ä½“ä»€ä¹ˆå«ä¹‰ä»¥åŠæ¯ä¸ªå­—æ®µä¸‹é¢æ˜¯å¦è¿˜æœ‰å…¶ä»–å­—æ®µéƒ½å¯ä»¥è¿™æ ·å»è¿½æº¯ã€‚

ä½†æ˜¯å¦‚æœå¹³æ—¶ç¼–å†™èµ„æºæ¸…å•çš„æ—¶å€™éƒ½è¿™æ ·å»æŸ¥æ‰¾æ–‡æ¡£åŠ¿å¿…ä¼šæ•ˆç‡ä½ä¸‹ï¼ŒKubernetes ä¹Ÿè€ƒè™‘åˆ°äº†è¿™ç‚¹ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡ kubectl å‘½ä»¤è¡Œå·¥å…·æ¥è·å–è¿™äº›å­—æ®µä¿¡æ¯ï¼ŒåŒæ ·çš„ï¼Œæ¯”å¦‚è¦è·å– Deployment çš„å­—æ®µä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ `kubectl explain` å‘½ä»¤æ¥äº†è§£ï¼š

```shell
[root@localhost ~]# kubectl explain deployment
GROUP:      apps
KIND:       Deployment
VERSION:    v1

DESCRIPTION:
    Deployment enables declarative updates for Pods and ReplicaSets.

FIELDS:
  apiVersion    <string>
    APIVersion defines the versioned schema of this representation of an object.
    Servers should convert recognized schemas to the latest internal value, and
    may reject unrecognized values. More info:
    https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources

  kind  <string>
    Kind is a string value representing the REST resource this object
    represents. Servers may infer this from the endpoint the client submits
    requests to. Cannot be updated. In CamelCase. More info:
    https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds

  metadata      <ObjectMeta>
    Standard object's metadata. More info:
    https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata

  spec  <DeploymentSpec>
    Specification of the desired behavior of the Deployment.

  status        <DeploymentStatus>
    Most recently observed status of the Deployment.


[root@localhost ~]#

```

å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ä¿¡æ¯å’Œåœ¨ API æ–‡æ¡£ä¸­æŸ¥çœ‹åˆ°çš„åŸºæœ¬ä¸€è‡´ï¼Œæ¯”å¦‚æˆ‘ä»¬çœ‹åˆ°å…¶ä¸­ spec å­—æ®µæ˜¯ä¸€ä¸ª `<Object>`ç±»å‹çš„ï¼Œè¯æ˜è¯¥å­—æ®µä¸‹é¢æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥ç»§ç»­å»æŸ¥çœ‹è¿™ä¸ªå­—æ®µä¸‹é¢çš„è¯¦ç»†ä¿¡æ¯ï¼š

```shell
[root@localhost ~]# kubectl explain deployment.spec
GROUP:      apps
KIND:       Deployment
VERSION:    v1

FIELD: spec <DeploymentSpec>

DESCRIPTION:
    Specification of the desired behavior of the Deployment.
    DeploymentSpec is the specification of the desired behavior of the
    Deployment.

FIELDS:
  minReadySeconds       <integer>
    Minimum number of seconds for which a newly created pod should be ready
    without any of its container crashing, for it to be considered available.
    Defaults to 0 (pod will be considered available as soon as it is ready)

  paused        <boolean>
    Indicates that the deployment is paused.

  progressDeadlineSeconds       <integer>
    The maximum time in seconds for a deployment to make progress before it is
    considered to be failed. The deployment controller will continue to process
    failed deployments and a condition with a ProgressDeadlineExceeded reason
    will be surfaced in the deployment status. Note that progress will not be
    estimated during the time a deployment is paused. Defaults to 600s.

  replicas      <integer>
    Number of desired pods. This is a pointer to distinguish between explicit
    zero and not specified. Defaults to 1.

  revisionHistoryLimit  <integer>
    The number of old ReplicaSets to retain to allow rollback. This is a pointer
    to distinguish between explicit zero and not specified. Defaults to 10.

  selector      <LabelSelector> -required-
    Label selector for pods. Existing ReplicaSets whose pods are selected by
    this will be the ones affected by this deployment. It must match the pod
    template's labels.

  strategy      <DeploymentStrategy>
    The deployment strategy to use to replace existing pods with new ones.

  template      <PodTemplateSpec> -required-
    Template describes the pods that will be created.


[root@localhost ~]#
```

å¦‚æœä¸€ä¸ªå­—æ®µæ˜¾ç¤ºçš„æ˜¯ `required`ï¼Œè¿™å°±è¯æ˜è¯¥è‡ªåŠ¨æ˜¯å¿…å¡«çš„ï¼Œä¹Ÿå°±æ˜¯åœ¨åˆ›å»ºè¿™ä¸ªèµ„æºå¯¹è±¡çš„æ—¶å€™å¿…é¡»å£°æ˜è¿™ä¸ªå­—æ®µï¼Œæ¯ä¸ªå­—æ®µçš„ç±»å‹ä¹Ÿéƒ½ä¸ºå…¶è¿›è¡Œäº†è¯´æ˜ï¼Œæ‰€ä»¥æœ‰äº† `kubectl explain` è¿™ä¸ªå‘½ä»¤å°±å®Œå…¨å¯ä»¥å†™å‡ºä¸€ä¸ªä¸ç†Ÿæ‚‰çš„èµ„æºå¯¹è±¡çš„æ¸…å•è¯´æ˜ï¼Œè¿™ä¸ªå‘½ä»¤ä¹Ÿæ˜¯å¿…é¡»è¦è®°ä½çš„ï¼Œä¼šåœ¨ä»¥åçš„å·¥ä½œä¸­ä¸ºæˆ‘ä»¬æä¾›å¾ˆå¤§çš„å¸®åŠ©ã€‚

# Pod æ˜¯ä»€ä¹ˆ

Pod æ˜¯ Kubernetes é›†ç¾¤ä¸­æœ€åŸºæœ¬çš„è°ƒåº¦å•å…ƒï¼Œå¹³æ—¶åœ¨é›†ç¾¤ä¸­éƒ¨ç½²çš„åº”ç”¨éƒ½æ˜¯ä»¥ Pod ä¸ºå•ä½çš„ï¼Œè€Œå¹¶ä¸æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„å®¹å™¨ï¼Œè¿™æ ·è®¾è®¡çš„ç›®çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸ºä½•ä¸ç›´æ¥ä½¿ç”¨å®¹å™¨å‘¢ï¼Ÿ

## ä¸ºä»€ä¹ˆéœ€è¦ Pod

å‡è®¾ Kubernetes ä¸­è°ƒåº¦çš„åŸºæœ¬å•å…ƒå°±æ˜¯å®¹å™¨ï¼Œå¯¹äºä¸€ä¸ªéå¸¸ç®€å•çš„åº”ç”¨å¯ä»¥ç›´æ¥è¢«è°ƒåº¦ç›´æ¥ä½¿ç”¨ï¼Œæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å¾€å¾€è¿˜æœ‰å¾ˆå¤šåº”ç”¨ç¨‹åºæ˜¯ç”±å¤šä¸ªè¿›ç¨‹ç»„æˆçš„ï¼Œæœ‰çš„åŒå­¦å¯èƒ½ä¼šè¯´æŠŠè¿™äº›è¿›ç¨‹éƒ½æ‰“åŒ…åˆ°ä¸€ä¸ªå®¹å™¨ä¸­å»ä¸å°±å¯ä»¥äº†å—ï¼Ÿç†è®ºä¸Šæ˜¯å¯ä»¥å®ç°çš„ï¼Œä½†æ˜¯ä¸è¦å¿˜è®°äº†å®¹å™¨è¿è¡Œæ—¶ç®¡ç†çš„è¿›ç¨‹æ˜¯ pid=1 çš„ä¸»è¿›ç¨‹ï¼Œå…¶ä»–è¿›ç¨‹æ­»æ‰äº†å°±ä¼šæˆä¸ºåƒµå°¸è¿›ç¨‹ï¼Œæ²¡åŠæ³•è¿›è¡Œç®¡ç†äº†ï¼Œè¿™ç§æ–¹å¼æœ¬èº«ä¹Ÿä¸æ˜¯å®¹å™¨æ¨èçš„è¿è¡Œæ–¹å¼ï¼Œä¸€ä¸ªå®¹å™¨æœ€å¥½åªå¹²ä¸€ä»¶äº‹æƒ…ï¼Œæ‰€ä»¥åœ¨çœŸå®çš„ç¯å¢ƒä¸­ä¸ä¼šä½¿ç”¨è¿™ç§æ–¹å¼ã€‚

GPTè§£é‡Šï¼šåœ¨ä¼ ç»Ÿçš„Linuxç³»ç»Ÿä¸­ï¼Œinitè¿›ç¨‹ï¼ˆ`PID 1`ï¼‰è´Ÿè´£ç³»ç»Ÿåˆå§‹åŒ–å’Œè¿›ç¨‹ç®¡ç†ï¼ŒåŒ…æ‹¬åƒµå°¸è¿›ç¨‹çš„å›æ”¶ã€‚åœ¨å®¹å™¨ä¸­ï¼Œ`PID 1`è¿›ç¨‹éœ€è¦æ‰¿æ‹…ç›¸ä¼¼çš„è´£ä»»ï¼Œå¦‚æœå®¹å™¨å†…çš„å­è¿›ç¨‹ç»ˆæ­¢ï¼Œ`PID 1`è¿›ç¨‹éœ€è¦å›æ”¶å®ƒä»¬ï¼Œå¦åˆ™ç»ˆæ­¢çš„è¿›ç¨‹ä¼šå˜æˆåƒµå°¸è¿›ç¨‹ã€‚åƒµå°¸è¿›ç¨‹è™½ç„¶ä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼Œä½†ä»ç„¶å ç”¨ç³»ç»Ÿèµ„æºï¼Œå¦‚è¿›ç¨‹è¡¨é¡¹ã€‚

é‚£ä¹ˆå°±æŠŠè¿™ä¸ªåº”ç”¨çš„è¿›ç¨‹è¿›è¡Œæ‹†åˆ†ï¼Œæ‹†åˆ†æˆä¸€ä¸ªä¸€ä¸ªçš„å®¹å™¨æ€»å¯ä»¥äº†å§ï¼Ÿä½†æ˜¯ä¸è¦å¿˜è®°ä¸€ä¸ªé—®é¢˜ï¼Œæ‹†åˆ†æˆä¸€ä¸ªä¸€ä¸ªçš„å®¹å™¨åï¼Œæ˜¯ä¸æ˜¯å°±æœ‰å¯èƒ½å‡ºç°ä¸€ä¸ªåº”ç”¨ä¸‹é¢çš„æŸä¸ªè¿›ç¨‹å®¹å™¨è¢«è°ƒåº¦åˆ°äº†ä¸åŒçš„èŠ‚ç‚¹ä¸Šå‘€ï¼Ÿå¾€å¾€åº”ç”¨å†…éƒ¨çš„è¿›ç¨‹ä¸è¿›ç¨‹é—´é€šä¿¡ï¼ˆé€šè¿‡ IPC æˆ–è€…å…±äº«æœ¬åœ°æ–‡ä»¶ä¹‹ç±»ï¼‰éƒ½æ˜¯è¦æ±‚åœ¨æœ¬åœ°è¿›è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯éœ€è¦åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ï¼ˆPodå…è®¸å¤šä¸ªå®¹å™¨å…±å­˜ï¼Œå…±äº«ç½‘ç»œå’Œå­˜å‚¨èµ„æºï¼ŒåŒæ—¶ä¿æŒè¿›ç¨‹éš”ç¦»ã€‚ï¼‰

æ‰€ä»¥éœ€è¦ä¸€ä¸ªæ›´é«˜çº§åˆ«çš„ç»“æ„æ¥å°†è¿™äº›å®¹å™¨ç»‘å®šåœ¨ä¸€èµ·ï¼Œå¹¶å°†ä»–ä»¬ä½œä¸ºä¸€ä¸ªåŸºæœ¬çš„è°ƒåº¦å•å…ƒè¿›è¡Œç®¡ç†ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯è¿™äº›å®¹å™¨å§‹ç»ˆåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šé¢ï¼Œè¿™ä¹Ÿå°±æ˜¯ Pod è®¾è®¡çš„åˆè¡·ã€‚

## Pod åŸç†

**å…¶å® Pod ä¹Ÿåªæ˜¯ä¸€ä¸ªé€»è¾‘æ¦‚å¿µï¼ŒçœŸæ­£èµ·ä½œç”¨çš„è¿˜æ˜¯ Linux å®¹å™¨çš„ Namespace å’Œ Cgroup è¿™ä¸¤ä¸ªæœ€åŸºæœ¬çš„æ¦‚å¿µï¼ŒPod è¢«åˆ›å»ºå‡ºæ¥å…¶å®æ˜¯ä¸€ç»„å…±äº«äº†ä¸€äº›èµ„æºçš„å®¹å™¨è€Œå·²ã€‚é¦–å…ˆ Pod é‡Œé¢çš„æ‰€æœ‰å®¹å™¨ï¼Œéƒ½æ˜¯å…±äº«çš„åŒä¸€ä¸ª `Network Namespace`ï¼Œä½†æ˜¯æ¶‰åŠåˆ°æ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™ï¼Œé»˜è®¤æƒ…å†µä¸‹ Pod é‡Œé¢çš„å®¹å™¨ä¹‹é—´çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯å®Œå…¨éš”ç¦»çš„ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å£°æ˜æ¥å…±äº«åŒä¸€ä¸ª Volumeã€‚**

å¯ä»¥æŒ‡å®šæ–°åˆ›å»ºçš„å®¹å™¨å’Œä¸€ä¸ªå·²ç»å­˜åœ¨çš„å®¹å™¨å…±äº«ä¸€ä¸ª `Network Namespace`ï¼Œåœ¨è¿è¡Œå®¹å™¨çš„æ—¶å€™åªéœ€è¦æŒ‡å®š `--net=container:ç›®æ ‡å®¹å™¨å` è¿™ä¸ªå‚æ•°å°±å¯ä»¥äº†ï¼Œä½†æ˜¯è¿™ç§æ¨¡å¼æœ‰ä¸€ä¸ªæ˜æ˜¾çš„é—®é¢˜é‚£å°±æ˜¯å®¹å™¨çš„å¯åŠ¨æœ‰å…ˆåé¡ºåºé—®é¢˜ï¼Œé‚£ä¹ˆ Pod æ˜¯æ€ä¹ˆæ¥å¤„ç†è¿™ä¸ªé—®é¢˜çš„å‘¢ï¼Ÿé‚£å°±æ˜¯åŠ å…¥ä¸€ä¸ªä¸­é—´å®¹å™¨ï¼ˆæ²¡æœ‰ä»€ä¹ˆæ¶æ„æ˜¯åŠ ä¸€ä¸ªä¸­é—´ä»¶è§£å†³ä¸äº†çš„ï¼‰ï¼Œè¿™ä¸ªå®¹å™¨å«åš `Infra` å®¹å™¨ï¼Œè€Œä¸”è¿™ä¸ªå®¹å™¨åœ¨ Pod ä¸­æ°¸è¿œéƒ½æ˜¯ç¬¬ä¸€ä¸ªè¢«åˆ›å»ºçš„å®¹å™¨ï¼Œè¿™æ ·å…¶ä»–å®¹å™¨éƒ½åŠ å…¥åˆ°è¿™ä¸ª Infra å®¹å™¨å°±å¯ä»¥äº†ï¼Œè¿™æ ·å°±å®Œå…¨å®ç°äº† Pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½å’Œ Infra å®¹å™¨å…±äº«åŒä¸€ä¸ª `Network Namespace` äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="image/2024-04-01-17-44-58.png" alt="img" style="zoom: 40%;" />

æ‰€ä»¥å½“éƒ¨ç½²å®Œæˆ Kubernetes é›†ç¾¤çš„æ—¶å€™ï¼Œé¦–å…ˆéœ€è¦ä¿è¯åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå¯ä»¥æ‹‰å–åˆ°é»˜è®¤çš„ Infra é•œåƒï¼Œé»˜è®¤æƒ…å†µä¸‹ Infra é•œåƒåœ°å€ä¸º `registry.k8s.io/pause:3.8`ï¼Œè¿™ä¸ªå®¹å™¨å ç”¨çš„èµ„æºéå¸¸å°‘ï¼Œä½†æ˜¯è¿™ä¸ªé•œåƒé»˜è®¤æ˜¯éœ€è¦ç§‘å­¦ä¸Šç½‘çš„ï¼Œæ‰€ä»¥å¾ˆå¤šæ—¶å€™åœ¨éƒ¨ç½²åº”ç”¨çš„æ—¶å€™ä¸€ç›´å¤„äº `Pending` çŠ¶æ€æˆ–è€…æŠ¥ `sandbox image` ç›¸å…³çš„é”™è¯¯ä¿¡æ¯ï¼Œå¤§éƒ¨åˆ†æ˜¯å› ä¸º Pod æœ€å…ˆå¯åŠ¨çš„å®¹å™¨é•œåƒéƒ½æ‹‰ä¸ä¸‹æ¥ï¼Œè‚¯å®šå¯åŠ¨ä¸äº†ï¼Œå¯åŠ¨ä¸äº†å…¶ä»–å®¹å™¨è‚¯å®šä¹Ÿå°±ä¸èƒ½å¯åŠ¨ï¼š

```sh
[root@master ~]# kubelet --help |grep infra
      --pod-infra-container-image string                         Specified image will not be pruned by the image garbage collector. CRI implementations have their own configuration to set this image. (default "registry.k8s.io/pause:3.8") (DEPRECATED: will be removed in 1.27. Image garbage collector will get sandbox image information from CRI.)
[root@master ~]#
```

ä»ä¸Šé¢å›¾ä¸­å¯ä»¥çœ‹å‡ºæ™®é€šçš„å®¹å™¨åŠ å…¥åˆ°äº† Infra å®¹å™¨çš„ `Network Namespace` ä¸­ï¼Œæ‰€ä»¥è¿™ä¸ª Pod ä¸‹é¢çš„æ‰€æœ‰å®¹å™¨å°±æ˜¯å…±äº«åŒä¸€ä¸ª `Network Namespace`ï¼Œæ™®é€šå®¹å™¨ä¸ä¼šåˆ›å»ºè‡ªå·±çš„ç½‘å¡ã€é…ç½®è‡ªå·±çš„ IPï¼Œè€Œæ˜¯å’Œ Infra å®¹å™¨å…±äº« IPã€ç«¯å£èŒƒå›´ç­‰ï¼Œè€Œä¸”å®¹å™¨ä¹‹é—´çš„è¿›ç¨‹å¯ä»¥é€šè¿‡ lo ç½‘å¡è®¾å¤‡ï¼ˆè™šæ‹Ÿç½‘å¡ï¼‰è¿›è¡Œé€šä¿¡ï¼š

* å®¹å™¨ä¹‹é—´æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨ localhost è¿›è¡Œé€šä¿¡ï¼›
* çœ‹åˆ°çš„ç½‘ç»œè®¾å¤‡ä¿¡æ¯éƒ½æ˜¯å’Œ Infra å®¹å™¨å®Œå…¨ä¸€æ ·çš„ï¼›
* æ„å‘³ç€åŒä¸€ä¸ª Pod ä¸‹é¢çš„å®¹å™¨è¿è¡Œçš„å¤šä¸ªè¿›ç¨‹ä¸èƒ½ç»‘å®šç›¸åŒçš„ç«¯å£ï¼›
* è€Œä¸” Pod çš„ç”Ÿå‘½å‘¨æœŸåªè·Ÿ Infra å®¹å™¨ä¸€è‡´ï¼Œè€Œä¸å®¹å™¨ A å’Œ B æ— å…³ã€‚

å¯¹äºæ–‡ä»¶ç³»ç»Ÿ Kubernetes æ˜¯æ€ä¹ˆå®ç°è®©ä¸€ä¸ª Pod ä¸­çš„å®¹å™¨å…±äº«çš„å‘¢ï¼Ÿé»˜è®¤æƒ…å†µä¸‹å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯äº’ç›¸éš”ç¦»çš„ï¼Œè¦å®ç°å…±äº«åªéœ€è¦åœ¨ Pod çš„é¡¶å±‚å£°æ˜ä¸€ä¸ª Volumeï¼Œç„¶ååœ¨éœ€è¦å…±äº«è¿™ä¸ª Volume çš„å®¹å™¨ä¸­å£°æ˜æŒ‚è½½å³å¯ã€‚

<img src="image/2024-04-01-17-46-21.png" style="zoom: 50%;" />

æ¯”å¦‚ä¸‹é¢çš„ç¤ºä¾‹ï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: counter
spec:
  volumes:
  - name: varlog
    hostPath:
      path: /var/log/counter
  containers:
  - name: count
    image: busybox
    args:
    - /bin/sh
    - -c
    - >
      i=0;
      while true;
      do
        echo "$i: $(date)" >> /var/log/1.log;
        i=$((i+1));
        sleep 1;
      done
    volumeMounts:
    - name: varlog
      mountPath: /var/log
  - name: count-log
    image: busybox
    args: [/bin/sh, -c, 'tail -n+1 -f /opt/log/1.log']
    volumeMounts:
    - name: varlog
      mountPath: /opt/log
```

ç¤ºä¾‹ä¸­åœ¨ Pod çš„é¡¶å±‚å£°æ˜äº†ä¸€ä¸ªåä¸º `varlog` çš„ Volumeï¼Œè€Œè¿™ä¸ª Volume çš„ç±»å‹æ˜¯ `hostPath`ï¼Œä¹Ÿå°±æ„å‘³è¿™ä¸ªå®¿ä¸»æœºçš„ `/var/log/counter` ç›®å½•å°†è¢«è¿™ä¸ª Pod å…±äº«ï¼Œå…±äº«ç»™è°å‘¢ï¼Ÿåœ¨éœ€è¦ç”¨åˆ°è¿™ä¸ªæ•°æ®ç›®å½•çš„å®¹å™¨ä¸Šå£°æ˜æŒ‚è½½å³å¯ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ `volumeMounts` å£°æ˜æŒ‚è½½çš„éƒ¨åˆ†ï¼Œè¿™æ · Pod å°±å®ç°äº†å®¹å™¨å…±äº«æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œä¸”æ•°æ®è¢«æŒä¹…åŒ–åˆ°äº†å®¿ä¸»æœºç›®å½•ä¸Šã€‚

è¿™ä¸ªæ–¹å¼ä¹Ÿæ˜¯ Kubernetes ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„è®¾è®¡æ¨¡å¼ï¼šsidecar æ¨¡å¼çš„å¸¸ç”¨æ–¹å¼ã€‚å…¸å‹çš„åœºæ™¯å°±æ˜¯å®¹å™¨æ—¥å¿—æ”¶é›†ï¼Œæ¯”å¦‚ä¸Šé¢çš„è¿™ä¸ªåº”ç”¨ï¼Œå…¶ä¸­åº”ç”¨çš„æ—¥å¿—æ˜¯è¢«è¾“å‡ºåˆ°å®¹å™¨çš„ `/var/log` ç›®å½•ä¸Šçš„ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥æŠŠ Pod å£°æ˜çš„ Volume æŒ‚è½½åˆ°å®¹å™¨çš„ ` /var/log` ç›®å½•ä¸Šï¼Œç„¶ååœ¨è¿™ä¸ª Pod é‡Œé¢åŒæ—¶è¿è¡Œä¸€ä¸ª sidecar å®¹å™¨ï¼Œå®ƒä¹Ÿå£°æ˜æŒ‚è½½ç›¸åŒçš„ Volume åˆ°è‡ªå·±å®¹å™¨çš„ `/opt/log` ï¼ˆæˆ–å…¶ä»–ï¼‰ç›®å½•ä¸Šï¼Œè¿™æ · sidecar å®¹å™¨å°±åªéœ€è¦ä» `/opt/log` ç›®å½•ä¸‹é¢ä¸æ–­æ¶ˆè´¹æ—¥å¿—å‘é€åˆ° Elasticsearch ä¸­å­˜å‚¨èµ·æ¥å°±å®Œæˆäº†æœ€åŸºæœ¬çš„åº”ç”¨æ—¥å¿—çš„åŸºæœ¬æ”¶é›†å·¥ä½œäº†ã€‚

é™¤äº†è¿™ä¸ªåº”ç”¨åœºæ™¯ä¹‹å¤–æ›´å¤šçš„è¿˜æ˜¯åˆ©ç”¨ Pod ä¸­æ‰€æœ‰å®¹å™¨å…±äº«åŒä¸€ä¸ª `Network Namespace` è¿™ä¸ªç‰¹æ€§ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠ Pod ç½‘ç»œç›¸å…³çš„é…ç½®å’Œç®¡ç†äº¤ç»™ä¸€ä¸ª sidecar å®¹å™¨æ¥å®Œæˆï¼Œå®Œå…¨ä¸éœ€è¦å»å¹²æ¶‰ç”¨æˆ·å®¹å™¨ï¼Œè¿™ä¸ªç‰¹æ€§åœ¨ç°åœ¨éå¸¸ç«çƒ­çš„ Service Meshï¼ˆæœåŠ¡ç½‘æ ¼ï¼‰ä¸­åº”ç”¨éå¸¸å¹¿æ³›ï¼Œå…¸å‹çš„åº”ç”¨å°±æ˜¯ Istioï¼Œä¸è¿‡ä¹Ÿä¸ç”¨ç€æ€¥ï¼Œåé¢ä¹Ÿä¼šå’Œå¤§å®¶ä¸€èµ·æ¢è®¨çš„ã€‚

## å­˜å‚¨å·

å‚è€ƒèµ„æ–™ï¼šhttps://www.cnblogs.com/hongdada/p/11586514.html

Kubernetes çš„å­˜å‚¨å·æœ‰è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¸ä½¿ç”¨çš„å®ƒ Pod ç”Ÿå‘½å‘¨æœŸä¸€è‡´ã€‚å› æ­¤ï¼Œç›¸æ¯”äºåœ¨ Pod ä¸­è¿è¡Œçš„å®¹å™¨æ¥è¯´ï¼Œå­˜å‚¨å·çš„å­˜åœ¨æ—¶é—´ä¼šæ¯”çš„å…¶ä¸­çš„ä»»ä½•å®¹å™¨éƒ½é•¿ã€‚å½“ç„¶ï¼Œå½“ Pod åœæ­¢å­˜åœ¨æ—¶ï¼Œå­˜å‚¨å·ä¹Ÿå°†ä¸å†å­˜åœ¨ã€‚Kubernetes æ”¯æŒå¤šç§ç±»å‹çš„å·ï¼Œè€Œä¸” Pod å¯ä»¥åŒæ—¶ä½¿ç”¨å¤šç§ç±»å‹å’Œä»»æ„æ•°é‡çš„å­˜å‚¨å·ã€‚

åœ¨ Pod ä¸­é€šè¿‡æŒ‡å®šä¸‹é¢çš„å­—æ®µæ¥ä½¿ç”¨å­˜å‚¨å·ï¼š

- `spec.volumes`ï¼šé€šè¿‡æ­¤å­—æ®µæä¾›æŒ‡å®šçš„å­˜å‚¨å·
- `spec.containers.volumeMounts`ï¼šé€šè¿‡æ­¤å­—æ®µå°†å­˜å‚¨å·æŒ‚æ¥åˆ°å®¹å™¨ä¸­

### emptryDir

emptyDir ç±»å‹çš„ Volume åœ¨ Pod åˆ†é…åˆ° Node ä¸Šæ—¶è¢«åˆ›å»ºï¼ŒKubernetes ä¼šåœ¨ Node ä¸Šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªç›®å½•ï¼Œå› æ­¤æ— éœ€æŒ‡å®šå®¿ä¸»æœº Node ä¸Šå¯¹åº”çš„ç›®å½•ï¼Œè¿™ä¸ªç›®å½•çš„åˆå§‹å†…å®¹ä¸ºç©ºã€‚**å½“ Pod ä» Node ä¸Šç§»é™¤æ—¶ï¼ŒemptyDir ä¸­çš„æ•°æ®ä¼šè¢«æ°¸ä¹…åˆ é™¤ã€‚**

emptyDir Volume ä¸»è¦ç”¨äºæŸäº›åº”ç”¨ç¨‹åºæ— éœ€æ°¸ä¹…ä¿å­˜çš„ä¸´æ—¶ç›®å½•ã€å¤šä¸ªå®¹å™¨çš„å…±äº«ç›®å½•ç­‰ã€‚

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-pd
spec:
  containers:
  - image: gcr.io/google_containers/test-webserver
    name: test-container
    volumeMounts:
    - mountPath: /cache
      name: cache-volume
  volumes:
  - name: cache-volume
    emptyDir: {}
```

### hostPath

hostPath ç±»å‹çš„å­˜å‚¨å·ç”¨äºå°†å®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶æˆ–ç›®å½•æŒ‚åˆ° Pod ä¸­ï¼Œé™¤äº†éœ€è¦æŒ‡å®š `path` å­—æ®µä¹‹å¤–ï¼Œåœ¨ä½¿ç”¨hostPath ç±»å‹çš„å­˜å‚¨å·æ—¶ï¼Œä¹Ÿå¯ä»¥è®¾ç½® `type`ï¼Œ`type` æ”¯æŒçš„æšä¸¾å€¼è§ä¸‹è¡¨ã€‚å¦å¤–åœ¨ä½¿ç”¨ hostPath æ—¶ï¼Œéœ€è¦æ³¨æ„ä¸‹é¢çš„äº‹é¡¹ï¼š

- å…·æœ‰ç›¸åŒé…ç½®çš„ Podï¼ˆä¾‹å¦‚ï¼šä»åŒä¸€ä¸ª podTemplate åˆ›å»ºçš„ï¼‰ï¼Œå¯èƒ½ä¼šç”±äº Node çš„æ–‡ä»¶ä¸åŒï¼Œè€Œè¡Œä¸ºä¸åŒã€‚è¿™æ˜¯å› ä¸ºå„ä¸ªèŠ‚ç‚¹ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿå¯èƒ½ä¸ä¸€è‡´ã€‚
- åœ¨å®¿ä¸»æœºä¸Šåˆ›å»ºçš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œé»˜è®¤æƒ…å†µä¸‹åªæœ‰ `root` ç”¨æˆ·å…·æœ‰å†™æƒé™ã€‚æ‚¨è¦ä¹ˆåœ¨å®¹å™¨ä¸­ä»¥ `root` èº«ä»½è¿è¡Œè¿›ç¨‹ï¼Œè¦ä¹ˆåœ¨ä¸»æœºä¸Šä¿®æ”¹çš„æ–‡ä»¶æˆ–ç›®å½•çš„æƒé™ï¼Œä»¥ä¾¿å…·å¤‡å†™å…¥å†…å®¹åˆ° hostPath çš„å­˜å‚¨å·ä¸­ã€‚

|         å€¼          |                             è¡Œä¸º                             |
| :-----------------: | :----------------------------------------------------------: |
|                     | ç©ºå­—ç¬¦ä¸²ï¼ˆé»˜è®¤ï¼‰æ˜¯ç”¨äºå‘åå…¼å®¹ï¼Œè¿™æ„å‘³ç€åœ¨æŒ‚è½½ä¸»æœºè·¯å¾„å­˜å‚¨å·ä¹‹å‰ä¸æ‰§è¡Œä»»ä½•æ£€æŸ¥ã€‚ |
| `DirectoryOrCreate` | å¦‚æœ path æŒ‡å®šç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåœ¨å®¿ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„ç›®å½•ï¼Œå¹¶è®¾ç½®ç›®å½•æƒé™ä¸º0755ï¼Œæ­¤ç›®å½•ä¸ kubelet æ‹¥æœ‰ä¸€æ ·çš„ç»„å’Œæ‹¥æœ‰è€…ã€‚ |
|     `Directory`     |                   path æŒ‡å®šçš„ç›®å½•å¿…éœ€å­˜åœ¨                    |
|   `FileOrCreate`    | å¦‚æœ path æŒ‡å®šçš„æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåœ¨å®¿ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªç©ºçš„æ–‡ä»¶ï¼Œè®¾ç½®æƒé™ä¸º0644ï¼Œæ­¤æ–‡ä»¶ä¸ kubelet æ‹¥æœ‰ä¸€æ ·çš„ç»„å’Œæ‹¥æœ‰è€…ã€‚ |
|       `File`        |                   path æŒ‡å®šçš„æ–‡ä»¶å¿…éœ€å­˜åœ¨                    |
|      `Socket`       |               path æŒ‡å®šçš„ UNIX socket å¿…éœ€å­˜åœ¨               |
|    `CharDevice`     |                 path æŒ‡å®šçš„å­—ç¬¦è®¾å¤‡å¿…éœ€å­˜åœ¨                  |
|    `BlockDevice`    |                 path æŒ‡å®šçš„å—è®¾å¤‡å¿…é¡»å­˜åœ¨ã€‚                  |

ä¸‹é¢æ˜¯ä½¿ç”¨ hostPath ä½œä¸ºå­˜å‚¨å·çš„ YAML æ–‡ä»¶ï¼Œæ­¤ YAML æ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ªåç§°ä¸º `test-pd` çš„ Pod èµ„æºã€‚å®ƒé€šè¿‡hostPath ç±»å‹çš„å­˜å‚¨å·ï¼Œå°† Pod å®¿ä¸»æœºä¸Šçš„`/data`æŒ‚è½½åˆ°å®¹å™¨ä¸­çš„`/teset-pd`ç›®å½•ã€‚

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-pd
spec:
  containers:
  - image: k8s.gcr.io/test-webserver
    name: test-container
    # æŒ‡å®šåœ¨å®¹å™¨ä¸­æŒ‚è½½è·¯å¾„
    volumeMounts:
    - mountPath: /test-pd
      name: test-volume
  # æŒ‡å®šæ‰€æä¾›çš„å­˜å‚¨å·
  volumes:
  - name: test-volume
    hostPath:
      # å®¿ä¸»æœºä¸Šçš„ç›®å½•
      path: /data
      # this field is optional
      type: Directory
```

### nfs

åœ¨Kubernetesä¸­ï¼Œå¯ä»¥é€šè¿‡ nfs ç±»å‹çš„å­˜å‚¨å·å°†ç°æœ‰çš„NFSï¼ˆç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼‰æŒ‚è½½åˆ° Pod ä¸­ã€‚åœ¨ç§»é™¤ Pod æ—¶ï¼ŒNFSä¸­çš„å†…å®¹è¢«ä¸ä¼šè¢«åˆ é™¤ï¼Œåªæ˜¯å°†å­˜å‚¨å·å¸è½½è€Œå·²ã€‚è¿™æ„å‘³ç€å¯ä»¥é¢„å…ˆåœ¨ NFS ä¸­å¡«å……æ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ Pod ä¹‹é—´å…±äº«æ•°æ®ã€‚NFSå¯ä»¥è¢«åŒæ—¶æŒ‚æ¥åˆ°å¤šä¸ª Pod ä¸­ï¼Œå¹¶èƒ½åŒæ—¶è¿›è¡Œå†™å…¥ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šåœ¨ä½¿ç”¨ nfs å­˜å‚¨å·ä¹‹å‰ï¼Œå¿…é¡»å·²æ­£ç¡®éƒ¨ç½²å’Œè¿è¡Œ NFS æœåŠ¡å™¨ï¼Œå¹¶å·²ç»è®¾ç½®äº†å…±äº«ç›®å½•ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ª redis éƒ¨ç½²çš„YAMLé…ç½®æ–‡ä»¶ï¼Œredis åœ¨å®¹å™¨ä¸­çš„æŒä¹…åŒ–æ•°æ®ä¿å­˜åœ¨`/data`ç›®å½•ä¸‹ï¼›å­˜å‚¨å·ä½¿ç”¨ nfsï¼Œnfs çš„æœåŠ¡åœ°å€ä¸ºï¼š`192.168.8.150`ï¼Œå­˜å‚¨è·¯å¾„ä¸ºï¼š`/k8s-nfs/redis/data`ã€‚å®¹å™¨é€šè¿‡ `volumeMounts.name` çš„å€¼ç¡®å®šæ‰€ä½¿ç”¨çš„å­˜å‚¨å·

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
spec:
  selector:
    matchLabels:
      app: redis
  revisionHistoryLimit: 2
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      # åº”ç”¨çš„é•œåƒ
      - image: redis
        name: redis
        imagePullPolicy: IfNotPresent
        # åº”ç”¨çš„å†…éƒ¨ç«¯å£
        ports:
        - containerPort: 6379
          name: redis6379
        env:
        - name: ALLOW_EMPTY_PASSWORD
          value: "yes"
        - name: REDIS_PASSWORD
          value: "redis"   
        # æŒä¹…åŒ–æŒ‚æ¥ä½ç½®ï¼Œåœ¨dockerä¸­ 
        volumeMounts:
        - name: redis-persistent-storage
          mountPath: /data
      volumes:
      # å®¿ä¸»æœºä¸Šçš„ç›®å½•
      - name: redis-persistent-storage
        nfs:
          path: /k8s-nfs/redis/data
          server: 192.168.8.150
```

### persistentVolumeClaim

persistentVolumeClaim ç±»å‹å­˜å‚¨å·å°† PersistentVolume æŒ‚è½½åˆ° Pod ä¸­ä½œä¸ºå­˜å‚¨å·ã€‚ä½¿ç”¨æ­¤ç±»å‹çš„å­˜å‚¨å·ï¼Œç”¨æˆ·å¹¶ä¸çŸ¥é“å­˜å‚¨å·çš„è¯¦ç»†ä¿¡æ¯ã€‚

æ­¤å¤„å®šä¹‰åä¸º busybox-deployment çš„éƒ¨ç½² YAML é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨çš„é•œåƒä¸º busyboxã€‚åŸºäº busybox é•œåƒçš„å®¹å™¨éœ€è¦å¯¹ /mnt ç›®å½•ä¸‹çš„æ•°æ®è¿›è¡ŒæŒä¹…åŒ–ï¼Œåœ¨ YAML æ–‡ä»¶æŒ‡å®šä½¿ç”¨åç§°ä¸º nfs çš„ PersistenVolumeClaim å¯¹å®¹å™¨çš„æ•°æ®è¿›è¡ŒæŒä¹…åŒ–ã€‚

```yaml
# This mounts the nfs volume claim into /mnt and continuously
# overwrites /mnt/index.html with the time and hostname of the pod. 
apiVersion: v1
kind: Deployment
metadata:  
  name: busybox-deployment
spec:  
  replicas: 2  
  selector:    
    name: busybox-deployment
  template:    
    metadata:      
      labels:        
        name: busybox-deployment    
    spec:      
      containers:      
      - image: busybox        
        command:          
        - sh          
        - -c          
        - 'while true; do date > /mnt/index.html; hostname >> /mnt/index.html; sleep $(($RANDOM % 5 + 5)); done'        
        imagePullPolicy: IfNotPresent        
        name: busybox        
        volumeMounts:          
        # name must match the volume name below          
        - name: nfs            
          mountPath: "/mnt"     
     volumes:      
     - name: nfs        
       persistentVolumeClaim:          
         claimName: nfs-pvc
```



## å®¹å™¨ç«¯å£

```shell
[root@master ~]# kubectl explain pod.spec.containers.ports
KIND:     Pod
VERSION:  v1

RESOURCE: ports <[]Object>

DESCRIPTION:
     List of ports to expose from the container. Not specifying a port here DOES
     NOT prevent that port from being exposed. Any port which is listening on
     the default "0.0.0.0" address inside a container will be accessible from
     the network. Modifying this array with strategic merge patch may corrupt
     the data. For more information See
     https://github.com/kubernetes/kubernetes/issues/108255. Cannot be updated.

     ContainerPort represents a network port in a single container.

FIELDS:
   containerPort        <integer> -required-
     Number of port to expose on the pod's IP address. This must be a valid port
     number, 0 < x < 65536.

   hostIP       <string>
     What host IP to bind the external port to.

   hostPort     <integer>
     Number of port to expose on the host. If specified, this must be a valid
     port number, 0 < x < 65536. If HostNetwork is specified, this must match
     ContainerPort. Most containers do not need this.

   name <string>
     If specified, this must be an IANA_SVC_NAME and unique within the pod. Each
     named port in a pod must have a unique name. Name for the port that can be
     referred to by services.

   protocol     <string>
     Protocol for port. Must be UDP, TCP, or SCTP. Defaults to "TCP".
     Possible enum values:
     - `"SCTP"` is the SCTP protocol.
     - `"TCP"` is the TCP protocol.
     - `"UDP"` is the UDP protocol.
```

**`ports` å­—æ®µè¯¦è§£**

- `ports` å­—æ®µæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ è¡¨ç¤ºä¸€ä¸ªå®¹å™¨ä¸­éœ€è¦æš´éœ²çš„ç½‘ç»œç«¯å£ã€‚
- ä¸æŒ‡å®šç«¯å£å¹¶ä¸ä¼šé˜»æ­¢è¯¥ç«¯å£è¢«æš´éœ²ã€‚

**å…·ä½“å­—æ®µ**

1. containerPort (`<integer>` - required)
   - æè¿°ï¼šåœ¨ Pod çš„ IP åœ°å€ä¸Šæš´éœ²çš„ç«¯å£å·ã€‚
   - èŒƒå›´ï¼šå¿…é¡»æ˜¯æœ‰æ•ˆçš„ç«¯å£å·ï¼ŒèŒƒå›´æ˜¯ `1` åˆ° `65535`ã€‚
   - ç”¨é€”ï¼šæŒ‡å®šåº”ç”¨ç¨‹åºåœ¨å®¹å™¨å†…ç›‘å¬çš„ç«¯å£ã€‚

2. hostIP (`<string>`)
   - æè¿°ï¼šå°†å®¹å™¨å†…éƒ¨çš„ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºçš„IPåœ°å€å’Œç«¯å£ä¸Šã€‚
   - ç”¨é€”ï¼šè¿™ç§é…ç½®åœ¨æŸäº›ç‰¹å®šçš„åœºæ™¯ä¸‹æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œä¾‹å¦‚éœ€è¦ç›´æ¥ä»å®¿ä¸»æœºè®¿é—®æŸä¸ªå®¹å™¨ä¸­çš„æœåŠ¡æ—¶ã€‚

3. hostPort (`<integer>`)
   - æè¿°ï¼šåœ¨å®¿ä¸»æœºä¸Šæš´éœ²çš„ç«¯å£å·ã€‚
   - èŒƒå›´ï¼šæœ‰æ•ˆç«¯å£å·ï¼ŒèŒƒå›´æ˜¯ `1` åˆ° `65535`ã€‚
   - æ³¨æ„ï¼šå¦‚æœæŒ‡å®šäº† `HostNetwork`ï¼Œé‚£ä¹ˆè¯¥å€¼å¿…é¡»ä¸ `containerPort` åŒ¹é…ã€‚
   
4. name (`<string>`)
   - æè¿°ï¼šä¸ºç«¯å£æŒ‡å®šçš„åç§°ï¼Œå¿…é¡»æ˜¯ IANA æœåŠ¡åç§°å¹¶åœ¨ Pod ä¸­å”¯ä¸€ã€‚
   - ç”¨é€”ï¼šä¾¿äºæœåŠ¡å¼•ç”¨ç«¯å£æ—¶ä½¿ç”¨å‹å¥½çš„åç§°ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨æ•°å­—ç«¯å£å·ã€‚

5. protocol (`<string>`)
   - æè¿°ï¼šç«¯å£ä½¿ç”¨çš„åè®®ã€‚
   - é»˜è®¤å€¼ï¼š`TCP`ï¼Œæ­¤ä¸ºé»˜è®¤åè®®ã€‚
   - å¯èƒ½çš„å€¼ï¼š
     - `"TCP"`ï¼šä¼ è¾“æ§åˆ¶åè®®ï¼Œé€‚ç”¨äºå¤§å¤šæ•°åº”ç”¨ã€‚
     - `"UDP"`ï¼šç”¨æˆ·æ•°æ®æŠ¥åè®®ï¼Œé€‚ç”¨äºéœ€è¦å¿«é€Ÿã€å®æ—¶ä¼ è¾“çš„åº”ç”¨ã€‚
     - `"SCTP"`ï¼šæµæ§åˆ¶ä¼ è¾“åè®®ï¼Œé€‚ç”¨äºéœ€è¦æ¶ˆæ¯æ’åºå’Œå¤šæµä¼ è¾“çš„åº”ç”¨ã€‚

## args

```shell
[root@master ~]# kubectl explain pod.spec.containers.args
KIND:     Pod
VERSION:  v1

FIELD:    args <[]string>

DESCRIPTION:
     Arguments to the entrypoint. The container image's CMD is used if this is
     not provided. Variable references $(VAR_NAME) are expanded using the
     container's environment. If a variable cannot be resolved, the reference in
     the input string will be unchanged. Double $$ are reduced to a single $,
     which allows for escaping the $(VAR_NAME) syntax: i.e. "$$(VAR_NAME)" will
     produce the string literal "$(VAR_NAME)". Escaped references will never be
     expanded, regardless of whether the variable exists or not. Cannot be
     updated. More info:
     https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container/#running-a-command-in-a-shell
```

åœ¨ Kubernetes ä¸­ï¼Œ`args` å­—æ®µç”¨äºä¸ºå®¹å™¨çš„å…¥å£ç‚¹ï¼ˆ`ENTRYPOINT`ï¼‰æä¾›å‚æ•°ã€‚è¿™äº›å‚æ•°å½±å“å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤ï¼Œå’Œ Docker ä¸­çš„ `CMD` ç±»ä¼¼ã€‚åœ¨ `Pod` çš„ `spec.containers` ä¸­é…ç½® `args` å¯ä»¥å¸®åŠ©ä½ ç²¾ç¡®æ§åˆ¶å®¹å™¨çš„è¡Œä¸ºã€‚

1. ä½œç”¨ï¼š`args` æŒ‡å®šè¦ä¼ é€’ç»™å®¹å™¨å…¥å£ç‚¹ï¼ˆ`ENTRYPOINT`ï¼‰çš„å‘½ä»¤è¡Œå‚æ•°ã€‚å¦‚æœæœªæä¾› `args`ï¼Œå®¹å™¨é•œåƒçš„é»˜è®¤ `CMD` å°†è¢«ä½¿ç”¨ã€‚

2. å˜é‡å¼•ç”¨ï¼š`args` æ”¯æŒç¯å¢ƒå˜é‡å¼•ç”¨ï¼Œæ ¼å¼ä¸º `$(VAR_NAME)`ã€‚è¿™äº›å˜é‡å°†åœ¨å®¹å™¨çš„ç¯å¢ƒä¸­è¿›è¡Œè§£æã€‚

3. è½¬ä¹‰æœºåˆ¶ï¼š
   - ä½¿ç”¨åŒ `$` (`$$`) å¯ä»¥è½¬ä¹‰ç¾å…ƒç¬¦å·ã€‚è¿™å¯¹äºæƒ³è¦åœ¨å­—ç¬¦ä¸²ä¸­ä¿æŒå­—é¢ `$(VAR_NAME)` è€Œä¸è¿›è¡Œå˜é‡è§£ææ—¶å¾ˆæœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œ`"$$(VAR_NAME)"` å°†è¢«è§£æä¸ºå­—ç¬¦ä¸²æ–‡å­— `"$(VAR_NAME)"`ã€‚
   - è½¬ä¹‰çš„å¼•ç”¨ä¸ä¼šè¢«è§£æï¼Œå³ä½¿å˜é‡å­˜åœ¨ã€‚

4. ä¸å¯æ›´æ–°ï¼šä¸€æ—¦ Pod åˆ›å»ºï¼Œ`args` å­—æ®µä¸èƒ½è¢«æ›´æ–°ã€‚è¿™æ˜¯å› ä¸ºå®ƒå®šä¹‰äº†å¯åŠ¨æ—¶çš„å®¹å™¨è¡Œä¸ºï¼Œå±äºä¸å¯å˜é…ç½®ã€‚

**ä½¿ç”¨ä¾‹å­**

å‡è®¾ä½ æœ‰ä¸€ä¸ªéœ€è¦å¯åŠ¨æ—¶ä¼ é€’å‚æ•°çš„å®¹å™¨é•œåƒï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: example-pod
spec:
  containers:
  - name: example-container
    image: myapp:latest
    command: ["myapp"]
    args: ["--port", "$(MY_PORT)", "--env", "production"]
    env:
    - name: MY_PORT
      value: "8080"
```

- command: å®šä¹‰äº†å…¥å£ç‚¹å‘½ä»¤ï¼ˆ`ENTRYPOINT`ï¼‰ï¼Œæ­¤å¤„ä¸º `myapp`ã€‚
- args: æä¾›äº†å¯åŠ¨å‚æ•° `--port` å’Œ `--env`ã€‚
  - `$(MY_PORT)` å°†è¢«æ›¿æ¢ä¸ºç¯å¢ƒå˜é‡ `MY_PORT` çš„å€¼ï¼Œå³ `8080`ã€‚
  - `"--env", "production"` ç›´æ¥ä½œä¸ºå‚æ•°ä¼ é€’ã€‚

è¿™ç§é…ç½®æ–¹å¼ä¸ºå®¹å™¨æä¾›äº†çµæ´»çš„å¯åŠ¨é€‰é¡¹ï¼Œä½¿å¾—åŒä¸€é•œåƒå¯ä»¥åœ¨ä¸åŒåœºæ™¯ä¸‹ä½¿ç”¨ä¸åŒçš„é…ç½®è¿è¡Œï¼Œå¢å¼ºäº†åº”ç”¨çš„é€‚åº”èƒ½åŠ›å’Œå¯ç§»æ¤æ€§ã€‚

## command

```shell
[root@master ~]# kubectl explain pod.spec.containers.command
KIND:     Pod
VERSION:  v1

FIELD:    command <[]string>

DESCRIPTION:
     Entrypoint array. Not executed within a shell. The container image's
     ENTRYPOINT is used if this is not provided. Variable references $(VAR_NAME)
     are expanded using the container's environment. If a variable cannot be
     resolved, the reference in the input string will be unchanged. Double $$
     are reduced to a single $, which allows for escaping the $(VAR_NAME)
     syntax: i.e. "$$(VAR_NAME)" will produce the string literal "$(VAR_NAME)".
     Escaped references will never be expanded, regardless of whether the
     variable exists or not. Cannot be updated. More info:
     https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container/#running-a-command-in-a-shell
```

åœ¨ Kubernetes ä¸­ï¼Œ`command` å­—æ®µç”¨äºæŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤ï¼Œè¿™ä¸ªå­—æ®µç›¸å½“äºå®¹å™¨é•œåƒä¸­çš„ `ENTRYPOINT`ã€‚é€šè¿‡é…ç½® `command`ï¼Œä½ å¯ä»¥æ›¿æ¢é•œåƒä¸­çš„é»˜è®¤å¯åŠ¨å‘½ä»¤ï¼Œä»è€Œçµæ´»æ§åˆ¶å®¹å™¨çš„å¯åŠ¨è¡Œä¸ºã€‚

1. ä½œç”¨ï¼š`command` å­—æ®µæŒ‡å®šäº†å®¹å™¨çš„å…¥å£ç‚¹å‘½ä»¤ï¼ˆENTRYPOINTï¼‰ã€‚å¦‚æœæœªæä¾› `command`ï¼Œåˆ™ä½¿ç”¨é•œåƒçš„é»˜è®¤ `ENTRYPOINT`ã€‚

2. æ‰§è¡Œè¡Œä¸ºï¼š`command` çš„å†…å®¹ä½œä¸ºæ•°ç»„æä¾›ï¼Œè¡¨ç¤ºè¦æ‰§è¡Œçš„å‘½ä»¤åŠå…¶å„ä¸ªéƒ¨åˆ†ã€‚è¿™äº›å‘½ä»¤ä¸æ˜¯åœ¨ Shell ä¸­æ‰§è¡Œçš„ï¼Œå› æ­¤ä¸åƒåœ¨ Shell ä¸­è¾“å…¥å‘½ä»¤é‚£æ ·å¯ä»¥ä½¿ç”¨ Shell ç‰¹æ€§ã€‚

3. å˜é‡å¼•ç”¨ï¼šæ”¯æŒç¯å¢ƒå˜é‡å¼•ç”¨ï¼Œæ ¼å¼ä¸º `$(VAR_NAME)`ã€‚è¿™äº›å˜é‡ä¼šåŸºäºå®¹å™¨ä¸­çš„ç¯å¢ƒå˜é‡è¿›è¡Œæ›¿æ¢ã€‚

4. è½¬ä¹‰æœºåˆ¶ï¼š
   - ä½¿ç”¨åŒ `$` (`$$`) å¯ä»¥è½¬ä¹‰ç¾å…ƒç¬¦å·ï¼Œä»¥ä¾¿åœ¨å­—ç¬¦ä¸²ä¸­ä¿æŒå­—é¢ `$(VAR_NAME)`ï¼Œä¸è¿›è¡Œå˜é‡è§£æã€‚ä¾‹å¦‚ï¼Œ`"$$(VAR_NAME)"` å°†è§£æä¸ºå­—ç¬¦ä¸²æ–‡å­— `"$(VAR_NAME)"`ã€‚
   - è½¬ä¹‰çš„å˜é‡å¼•ç”¨ä¸ä¼šè¢«è§£æï¼Œå³ä½¿å˜é‡å­˜åœ¨ã€‚

5. ä¸å¯æ›´æ–°ï¼šä¸€æ—¦ Pod è¢«åˆ›å»ºï¼Œ`command` å­—æ®µä¸èƒ½è¢«æ›´æ–°ï¼Œå› ä¸ºå®ƒå®šä¹‰äº†å®¹å™¨çš„å¯åŠ¨è¡Œä¸ºã€‚

**ä½¿ç”¨ä¾‹å­**

å‡è®¾ä½ æœ‰ä¸€ä¸ªå®¹å™¨é•œåƒï¼Œé»˜è®¤çš„å…¥å£ç‚¹æ˜¯ `/bin/bash`ï¼Œä½†ä½ å¸Œæœ›ä½¿ç”¨ä¸åŒçš„å¯åŠ¨å‘½ä»¤ï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: example-pod
spec:
  containers:
  - name: example-container
    image: myapp:latest
    command: ["/myapp"]
    args: ["--port", "$(MY_PORT)", "--env", "production"]
    env:
    - name: MY_PORT
      value: "8080"
```

- command: æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤ä¸º `/myapp`ï¼Œè¿™å°†æ›¿æ¢é•œåƒä¸­çš„é»˜è®¤ `ENTRYPOINT`ã€‚
- args: æä¾›å‘½ä»¤è¡Œå‚æ•° `--port` å’Œ `--env`ï¼Œå…¶ä¸­ `$(MY_PORT)` å°†è¢«æ›¿æ¢ä¸ºç¯å¢ƒå˜é‡ `MY_PORT` çš„å€¼ï¼ˆå³ `8080`ï¼‰ã€‚

## env

```shell
[root@master ~]# kubectl explain pod.spec.containers.env
KIND:     Pod
VERSION:  v1

RESOURCE: env <[]Object>

DESCRIPTION:
     List of environment variables to set in the container. Cannot be updated.

     EnvVar represents an environment variable present in a Container.

FIELDS:
   name <string> -required-
     Name of the environment variable. Must be a C_IDENTIFIER.

   value        <string>
     Variable references $(VAR_NAME) are expanded using the previously defined
     environment variables in the container and any service environment
     variables. If a variable cannot be resolved, the reference in the input
     string will be unchanged. Double $$ are reduced to a single $, which allows
     for escaping the $(VAR_NAME) syntax: i.e. "$$(VAR_NAME)" will produce the
     string literal "$(VAR_NAME)". Escaped references will never be expanded,
     regardless of whether the variable exists or not. Defaults to "".

   valueFrom    <Object>
     Source for the environment variable's value. Cannot be used if value is not
     empty.
```

åœ¨ Kubernetes ä¸­ï¼Œ`env` å­—æ®µç”¨äºåœ¨å®¹å™¨ä¸­è®¾ç½®ç¯å¢ƒå˜é‡ã€‚è¿™äº›ç¯å¢ƒå˜é‡å¯ä»¥ç”¨äºé…ç½®åº”ç”¨ç¨‹åºçš„è¿è¡Œæ—¶è¡Œä¸ºï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€API å¯†é’¥æˆ–å…¶ä»–éœ€è¦åœ¨å®¹å™¨å¯åŠ¨æ—¶é…ç½®çš„ä¿¡æ¯ã€‚

1. ä½œç”¨ï¼š`env` æ˜¯ä¸€ä¸ªç¯å¢ƒå˜é‡åˆ—è¡¨ï¼Œç”¨äºåœ¨å®¹å™¨å¯åŠ¨æ—¶æ³¨å…¥å¿…è¦çš„é…ç½®ä¿¡æ¯ã€‚ç¯å¢ƒå˜é‡åœ¨å®¹å™¨å†…çš„åº”ç”¨ç¨‹åºä¸­å¯ä»¥é€šè¿‡æ ‡å‡†çš„æ–¹å¼ï¼ˆå¦‚åœ¨å¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€ä¸­é€šè¿‡ç¯å¢ƒå˜é‡æ¥å£ï¼‰è¿›è¡Œè®¿é—®ã€‚

2. ä¸å¯æ›´æ–°ï¼šä¸€æ—¦ Pod åˆ›å»ºåï¼Œ`env` åˆ—è¡¨æ˜¯ä¸å¯æ›´æ–°çš„ã€‚è¿™æ˜¯å› ä¸ºç¯å¢ƒå˜é‡åœ¨å®¹å™¨å¯åŠ¨æ—¶æ³¨å…¥ï¼Œæ”¹å˜å®ƒä»¬æ„å‘³ç€éœ€è¦é‡å¯å®¹å™¨ã€‚

**å…·ä½“å­—æ®µ**

1. name (`<string>` - required)ï¼š
   - æè¿°ï¼šç¯å¢ƒå˜é‡çš„åç§°ï¼Œå¿…é¡»æ˜¯ç¬¦åˆ C æ ‡è¯†ç¬¦å‘½åè§„èŒƒçš„å­—ç¬¦ä¸²ã€‚
   - ç”¨é€”ï¼šä»£è¡¨åœ¨å®¹å™¨å†…åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„å˜é‡æ ‡è¯†ç¬¦ã€‚

2. value (`<string>`)ï¼š
   - æè¿°ï¼šç¯å¢ƒå˜é‡çš„å€¼ï¼Œå¯ä»¥åŒ…å«å¯¹å…¶ä»–ç¯å¢ƒå˜é‡çš„å¼•ç”¨ã€‚
   - é»˜è®¤å€¼ï¼šå¦‚æœä¸è®¾ç½®ï¼Œé»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²ã€‚

3. valueFrom (`<Object>`)ï¼š
   - æè¿°ï¼šç”¨äºä»å…¶ä»–æ¥æºè·å–ç¯å¢ƒå˜é‡çš„å€¼ã€‚
   - ç”¨é€”ï¼šæä¾›ä¸€ç§åŠ¨æ€å®šä¹‰ç¯å¢ƒå˜é‡çš„æ–¹æ³•ï¼Œå¯ä»¥ä» Kubernetes èµ„æºä¸­æå–ç¯å¢ƒå˜é‡å€¼ã€‚
   - æ³¨æ„ï¼š`valueFrom` ä¸èƒ½ä¸ `value` ä¸€èµ·ä½¿ç”¨ã€‚

`valueFrom` çš„å¸¸è§ç”¨æ³•

- ConfigMapKeyRefï¼šä» ConfigMap ä¸­è·å–å€¼ã€‚
- SecretKeyRefï¼šä» Secret ä¸­è·å–å€¼ã€‚
- FieldRefï¼šå¼•ç”¨ Pod å­—æ®µï¼ˆå¦‚ Pod åç§°ã€å‘½åç©ºé—´ç­‰ï¼‰ã€‚
- ResourceFieldRefï¼šä»èµ„æºè¯·æ±‚å’Œé™åˆ¶ä¸­è·å–å€¼ã€‚

**ç¤ºä¾‹**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: example-pod
spec:
  containers:
  - name: example-container
    image: myapp:latest
    env:
    - name: MY_ENV_VAR
      value: "some_value"
    - name: MY_DB_HOST
      valueFrom:
        configMapKeyRef:
          name: my-config
          key: database_host
    - name: MY_SECRET_KEY
      valueFrom:
        secretKeyRef:
          name: my-secret
          key: api_key
```

- MY_ENV_VARï¼šç›´æ¥è®¾ç½®ä¸º `"some_value"`ã€‚
- MY_DB_HOSTï¼šä»åä¸º `my-config` çš„ ConfigMap ä¸­è·å– `database_host` é”®çš„å€¼ã€‚
- MY_SECRET_KEYï¼šä»åä¸º `my-secret` çš„ Secret ä¸­è·å– `api_key` é”®çš„å€¼ã€‚

é€šè¿‡åˆç†è®¾ç½® `env` å­—æ®µï¼Œä½ å¯ä»¥ä½¿ Kubernetes ä¸­çš„åº”ç”¨æ›´çµæ´»ã€å¯é…ç½®ï¼Œå¹¶èƒ½å¤Ÿæ ¹æ®ä¸åŒçš„ç¯å¢ƒéœ€æ±‚åŠ¨æ€è°ƒæ•´ã€‚

## envFrom

`envFrom` å­—æ®µç”¨äºä»å¤šä¸ªæ¥æºå¡«å……å®¹å™¨çš„ç¯å¢ƒå˜é‡ã€‚å®šä¹‰åœ¨æ¥æºä¸­çš„é”®å¿…é¡»æ˜¯æœ‰æ•ˆçš„ C æ ‡è¯†ç¬¦ï¼ˆå­—æ¯/ä¸‹åˆ’çº¿å¼€å¤´ï¼Œä»…å«å­—æ¯æ•°å­—ä¸‹åˆ’çº¿ï¼‰ã€‚å¦‚æœå­˜åœ¨æ— æ•ˆçš„é”®ï¼Œå½“å®¹å™¨å¯åŠ¨æ—¶ä¼šæŠ¥å‘Šç›¸åº”çš„äº‹ä»¶ã€‚å¦‚æœåŒä¸€ä¸ªé”®åœ¨å¤šä¸ªæ¥æºä¸­å®šä¹‰ï¼Œæœ€åä¸€ä¸ªæ¥æºä¸­çš„å€¼å°†ä¼˜å…ˆã€‚å¦‚æœé€šè¿‡ `env` å­—æ®µå®šä¹‰äº†ç›¸åŒçš„é”®ï¼Œ`env` å­—æ®µä¸­çš„å€¼å°†ä¼˜å…ˆã€‚`envFrom` å­—æ®µä¸èƒ½è¢«æ›´æ–°ã€‚

1. **configMapRef** (`<Object>`)ï¼šæŒ‡å®šè¦é€‰æ‹©çš„ `ConfigMap`
   - name (`<string>`): `ConfigMap` çš„åç§°ï¼Œå¿…é¡»æŒ‡å®šã€‚
   - optional (`<boolean>`): æŒ‡å®šè¯¥ ConfigMap æ˜¯å¦å¿…é¡»å­˜åœ¨
2. **prefix** (`<string>`)
   - æè¿°: å¯é€‰çš„æ ‡è¯†ç¬¦ï¼Œç”¨äºä» `ConfigMap` ä¸­è·å–çš„é”®å‰é¢æ·»åŠ å‰ç¼€ã€‚å¿…é¡»æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ C æ ‡è¯†ç¬¦ã€‚
   - ç¤ºä¾‹: å¦‚æœ `prefix` è®¾ç½®ä¸º `MY_APP_`ï¼Œåˆ™ `ConfigMap` ä¸­çš„é”® `LOG_LEVEL` å°†å˜ä¸º `MY_APP_LOG_LEVEL`ã€‚
3. **secretRef** (`<Object>`)ï¼šæŒ‡å®šè¦é€‰æ‹©çš„ `Secret`
   - name (`<string>`): `Secret` çš„åç§°ï¼Œå¿…é¡»æŒ‡å®šã€‚
   - optional (`<boolean>`): å¦‚æœè®¾ç½®ä¸º `true`ï¼Œå¹¶ä¸” `Secret` ä¸å­˜åœ¨ï¼Œåˆ™ä¸ä¼šæŠ¥é”™ï¼Œè€Œæ˜¯å¿½ç•¥è¯¥ `Secret`ã€‚é»˜è®¤å€¼ä¸º `false`ã€‚

**å‰ç¼€ä½¿ç”¨ - é¿å…å‘½åå†²çª**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: prefixed-env-pod
spec:
  containers:
  - name: app-container
    image: node:18
    envFrom:
    - configMapRef:
        name: common-config
        prefix: "MAIN_"
    - configMapRef:
        name: plugin-config
        prefix: "PLUGIN_"
    env:
    - name: LOG_LEVEL
      value: "debug"
```

å˜é‡è½¬æ¢æ•ˆæœï¼š

|     æ¥æº      |     æ¥æºé”®     |  æœ€ç»ˆå®¹å™¨ç¯å¢ƒå˜é‡å   |
| :-----------: | :------------: | :-------------------: |
| common-config |   LOG_LEVEL    |    MAIN_LOG_LEVEL     |
| common-config |    TIMEOUT     |     MAIN_TIMEOUT      |
| plugin-config |   LOG_LEVEL    |   PLUGIN_LOG_LEVEL    |
| plugin-config | PLUGIN_ENABLED | PLUGIN_PLUGIN_ENABLED |
|  `env` å­—æ®µ   |   LOG_LEVEL    |       LOG_LEVEL       |

> ğŸ’¡ æ³¨æ„ï¼šå‰ç¼€éœ€ç¬¦åˆ C æ ‡è¯†ç¬¦è§„èŒƒï¼ˆå­—æ¯/ä¸‹åˆ’çº¿å¼€å¤´ï¼Œä»…å«å­—æ¯æ•°å­—ä¸‹åˆ’çº¿ï¼‰

**ä¼˜å…ˆçº§è¦†ç›–æ¼”ç¤º**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: override-demo-pod
spec:
  containers:
  - name: demo-container
    image: busybox
    command: ["/bin/sh", "-c", "env; sleep 3600"]
    envFrom:
    - configMapRef:
        name: base-config    # åŒ…å« DATABASE_URL=base.db
    - secretRef:
        name: secret-config  # åŒ…å« DATABASE_URL=secret.db
    env:
    - name: DATABASE_URL     # æ˜¾å¼è¦†ç›–
      value: "override.db"
```

æœ€ç»ˆç¯å¢ƒå˜é‡å€¼ï¼š

```
DATABASE_URL=override.db  # env å­—æ®µä¼˜å…ˆçº§æœ€é«˜
```

è¦†ç›–é¡ºåºè¯´æ˜ï¼š

1. `base-config` ConfigMap è®¾ç½®åˆå§‹å€¼
2. `secret-config` Secret è¦†ç›–åŒåå˜é‡
3. `env` å­—æ®µæœ€ç»ˆè¦†ç›–æ‰€æœ‰åŒåå˜é‡



## å¦‚ä½•åˆ’åˆ† Pod

ä¸Šé¢ä»‹ç»äº† Pod çš„å®ç°åŸç†ï¼Œäº†è§£åˆ°åº”è¯¥æŠŠå…³ç³»ç´§å¯†çš„å®¹å™¨åˆ’åˆ†åˆ°åŒä¸€ä¸ª Pod ä¸­è¿è¡Œï¼Œé‚£ä¹ˆæ€ä¹ˆæ¥åŒºåˆ†â€œå…³ç³»ç´§å¯†â€å‘¢ï¼Ÿä¸¾ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œæ¯”å¦‚ Wordpress åº”ç”¨ï¼Œæ˜¯ä¸€ä¸ªå…¸å‹çš„å‰ç«¯æœåŠ¡å™¨å’Œåç«¯æ•°æ®æœåŠ¡çš„åº”ç”¨ï¼Œé‚£ä¹ˆä½ è®¤ä¸ºåº”è¯¥ä½¿ç”¨ä¸€ä¸ª Pod è¿˜æ˜¯ä¸¤ä¸ª Pod å‘¢ï¼Ÿ

å¦‚æœåœ¨åŒä¸€ä¸ª Pod ä¸­åŒæ—¶è¿è¡ŒæœåŠ¡å™¨ç¨‹åºå’Œåç«¯çš„æ•°æ®åº“æœåŠ¡è¿™ä¸¤ä¸ªå®¹å™¨ï¼Œç†è®ºä¸Šè‚¯å®šæ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯ä¸æ¨èè¿™æ ·ä½¿ç”¨ï¼Œæˆ‘ä»¬çŸ¥é“ä¸€ä¸ª Pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½æ˜¯åŒä¸€ä¸ªæ•´ä½“è¿›è¡Œè°ƒåº¦çš„ï¼Œä½†æ˜¯å¯¹äºæˆ‘ä»¬è¿™ä¸ªåº”ç”¨ Wordpress å’Œ MySQL æ•°æ®åº“ä¸€å®šéœ€è¦è¿è¡Œåœ¨ä¸€èµ·å—ï¼Ÿå½“ç„¶ä¸éœ€è¦ï¼Œç”šè‡³å¯ä»¥å°† MySQL éƒ¨ç½²åˆ°é›†ç¾¤ä¹‹å¤–å¯¹å§ï¼Ÿæ‰€ä»¥ Wordpress å’Œ MySQL å³ä½¿ä¸è¿è¡Œåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šä¹Ÿæ˜¯å¯è¡Œçš„ï¼Œåªè¦èƒ½å¤Ÿè®¿é—®åˆ°å³å¯ã€‚

<img src="image/2024-04-01-17-47-17.png" style="zoom:50%;" />

ä½†æ˜¯å¦‚æœä½ éè¦å¼ºè¡Œéƒ¨ç½²åˆ°åŒä¸€ä¸ª Pod ä¸­å‘¢ï¼Ÿä»æŸä¸ªè§’åº¦æ¥è¯´æ˜¯é”™è¯¯çš„ï¼Œæ¯”å¦‚ç°åœ¨åº”ç”¨è®¿é—®é‡éå¸¸å¤§ï¼Œä¸€ä¸ª Pod å·²ç»æ»¡è¶³ä¸äº†éœ€æ±‚äº†ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿæ‰©å®¹å¯¹å§ï¼Œä½†æ˜¯æ‰©å®¹çš„ç›®æ ‡ä¹Ÿæ˜¯ Podï¼Œå¹¶ä¸æ˜¯å®¹å™¨ï¼Œæ¯”å¦‚å†æ·»åŠ ä¸€ä¸ª Podï¼Œè¿™ä¸ªæ—¶å€™å°±æœ‰ä¸¤ä¸ª Wordpress çš„åº”ç”¨å’Œä¸¤ä¸ª MySQL æ•°æ®åº“äº†ï¼Œè€Œä¸”è¿™ä¸¤ä¸ª Pod ä¹‹é—´çš„æ•°æ®æ˜¯äº’ç›¸ç‹¬ç«‹çš„ï¼Œå› ä¸º MySQL æ•°æ®åº“å¹¶ä¸æ˜¯ç®€å•çš„å¢åŠ å‰¯æœ¬å°±å¯ä»¥å…±äº«æ•°æ®äº†ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™å°±å¾—åˆ†å¼€éƒ¨ç½²ï¼Œé‡‡ç”¨ç¬¬äºŒç§æ–¹æ¡ˆã€‚è¿™ä¸ªæ—¶å€™åªéœ€è¦å•ç‹¬æ‰©å®¹ Wordpress è¿™ä¸ª Podï¼Œåç«¯çš„ MySQL æ•°æ®åº“å¹¶ä¸ä¼šå—åˆ°æ‰©å®¹çš„å½±å“ã€‚

<img src="image/2024-04-01-17-47-31.png" alt="img" style="zoom: 33%;" />

å°†å¤šä¸ªå®¹å™¨éƒ¨ç½²åˆ°åŒä¸€ä¸ª Pod ä¸­çš„æœ€ä¸»è¦å‚è€ƒå°±æ˜¯åº”ç”¨å¯èƒ½ç”±ä¸€ä¸ªä¸»è¿›ç¨‹å’Œä¸€ä¸ªæˆ–å¤šä¸ªçš„è¾…åŠ©è¿›ç¨‹ç»„æˆï¼Œæ¯”å¦‚ä¸Šé¢æ—¥å¿—æ”¶é›†çš„ Podï¼Œéœ€è¦å…¶ä»–çš„ sidecar å®¹å™¨æ¥æ”¯æŒæ—¥å¿—çš„é‡‡é›†ã€‚æ‰€ä»¥åˆ¤æ–­æ˜¯å¦éœ€è¦åœ¨ Pod ä¸­ä½¿ç”¨å¤šä¸ªå®¹å™¨çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‰ç…§å¦‚ä¸‹çš„å‡ ä¸ªæ–¹å¼æ¥åˆ¤æ–­ï¼š

* è¿™äº›å®¹å™¨æ˜¯å¦ä¸€å®šéœ€è¦ä¸€èµ·è¿è¡Œï¼Œæ˜¯å¦å¯ä»¥è¿è¡Œåœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Š
* è¿™äº›å®¹å™¨æ˜¯ä¸€ä¸ªæ•´ä½“è¿˜æ˜¯ç‹¬ç«‹çš„ç»„ä»¶
* è¿™äº›å®¹å™¨ä¸€èµ·è¿›è¡Œæ‰©ç¼©å®¹ä¼šå½±å“åº”ç”¨å—

åŸºæœ¬ä¸Šèƒ½å¤Ÿå›ç­”ä¸Šé¢çš„å‡ ä¸ªé—®é¢˜å°±èƒ½å¤Ÿåˆ¤æ–­æ˜¯å¦éœ€è¦åœ¨ Pod ä¸­è¿è¡Œå¤šä¸ªå®¹å™¨äº†ã€‚

> å…¶å®åœ¨ç†è§£ Pod çš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªæ¯”è¾ƒå¥½çš„ç±»æ¯”çš„æ–¹å¼å°±æ˜¯æŠŠ Pod çœ‹æˆä¹‹å‰çš„ â€œè™šæ‹Ÿæœºâ€ï¼Œè€Œå®¹å™¨å°±æ˜¯è™šæ‹Ÿæœºä¸­è¿è¡Œçš„ä¸€ä¸ªç”¨æˆ·ç¨‹åºï¼Œè¿™æ ·å°±å¯ä»¥å¾ˆå¥½çš„æ¥ç†è§£ Pod çš„è®¾è®¡ã€‚
