# RBAC æƒé™æ§åˆ¶
å‰é¢å·²ç»å­¦ä¹ ä¸€äº›å¸¸ç”¨çš„èµ„æºå¯¹è±¡çš„ä½¿ç”¨ï¼Œå¯¹äºèµ„æºå¯¹è±¡çš„æ“ä½œéƒ½æ˜¯é€šè¿‡ APIServer è¿›è¡Œçš„ï¼Œé‚£ä¹ˆé›†ç¾¤æ˜¯æ€æ ·çŸ¥é“æˆ‘ä»¬çš„è¯·æ±‚å°±æ˜¯åˆæ³•çš„è¯·æ±‚å‘¢ï¼Ÿè¿™ä¸ªå°±éœ€è¦äº†è§£ Kubernetes ä¸­å¦å¤–ä¸€ä¸ªéå¸¸é‡è¦çš„çŸ¥è¯†ç‚¹äº†ï¼šRBACï¼ˆåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ï¼‰ã€‚

ç®¡ç†å‘˜å¯ä»¥é€šè¿‡ Kubernetes API åŠ¨æ€é…ç½®ç­–ç•¥æ¥å¯ç”¨ RBACï¼Œéœ€è¦åœ¨ `kube-apiserver` ä¸­æ·»åŠ å‚æ•° `--authorization-mode=RBAC`ï¼Œå¦‚æœä½¿ç”¨çš„ kubeadm å®‰è£…çš„é›†ç¾¤é‚£ä¹ˆæ˜¯é»˜è®¤å¼€å¯äº† RBAC çš„ï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹ Master èŠ‚ç‚¹ä¸Š apiserver çš„é™æ€ Pod å®šä¹‰æ–‡ä»¶ï¼š
```sh
âœ  ~ cat /etc/kubernetes/manifests/kube-apiserver.yaml
...
    - --authorization-mode=Node,RBAC
...
```
# API å¯¹è±¡
åœ¨å­¦ä¹  RBAC ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å†å»ç†è§£ä¸‹ Kubernetes é›†ç¾¤ä¸­çš„å¯¹è±¡ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ Kubernetes é›†ç¾¤ä¸­ï¼ŒKubernetes å¯¹è±¡æ˜¯æˆ‘ä»¬æŒä¹…åŒ–çš„å®ä½“ï¼Œå°±æ˜¯æœ€ç»ˆå­˜å…¥ etcd ä¸­çš„æ•°æ®ï¼Œé›†ç¾¤ä¸­é€šè¿‡è¿™äº›å®ä½“æ¥è¡¨ç¤ºæ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ã€‚å‰é¢æˆ‘ä»¬éƒ½ç›´æ¥ç¼–å†™çš„ YAML æ–‡ä»¶ï¼Œé€šè¿‡ kubectl æ¥æäº¤çš„èµ„æºæ¸…å•æ–‡ä»¶ï¼Œç„¶ååˆ›å»ºå¯¹åº”çš„èµ„æºå¯¹è±¡ï¼Œé‚£ä¹ˆå®ƒç©¶ç«Ÿæ˜¯å¦‚ä½•å°†æˆ‘ä»¬çš„ YAML æ–‡ä»¶è½¬æ¢æˆé›†ç¾¤ä¸­çš„ä¸€ä¸ª API å¯¹è±¡çš„å‘¢ï¼Ÿ

è¿™å°±éœ€è¦å»äº†è§£ä¸‹å£°æ˜å¼ APIçš„è®¾è®¡ï¼ŒKubernetes API æ˜¯ä¸€ä¸ªä»¥ JSON ä¸ºä¸»è¦åºåˆ—åŒ–æ–¹å¼çš„ HTTP æœåŠ¡ï¼Œé™¤æ­¤ä¹‹å¤–ä¹Ÿæ”¯æŒ Protocol Buffers åºåˆ—åŒ–æ–¹å¼ï¼Œä¸»è¦ç”¨äºé›†ç¾¤å†…éƒ¨ç»„ä»¶é—´çš„é€šä¿¡ã€‚ä¸ºäº†å¯æ‰©å±•æ€§ï¼ŒKubernetes åœ¨ä¸åŒçš„ API è·¯å¾„ï¼ˆæ¯”å¦‚/api/v1 æˆ–è€… /apis/batchï¼‰ä¸‹é¢æ”¯æŒäº†å¤šä¸ª API ç‰ˆæœ¬ï¼Œä¸åŒçš„ API ç‰ˆæœ¬æ„å‘³ç€ä¸åŒçº§åˆ«çš„ç¨³å®šæ€§å’Œæ”¯æŒï¼š
- Alpha çº§åˆ«ï¼Œä¾‹å¦‚ v1alpha1 é»˜è®¤æƒ…å†µä¸‹æ˜¯è¢«ç¦ç”¨çš„ï¼Œå¯ä»¥éšæ—¶åˆ é™¤å¯¹åŠŸèƒ½çš„æ”¯æŒï¼Œæ‰€ä»¥è¦æ…ç”¨ã€‚
- Beta çº§åˆ«ï¼Œä¾‹å¦‚ v2beta1 é»˜è®¤æƒ…å†µä¸‹æ˜¯å¯ç”¨çš„ï¼Œè¡¨ç¤ºä»£ç å·²ç»ç»è¿‡äº†å¾ˆå¥½çš„æµ‹è¯•ï¼Œä½†æ˜¯å¯¹è±¡çš„è¯­ä¹‰å¯èƒ½ä¼šåœ¨éšåçš„ç‰ˆæœ¬ä¸­ä»¥ä¸å…¼å®¹çš„æ–¹å¼æ›´æ”¹ã€‚
- ç¨³å®šçº§åˆ«ï¼Œæ¯”å¦‚ v1 è¡¨ç¤ºå·²ç»æ˜¯ç¨³å®šç‰ˆæœ¬äº†ï¼Œä¹Ÿä¼šå‡ºç°åœ¨åç»­çš„å¾ˆå¤šç‰ˆæœ¬ä¸­ã€‚

åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œä¸€ä¸ª API å¯¹è±¡åœ¨ Etcd é‡Œçš„å®Œæ•´èµ„æºè·¯å¾„ï¼Œæ˜¯ç”±ï¼šGroupï¼ˆAPI ç»„ï¼‰ã€Versionï¼ˆAPI ç‰ˆæœ¬ï¼‰å’Œ Resourceï¼ˆAPI èµ„æºç±»å‹ï¼‰ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆçš„ã€‚é€šè¿‡è¿™æ ·çš„ç»“æ„ï¼Œæ•´ä¸ª Kubernetes é‡Œçš„æ‰€æœ‰ API å¯¹è±¡ï¼Œå®é™…ä¸Šå°±å¯ä»¥ç”¨å¦‚ä¸‹çš„æ ‘å½¢ç»“æ„è¡¨ç¤ºå‡ºæ¥ï¼š

![](image/2024-03-01-11-19-01.png)

ä»ä¸Šå›¾ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡º Kubernetes çš„ API å¯¹è±¡çš„ç»„ç»‡æ–¹å¼ï¼Œåœ¨é¡¶å±‚ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªæ ¸å¿ƒç»„ï¼ˆç”±äºå†å²åŸå› ï¼Œæ˜¯ /api/v1 ä¸‹çš„æ‰€æœ‰å†…å®¹è€Œä¸æ˜¯åœ¨ /api/core/v1 ä¸‹é¢ï¼‰å’Œå‘½åç»„ï¼ˆè·¯å¾„ /apis/$NAME/$VERSIONï¼‰å’Œç³»ç»ŸèŒƒå›´å†…çš„å®ä½“ï¼Œæ¯”å¦‚ /metricsã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥æŸ¥çœ‹é›†ç¾¤ä¸­çš„ API ç»„ç»‡å½¢å¼ï¼š
```sh
[root@master yamlDir]# kubectl get --raw /
{
  "paths": [
    "/.well-known/openid-configuration",
    "/api",
    "/api/v1",
    "/apis",
    "/apis/",
    "/apis/admissionregistration.k8s.io",
    "/apis/admissionregistration.k8s.io/v1",
    "/apis/apiextensions.k8s.io",
    "/apis/apiextensions.k8s.io/v1",
    "/apis/apiregistration.k8s.io",
    "/apis/apiregistration.k8s.io/v1",
    "/apis/apps",
...
```
é€šå¸¸ï¼ŒKubernetes API æ”¯æŒé€šè¿‡æ ‡å‡† HTTP POSTã€PUTã€DELETE å’Œ GET åœ¨æŒ‡å®š PATH è·¯å¾„ä¸Šåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤å’Œæ£€ç´¢æ“ä½œï¼Œå¹¶ä½¿ç”¨ JSON ä½œä¸ºé»˜è®¤çš„æ•°æ®äº¤äº’æ ¼å¼ã€‚

## GVK
æˆ‘ä»¬çŸ¥é“è¦è¡¨è¾¾ä¸€ä¸ªèµ„æºå¯¹è±¡éœ€è¦æŒ‡å®š group/kind å’Œ versionï¼Œè¿™ä¸ªåœ¨ Kubernetes çš„ API Server ä¸­ç®€ç§°ä¸º GVKï¼ŒGVK æ˜¯å®šä½ä¸€ç§ç±»å‹çš„æ–¹å¼ï¼Œä¾‹å¦‚ daemonsets å°±æ˜¯ Kubernetes ä¸­çš„ä¸€ç§èµ„æºï¼Œå½“æˆ‘ä»¬è·Ÿ Kubernetes è¯´æˆ‘æƒ³è¦åˆ›å»ºä¸€ä¸ª daemonsets çš„æ—¶å€™ï¼Œkubectl æ˜¯å¦‚ä½•çŸ¥é“è¯¥æ€ä¹ˆå‘ API Server å‘é€è¯·æ±‚å‘¢ï¼Ÿæ˜¯æ‰€æœ‰çš„ä¸åŒèµ„æºéƒ½å‘å‘åŒä¸€ä¸ª Endpointï¼Œè¿˜æ˜¯æ¯ç§èµ„æºéƒ½æ˜¯ä¸åŒçš„ï¼Ÿ

æˆ‘ä»¬å›é¡¾ä¸‹å®šä¹‰çš„ daemonsets çš„èµ„æºæ¸…å•æ–‡ä»¶ï¼š
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-exporter
  namespace: kube-system
spec:
# ......
```
è¿™é‡Œå£°æ˜çš„ apiVersion æ˜¯ apps/v1ï¼Œå…¶å®å°±æ˜¯éšå«äº† Group æ˜¯ appsï¼ŒVersion æ˜¯ v1ï¼ŒKind å°±æ˜¯å®šä¹‰çš„ DaemonSetï¼Œè€Œ kubectl æ¥æ”¶åˆ°è¿™ä¸ªæ¸…å•ä¹‹åï¼Œå°±å¯ä»¥æ ¹æ®è¿™ä¸ªå£°æ˜å»è°ƒç”¨ API Server å¯¹åº”çš„ URL å»è·å–ä¿¡æ¯ï¼Œä¾‹å¦‚è¿™é‡Œå°±æ˜¯ /apis/apps/v1/daemonsetã€‚æ‰€ä»¥æˆ‘ä»¬è¯´ Kubernetes ç»„ç»‡èµ„æºçš„æ–¹å¼æ˜¯ä»¥ REST çš„ URI çš„å½¢å¼æ¥çš„ï¼Œè€Œç»„ç»‡çš„è·¯å¾„å°±æ˜¯ï¼š

![](image/2024-03-01-11-34-26.png)

æˆ‘ä»¬è¿™é‡Œä¸æ˜¯è¯´æ˜¯ G(roup)V(ersion)K(ind) å—ï¼Œæ€ä¹ˆç°åœ¨åˆå˜æˆäº† G(roup)V(ersion)R(esource) ï¼Ÿè¿™å°±æ˜¯ API Server ä¸­çš„ç¬¬äºŒä¸ªæ¦‚å¿µï¼šGVRã€‚

## GVR
ç†è§£äº† GVK ä¹‹åå†ç†è§£ GVR å°±å¾ˆå®¹æ˜“äº†ï¼Œè¿™å°±æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹é‡Œé¢çš„ç±»å’Œå¯¹è±¡çš„æ¦‚å¿µæ˜¯ä¸€æ ·çš„ï¼š

![](image/2024-03-01-11-35-05.png)

Kind å…¶å®å°±æ˜¯ä¸€ä¸ªç±»ï¼Œç”¨äºæè¿°å¯¹è±¡çš„ï¼›è€Œ Resource å°±æ˜¯å…·ä½“çš„ Kindï¼Œå¯ä»¥ç†è§£æˆç±»å·²ç»å®ä¾‹åŒ–æˆå¯¹è±¡äº†ã€‚Resource åªæ˜¯ API ä¸­çš„ä¸€ä¸ª Kind çš„ä½¿ç”¨æ–¹å¼ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼ŒKind å’Œ Resource ä¹‹é—´æœ‰ä¸€ä¸ªä¸€å¯¹ä¸€çš„æ˜ å°„ã€‚ä¾‹å¦‚ï¼Œpods èµ„æºå¯¹åº”äº Pod ç§ç±»ï¼Œä½†æ˜¯æœ‰æ—¶ï¼ŒåŒä¸€ç±»å‹å¯èƒ½ç”±å¤šä¸ªèµ„æºè¿”å›ã€‚ä¾‹å¦‚ Scale Kind æ˜¯ç”±æ‰€æœ‰ scale å­èµ„æºè¿”å›çš„ï¼Œå¦‚ deployments/scale æˆ– replicasets/scaleï¼Œè¿™å°±æ˜¯å…è®¸ Kubernetes HorizontalPodAutoscaler(HPA) ä¸ä¸åŒèµ„æºäº¤äº’çš„åŸå› ã€‚

kubectl æ˜¯å¦‚ä½•ä» YAML èµ„æºæ¸…å•æ–‡ä»¶ä¸­çŸ¥é“è¯¥è¯·æ±‚å“ªä¸ª GVR è·¯å¾„çš„ï¼Ÿè¿™å°±æ˜¯ REST Mapping çš„åŠŸèƒ½ï¼ŒREST Mapping å¯ä»¥æŒ‡å®šä¸€ä¸ª GVRï¼ˆä¾‹å¦‚ daemonset è¿™ä¸ªä¾‹å­ï¼‰ï¼Œç„¶åå®ƒè¿”å›å¯¹åº”çš„ GVK ä»¥åŠæ”¯æŒçš„æ“ä½œç­‰ã€‚

åœ¨ä»£ç ä¸­ï¼Œå…¶å®å°±å¯¹åº”äºè¿™ä¸ªæ¥å£ï¼š

![](image/2024-03-01-11-35-39.png)

è¿™æ ·ï¼Œå°±æŠŠ GVK å’Œ GVR è”ç³»èµ·æ¥äº†ã€‚

ç°åœ¨æˆ‘ä»¬çŸ¥é“ API Server å¯ä»¥é€šè¿‡ URI çš„å½¢å¼è®¿é—®åˆ°èµ„æºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ kubectl proxy æ¥ä»£ç†ä¸€ä¸ªæœ¬åœ°çš„ API Server ç«¯å£ï¼Œè¿™æ ·å°±å¯ä»¥ç»•è¿‡è®¤è¯äº†ï¼Œç›´æ¥å¯ä»¥ä»¥ http çš„å½¢å¼è®¿é—®ï¼š
```sh
[root@master yamlDir]# kubectl proxy
Starting to serve on 127.0.0.1:8001
```
ç„¶åæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è®¿é—® API Server äº†ï¼š
```sh
[root@master ~]# curl http://127.0.0.1:8001/apis/apps/v1/daemonsets
{
  "kind": "DaemonSetList",
  "apiVersion": "apps/v1",
  "metadata": {
    "resourceVersion": "1332469"
  },
  "items": [
    {
      "metadata": {
        "name": "kube-flannel-ds",
        "namespace": "kube-flannel",
        "uid": "73f42832-356e-4842-b9bd-7e058b40a36b",
        "resourceVersion": "6433",
        "generation": 2,
        "creationTimestamp": "2024-02-19T08:58:11Z",
        "labels": {
          "app": "flannel",
          "k8s-app": "flannel",
          "tier": "node"
        },
        ...
      },
      ...
    },
    {
      "metadata": {
        "name": "kube-proxy",
        "namespace": "kube-system",
        "uid": "ac3cc2aa-4b9a-4b75-8897-2288514f5908",
        "resourceVersion": "6084",
        "generation": 1,
        "creationTimestamp": "2024-02-19T08:25:16Z",
        "labels": {
          "k8s-app": "kube-proxy"
        },
        ...
      },
      ...
    }
  ]
}
```
ç»“æœè¿”å›äº†å½“å‰é›†ç¾¤æ‰€æœ‰çš„daemonsetå¯¹è±¡ï¼Œçœ‹çœ‹å½“å‰é›†ç¾¤çš„daemonsetï¼Œå¯¹æ¯”ä¸€ä¸‹ä¸¤è€…çš„è¾“å‡ºï¼š
```sh
[root@master ~]# kubectl get daemonset -A
NAMESPACE      NAME              DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
kube-flannel   kube-flannel-ds   3         3         3       3            3           <none>                   10d
kube-system    kube-proxy        3         3         3       3            3           kubernetes.io/os=linux   10d
```
å¦‚æœæƒ³çœ‹ç³»ç»Ÿæ”¯æŒå“ªäº› GVKï¼Œå¯é€šè¿‡ kubectl çš„å‘½ä»¤æŸ¥çœ‹ï¼š
```sh
[root@master ~]# kubectl api-resources
NAME                              SHORTNAMES   APIVERSION                             NAMESPACED   KIND
bindings                                       v1                                     true         Binding
componentstatuses                 cs           v1                                     false        ComponentStatus
configmaps                        cm           v1                                     true         ConfigMap
endpoints                         ep           v1                                     true         Endpoints
events                            ev           v1                                     true         Event
limitranges                       limits       v1                                     true         LimitRange
namespaces                        ns           v1                                     false        Namespace
...
```
è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆåˆ—å‡ºçš„GVKé‡Œé¢æ²¡æœ‰ä¸Šé¢é€šè¿‡curlè¿”å›çš„kindï¼šDaemonSetListå‘¢ï¼Ÿå½“æ‚¨é€šè¿‡ Kubernetes API (ä¾‹å¦‚ä½¿ç”¨ curl http://127.0.0.1:8001/apis/apps/v1/daemonsets) è·å–èµ„æºåˆ—è¡¨æ—¶ï¼Œå“åº”ä½“ä¸­åŒ…å«çš„ kind å­—æ®µé€šå¸¸è¡¨ç¤ºèµ„æºçš„é›†åˆç±»å‹ã€‚åœ¨æ‚¨çš„ä¾‹å­ä¸­ï¼Œkind å­—æ®µçš„å€¼æ˜¯ DaemonSetListï¼Œè¿™è¡¨æ˜è¿”å›çš„æ˜¯ä¸€ä¸ª DaemonSet èµ„æºåˆ—è¡¨ï¼Œè€Œä¸æ˜¯å•ä¸ª DaemonSet å¯¹è±¡ã€‚å¦ä¸€æ–¹é¢ï¼Œå½“æ‚¨ä½¿ç”¨ kubectl api-resources å‘½ä»¤æ—¶ï¼Œåˆ—å‡ºçš„æ˜¯é›†ç¾¤ä¸­å¯ç”¨çš„æ‰€æœ‰å•ä¸ªèµ„æºç±»å‹ï¼Œè€Œä¸æ˜¯å®ƒä»¬çš„é›†åˆç±»å‹ã€‚å› æ­¤ï¼Œåœ¨ api-resources çš„è¾“å‡ºä¸­ï¼Œæ¯ä¸ªèµ„æºç±»å‹çš„ kind å­—æ®µé€šå¸¸æŒ‡çš„æ˜¯å•ä¸ªå®ä½“ï¼Œè€Œä¸æ˜¯èµ„æºåˆ—è¡¨ã€‚

å¯¹äº Pod å’Œ Service ç­‰ï¼Œå®ƒä»¬çš„ API GROUP å±…ç„¶æ˜¯ç©ºçš„ï¼Œè¿™å…¶å®å°±æ˜¯ Kubernetes æ ¸å¿ƒï¼ˆcoreï¼‰èµ„æºçš„å«ä¹‰ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ Kubernetes ä¸­çš„åŸºç¡€èµ„æºï¼Œä»–ä»¬ä¸éœ€è¦ Groupï¼Œåªæœ‰ Version å’Œ Kindï¼Œå…¶å®ä¸»è¦æ˜¯å†å²åŸå› å¯¼è‡´çš„ï¼Œåœ¨ Kubernetes çš„å¼€å§‹ä¹‹åˆè¿˜ä¸æ”¯æŒè‡ªå®šä¹‰ç±»å‹çš„æ—¶å€™å°±æ²¡è€ƒè™‘è¿‡ Groupã€‚

# RBAC
ä¸Šé¢æˆ‘ä»¬ä»‹ç»çš„ Kubernetes æ‰€æœ‰èµ„æºå¯¹è±¡éƒ½å…è®¸æ‰§è¡Œ CRUD(Createã€Readã€Updateã€Delete) æ“ä½œï¼Œæ¯”å¦‚ä¸‹é¢çš„è¿™äº›èµ„æºï¼š
- Pods
- ConfigMaps
- Deployments
- Nodes
- Secrets
- Namespaces
- ......

å¯¹äºä¸Šé¢è¿™äº›èµ„æºå¯¹è±¡çš„å¯èƒ½å­˜åœ¨çš„æ“ä½œæœ‰ï¼š
- create
- get
- delete
- list
- update
- edit
- watch
- exec
- patch

åœ¨æ›´ä¸Šå±‚ï¼Œè¿™äº›èµ„æºå’Œ API Group è¿›è¡Œå…³è”ï¼Œæ¯”å¦‚ Pods å±äº Core API Groupï¼Œè€Œ Deployements å±äº apps API Groupï¼Œç°åœ¨æˆ‘ä»¬è¦åœ¨ Kubernetes ä¸­é€šè¿‡ RBAC æ¥å¯¹èµ„æºè¿›è¡Œæƒé™ç®¡ç†ï¼Œé™¤äº†ä¸Šé¢çš„è¿™äº›èµ„æºå’Œæ“ä½œä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦äº†è§£å¦å¤–å‡ ä¸ªæ¦‚å¿µï¼š
- Ruleï¼šè§„åˆ™ï¼Œè§„åˆ™æ˜¯ä¸€ç»„å¯¹ä¸åŒ API Group èµ„æºä¸Šçš„ä¸€ç»„æ“ä½œçš„é›†åˆã€‚
- Role å’Œ ClusterRoleï¼šè§’è‰²å’Œé›†ç¾¤è§’è‰²ï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡éƒ½åŒ…å«ä¸Šé¢çš„ Rule å…ƒç´ ï¼ŒäºŒè€…çš„åŒºåˆ«åœ¨äºï¼Œåœ¨ Role ä¸­ï¼Œå®šä¹‰çš„è§„åˆ™åªé€‚ç”¨äºå•ä¸ªå‘½åç©ºé—´ï¼Œä¹Ÿå°±æ˜¯å’Œ namespace å…³è”çš„ï¼Œè€Œ ClusterRole æ˜¯é›†ç¾¤èŒƒå›´å†…çš„ï¼Œå› æ­¤å®šä¹‰çš„è§„åˆ™ä¸å—å‘½åç©ºé—´çš„çº¦æŸã€‚å¦å¤– Role å’Œ ClusterRole åœ¨Kubernetes ä¸­éƒ½è¢«å®šä¹‰ä¸ºé›†ç¾¤å†…éƒ¨çš„ API èµ„æºï¼Œå’Œæˆ‘ä»¬å‰é¢å­¦ä¹ è¿‡çš„ Podã€Deployment è¿™äº›å¯¹è±¡ç±»ä¼¼ï¼Œéƒ½æ˜¯æˆ‘ä»¬é›†ç¾¤çš„èµ„æºå¯¹è±¡ï¼Œæ‰€ä»¥åŒæ ·çš„å¯ä»¥ä½¿ç”¨ YAML æ–‡ä»¶æ¥æè¿°ï¼Œç”¨ kubectl å·¥å…·æ¥ç®¡ç†ã€‚
- Subjectï¼šä¸»é¢˜ï¼Œå¯¹åº”é›†ç¾¤ä¸­å°è¯•æ“ä½œçš„å¯¹è±¡ï¼Œé›†ç¾¤ä¸­å®šä¹‰äº†3ç§ç±»å‹çš„ä¸»é¢˜èµ„æºï¼š
    - User Accountï¼šç”¨æˆ·ï¼Œè¿™æ˜¯ç”±å¤–éƒ¨ç‹¬ç«‹æœåŠ¡è¿›è¡Œç®¡ç†çš„ï¼Œç®¡ç†å‘˜è¿›è¡Œç§é’¥çš„åˆ†é…ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ KeyStone æˆ–è€… Goolge å¸å·ï¼Œç”šè‡³ä¸€ä¸ªç”¨æˆ·åå’Œå¯†ç çš„æ–‡ä»¶åˆ—è¡¨ä¹Ÿå¯ä»¥ã€‚å¯¹äºç”¨æˆ·çš„ç®¡ç†ï¼Œé›†ç¾¤å†…éƒ¨æ²¡æœ‰ä¸€ä¸ªå…³è”çš„èµ„æºå¯¹è±¡ï¼Œæ‰€ä»¥ç”¨æˆ·ä¸èƒ½é€šè¿‡é›†ç¾¤å†…éƒ¨çš„ API æ¥è¿›è¡Œç®¡ç†ã€‚
    - Groupï¼šç»„ï¼Œè¿™æ˜¯ç”¨æ¥å…³è”å¤šä¸ªè´¦æˆ·çš„ï¼Œé›†ç¾¤ä¸­æœ‰ä¸€äº›é»˜è®¤åˆ›å»ºçš„ç»„ï¼Œæ¯”å¦‚ cluster-adminã€‚
    - Service Accountï¼šæœåŠ¡å¸å·ï¼Œé€šè¿‡ Kubernetes API æ¥ç®¡ç†çš„ä¸€äº›ç”¨æˆ·å¸å·ï¼Œå’Œ namespace è¿›è¡Œå…³è”çš„ï¼Œé€‚ç”¨äºé›†ç¾¤å†…éƒ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºï¼Œéœ€è¦é€šè¿‡ API æ¥å®Œæˆæƒé™è®¤è¯ï¼Œæ‰€ä»¥åœ¨é›†ç¾¤å†…éƒ¨è¿›è¡Œæƒé™æ“ä½œï¼Œæˆ‘ä»¬éƒ½éœ€è¦ä½¿ç”¨åˆ° ServiceAccountï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬è¿™èŠ‚è¯¾çš„é‡ç‚¹ã€‚
- RoleBinding å’Œ ClusterRoleBindingï¼šè§’è‰²ç»‘å®šå’Œé›†ç¾¤è§’è‰²ç»‘å®šï¼Œç®€å•æ¥è¯´å°±æ˜¯æŠŠå£°æ˜çš„ Subject å’Œæˆ‘ä»¬çš„ Role è¿›è¡Œç»‘å®šçš„è¿‡ç¨‹ï¼ˆç»™æŸä¸ªç”¨æˆ·ç»‘å®šä¸Šæ“ä½œçš„æƒé™ï¼‰ï¼ŒäºŒè€…çš„åŒºåˆ«ä¹Ÿæ˜¯ä½œç”¨èŒƒå›´çš„åŒºåˆ«ï¼šRoleBinding åªä¼šå½±å“åˆ°å½“å‰ namespace ä¸‹é¢çš„èµ„æºæ“ä½œæƒé™ï¼Œè€Œ ClusterRoleBinding ä¼šå½±å“åˆ°æ‰€æœ‰çš„ namespaceã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥é€šè¿‡å‡ ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œæ¥å­¦ä¹ ä¸‹åœ¨ Kubernetes é›†ç¾¤ä¸­å¦‚ä½•ä½¿ç”¨ RBACã€‚

## åªèƒ½è®¿é—®æŸä¸ª namespace çš„æ™®é€šç”¨æˆ·
æˆ‘ä»¬æƒ³è¦åˆ›å»ºä¸€ä¸ª User Accountï¼Œåªèƒ½è®¿é—® kube-system è¿™ä¸ªå‘½åç©ºé—´ï¼Œå¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯å¦‚ä¸‹æ‰€ç¤ºï¼š
```yaml
username: cnych
group: youdianzhishi
```
### åˆ›å»ºç”¨æˆ·å‡­è¯
æˆ‘ä»¬å‰é¢å·²ç»æåˆ°è¿‡ï¼ŒKubernetes æ²¡æœ‰ User Account çš„ API å¯¹è±¡ï¼Œä¸è¿‡è¦åˆ›å»ºä¸€ä¸ªç”¨æˆ·å¸å·çš„è¯ä¹Ÿæ˜¯æŒºç®€å•çš„ï¼Œåˆ©ç”¨ç®¡ç†å‘˜åˆ†é…ç»™ä½ çš„ä¸€ä¸ªç§é’¥å°±å¯ä»¥åˆ›å»ºäº†ï¼Œè¿™ä¸ªæˆ‘ä»¬å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ä¸­çš„æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬æ¥ä½¿ç”¨ OpenSSL è¯ä¹¦æ¥åˆ›å»ºä¸€ä¸ª Userï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨æ›´ç®€å•çš„ cfsslå·¥å…·æ¥åˆ›å»ºã€‚

ç»™ç”¨æˆ· cnych åˆ›å»ºä¸€ä¸ªç§é’¥ï¼Œå‘½åæˆ cnych.keyï¼š
```sh
[root@master rbac]# openssl genrsa -out cnych.key 2048
Generating RSA private key, 2048 bit long modulus (2 primes)
.................+++++
....................................................+++++
e is 65537 (0x010001)
[root@master rbac]# ll
total 4
-rw------- 1 root root 1675 Mar  1 02:21 cnych.key
```
ä½¿ç”¨æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ç§é’¥åˆ›å»ºä¸€ä¸ªè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ï¼šcnych.csrï¼Œè¦æ³¨æ„éœ€è¦ç¡®ä¿åœ¨ -subj å‚æ•°ä¸­æŒ‡å®šç”¨æˆ·åå’Œç»„(CNè¡¨ç¤ºç”¨æˆ·åï¼ŒOè¡¨ç¤ºç»„)ï¼š
```sh
âœ  ~ openssl req -new -key cnych.key -out cnych.csr -subj "/CN=cnych/O=youdianzhishi"
```
ç„¶åæ‰¾åˆ° Kubernetes é›†ç¾¤çš„ CA è¯ä¹¦ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ kubeadm å®‰è£…é›†ç¾¤ï¼ŒCA ç›¸å…³è¯ä¹¦ä½äº /etc/kubernetes/pki/ ç›®å½•ä¸‹é¢ï¼Œå¦‚æœä½ æ˜¯äºŒè¿›åˆ¶æ–¹å¼æ­å»ºçš„ï¼Œåº”è¯¥åœ¨æœ€å¼€å§‹æ­å»ºé›†ç¾¤çš„æ—¶å€™å°±å·²ç»æŒ‡å®šå¥½äº† CA çš„ç›®å½•ï¼Œæˆ‘ä»¬ä¼šåˆ©ç”¨è¯¥ç›®å½•ä¸‹é¢çš„ ca.crt å’Œ ca.keyä¸¤ä¸ªæ–‡ä»¶æ¥æ‰¹å‡†ä¸Šé¢çš„è¯ä¹¦è¯·æ±‚ã€‚ç”Ÿæˆæœ€ç»ˆçš„è¯ä¹¦æ–‡ä»¶ï¼Œæˆ‘ä»¬è¿™é‡Œè®¾ç½®è¯ä¹¦çš„æœ‰æ•ˆæœŸä¸º 500 å¤©ï¼š
```sh
[root@master rbac]# openssl x509 -req -in cnych.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out cnych.crt -days 500
Signature ok
subject=CN = cnych, O = youdianzhishi
Getting CA Private Key
```
ç°åœ¨æŸ¥çœ‹æˆ‘ä»¬å½“å‰æ–‡ä»¶å¤¹ä¸‹é¢æ˜¯å¦ç”Ÿæˆäº†ä¸€ä¸ªè¯ä¹¦æ–‡ä»¶ï¼š
```sh
[root@master rbac]# ls
cnych.crt  cnych.csr  cnych.key
```
ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åˆšåˆšåˆ›å»ºçš„è¯ä¹¦æ–‡ä»¶å’Œç§é’¥æ–‡ä»¶åœ¨é›†ç¾¤ä¸­åˆ›å»ºæ–°çš„å‡­è¯å’Œä¸Šä¸‹æ–‡(Context):
```sh
[root@master rbac]# kubectl config set-credentials cnych --client-certificate=cnych.crt --client-key=cnych.key
User "cnych" set.
```
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªç”¨æˆ· cnych åˆ›å»ºäº†ï¼Œç„¶åä¸ºè¿™ä¸ªç”¨æˆ·è®¾ç½®æ–°çš„ Contextï¼Œæˆ‘ä»¬è¿™é‡ŒæŒ‡å®šç‰¹å®šçš„ä¸€ä¸ª namespaceï¼š
```sh
[root@master rbac]# kubectl config get-clusters
NAME
kubernetes
[root@master rbac]# kubectl config set-context cnych-context --cluster=kubernetes --namespace=kube-system --user=cnych
Context "cnych-context" created.
```
åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„ç”¨æˆ· cnych å°±å·²ç»åˆ›å»ºæˆåŠŸäº†ï¼Œç°åœ¨æˆ‘ä»¬ä½¿ç”¨å½“å‰çš„è¿™ä¸ªé…ç½®æ–‡ä»¶æ¥æ“ä½œ kubectl å‘½ä»¤çš„æ—¶å€™ï¼Œåº”è¯¥ä¼šå‡ºç°é”™è¯¯ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰ä¸ºè¯¥ç”¨æˆ·å®šä¹‰ä»»ä½•æ“ä½œçš„æƒé™å‘¢ï¼š
```sh
[root@master rbac]# kubectl get pods --context=cnych-context
Error from server (Forbidden): pods is forbidden: User "cnych" cannot list resource "pods" in API group "" in the namespace "kube-system"
```
### åˆ›å»ºè§’è‰²
ç”¨æˆ·åˆ›å»ºå®Œæˆåï¼Œæ¥ä¸‹æ¥å°±éœ€è¦ç»™è¯¥ç”¨æˆ·æ·»åŠ æ“ä½œæƒé™ï¼Œæˆ‘ä»¬æ¥å®šä¹‰ä¸€ä¸ª YAML æ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªå…è®¸ç”¨æˆ·æ“ä½œ Deploymentã€Podã€ReplicaSets çš„è§’è‰²ï¼Œå¦‚ä¸‹å®šä¹‰ï¼š
```yaml
# cnych-role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: cnych-role
  namespace: kube-system
rules:
  - apiGroups: ["", "apps"]
    resources: ["deployments", "replicasets", "pods"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"] # ä¹Ÿå¯ä»¥ä½¿ç”¨['*']
```
å…¶ä¸­ Pod å±äº core è¿™ä¸ª API Groupï¼Œåœ¨ YAML ä¸­ç”¨ç©ºå­—ç¬¦å°±å¯ä»¥ï¼Œè€Œ Deployment å’Œ ReplicaSet ç°åœ¨éƒ½å±äº apps è¿™ä¸ª API Groupï¼ˆå¦‚æœä¸çŸ¥é“åˆ™å¯ä»¥ç”¨ kubectl explain å‘½ä»¤æŸ¥çœ‹ï¼‰ï¼Œæ‰€ä»¥ rules ä¸‹é¢çš„ apiGroups å°±ç»¼åˆäº†è¿™å‡ ä¸ªèµ„æºçš„ API Groupï¼š["", "apps"]ï¼Œå…¶ä¸­ verbs å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æåˆ°çš„å¯ä»¥å¯¹è¿™äº›èµ„æºå¯¹è±¡æ‰§è¡Œçš„æ“ä½œï¼Œæˆ‘ä»¬è¿™é‡Œéœ€è¦æ‰€æœ‰çš„æ“ä½œæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨['*']æ¥ä»£æ›¿ï¼Œç„¶åç›´æ¥åˆ›å»ºè¿™ä¸ª Roleï¼š
```sh
[root@master rbac]# kubectl apply -f cnych-role.yaml
role.rbac.authorization.k8s.io/cnych-role created
[root@master rbac]# kubectl get role -n kube-system
NAME                                             CREATED AT
cnych-role                                       2024-03-02T06:22:56Z
extension-apiserver-authentication-reader        2024-02-19T08:25:14Z
kube-proxy                                       2024-02-19T08:25:16Z
kubeadm:kubelet-config                           2024-02-19T08:25:14Z
kubeadm:nodes-kubeadm-config                     2024-02-19T08:25:14Z
system::leader-locking-kube-controller-manager   2024-02-19T08:25:14Z
system::leader-locking-kube-scheduler            2024-02-19T08:25:14Z
system:controller:bootstrap-signer               2024-02-19T08:25:14Z
system:controller:cloud-provider                 2024-02-19T08:25:14Z
system:controller:token-cleaner                  2024-02-19T08:25:14Z
```
æ³¨æ„è¿™é‡Œæˆ‘ä»¬æ²¡æ³•ä½¿ç”¨ä¸Šé¢çš„ cnych-context è¿™ä¸ªä¸Šä¸‹æ–‡ï¼Œå› ä¸ºæš‚æ—¶è¿˜æ²¡æœ‰æƒé™ã€‚

### åˆ›å»ºè§’è‰²æƒé™ç»‘å®š
Role åˆ›å»ºå®Œæˆäº†ï¼Œä½†æ˜¯å¾ˆæ˜æ˜¾ç°åœ¨æˆ‘ä»¬è¿™ä¸ª Role å’Œæˆ‘ä»¬çš„ç”¨æˆ· cnych è¿˜æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œè¿™é‡Œå°±éœ€è¦åˆ›å»ºä¸€ä¸ª RoleBinding å¯¹è±¡ï¼Œåœ¨ kube-system è¿™ä¸ªå‘½åç©ºé—´ä¸‹é¢å°†ä¸Šé¢çš„ cnych-role è§’è‰²å’Œç”¨æˆ· cnych è¿›è¡Œç»‘å®šï¼š
```yaml
# cnych-rolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: cnych-rolebinding
  namespace: kube-system
subjects:
  - kind: User
    name: cnych
    apiGroup: ""
roleRef:
  kind: Role
  name: cnych-role
  apiGroup: rbac.authorization.k8s.io # ç•™ç©ºå­—ç¬¦ä¸²ä¹Ÿå¯ä»¥ï¼Œåˆ™ä½¿ç”¨å½“å‰çš„apiGroup
```
ä¸Šé¢çš„ YAML æ–‡ä»¶ä¸­æˆ‘ä»¬çœ‹åˆ°äº† subjects å­—æ®µï¼Œè¿™å°±æ˜¯ç”¨æ¥å°è¯•æ“ä½œé›†ç¾¤çš„å¯¹è±¡ï¼Œè¿™é‡Œå¯¹åº”ä¸Šé¢çš„ User å¸å· cnychï¼Œä½¿ç”¨kubectl åˆ›å»ºä¸Šé¢çš„èµ„æºå¯¹è±¡ï¼š
```sh
[root@master rbac]# kubectl apply -f cnych-rolebinding.yaml
rolebinding.rbac.authorization.k8s.io/cnych-rolebinding created
```

### æµ‹è¯•
ç°åœ¨æˆ‘ä»¬åº”è¯¥å¯ä»¥ä¸Šé¢çš„ cnych-context ä¸Šä¸‹æ–‡æ¥æ“ä½œé›†ç¾¤äº†ï¼š
```sh
[root@master rbac]# kubectl get pods --context=cnych-context
NAME                              READY   STATUS    RESTARTS      AGE
coredns-7b884d5cb7-lrl72          1/1     Running   2 (29h ago)   11d
coredns-7b884d5cb7-nw9hl          1/1     Running   2 (29h ago)   11d
etcd-master                       1/1     Running   3 (29h ago)   11d
kube-apiserver-master             1/1     Running   3 (29h ago)   11d
kube-controller-manager-master    1/1     Running   4 (29h ago)   11d
kube-proxy-8cs2d                  1/1     Running   2 (29h ago)   11d
kube-proxy-h8wm7                  1/1     Running   3 (29h ago)   11d
kube-proxy-m2wcz                  1/1     Running   2 (29h ago)   11d
kube-scheduler-master             1/1     Running   4 (29h ago)   11d
metrics-server-7c5487d558-sr5vp   1/1     Running   1 (29h ago)   4d20h
[root@master rbac]# kubectl --context=cnych-context get rs,deploy
NAME                                        DESIRED   CURRENT   READY   AGE
replicaset.apps/coredns-7b884d5cb7          2         2         2       11d
replicaset.apps/metrics-server-7c5487d558   1         1         1       4d20h
replicaset.apps/metrics-server-df98fb78f    0         0         0       4d21h

NAME                             READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/coredns          2/2     2            2           11d
deployment.apps/metrics-server   1/1     1            1           4d21h
```
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨ kubectl çš„ä½¿ç”¨å¹¶æ²¡æœ‰æŒ‡å®š namespaceï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬æˆ‘ä»¬ä¸Šé¢åˆ›å»ºè¿™ä¸ª Context çš„æ—¶å€™å°±ç»‘å®šåœ¨äº† kube-system è¿™ä¸ªå‘½åç©ºé—´ä¸‹é¢ï¼Œå¦‚æœæˆ‘ä»¬åœ¨åé¢åŠ ä¸Šä¸€ä¸ª-n defaultè¯•çœ‹çœ‹å‘¢ï¼Ÿ
```sh
[root@master rbac]# kubectl --context=cnych-context get pods --namespace=default
Error from server (Forbidden): pods is forbidden: User "cnych" cannot list resource "pods" in API group "" in the namespace "default"
```
å¦‚æœå»è·å–å…¶ä»–çš„èµ„æºå¯¹è±¡å‘¢ï¼š
```sh
[root@master rbac]# kubectl --context=cnych-context get svc
Error from server (Forbidden): services is forbidden: User "cnych" cannot list resource "services" in API group "" in the namespace "kube-system"
```
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ²¡æœ‰æƒé™è·å–ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰ä¸ºå½“å‰æ“ä½œç”¨æˆ·æŒ‡å®šå…¶ä»–å¯¹è±¡èµ„æºçš„è®¿é—®æƒé™ï¼Œæ˜¯ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸçš„ã€‚è¿™æ ·æˆ‘ä»¬å°±åˆ›å»ºäº†ä¸€ä¸ªåªæœ‰å•ä¸ªå‘½åç©ºé—´è®¿é—®æƒé™çš„æ™®é€š User ã€‚

## åªèƒ½è®¿é—®æŸä¸ª namespace çš„ ServiceAccount
é¦–å…ˆæˆ‘ä»¬éœ€è¦å¯¹ ServiceAccount äº†è§£ä¸‹ã€‚

### ServiceAccount
ServiceAccount ä¸º Pod ä¸­è¿è¡Œçš„è¿›ç¨‹æä¾›äº†ä¸€ä¸ªèº«ä»½ï¼ŒPod å†…çš„è¿›ç¨‹å¯ä»¥ä½¿ç”¨å…¶å…³è”æœåŠ¡è´¦å·çš„èº«ä»½ï¼Œå‘é›†ç¾¤çš„APIServer è¿›è¡Œèº«ä»½è®¤è¯ã€‚

å½“åˆ›å»º Pod çš„æ—¶å€™è§„èŒƒä¸‹é¢æœ‰ä¸€ä¸ª spec.serviceAccount çš„å±æ€§ç”¨æ¥æŒ‡å®šè¯¥ Pod ä½¿ç”¨å“ªä¸ª ServiceAccountï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šçš„è¯åˆ™é»˜è®¤ä½¿ç”¨ default è¿™ä¸ª saï¼ˆæ¯ä¸ªnamespaceä¸‹é¢éƒ½æœ‰ä¸€ä¸ªdefaultè¿™ä¸ªsaï¼‰ã€‚ç„¶åé€šè¿‡æŠ•å°„å·ï¼Œåœ¨ Pod çš„ç›®å½•/run/secrets/kubernetes.io/serviceaccount/ ä¸‹æœ‰ä¸€ä¸ª token ä»¤ç‰Œæ–‡ä»¶ã€‚æˆ‘ä»¬é€šè¿‡ RBAC å¯¹è¯¥ sa æˆäºˆäº†ä»€ä¹ˆæƒé™ï¼Œé‚£ä¹ˆå®¹å™¨é‡Œçš„åº”ç”¨æ‹¿ç€è¿™ä¸ª token åï¼Œå°±å…·å¤‡äº†å¯¹åº”çš„æƒé™ã€‚

ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ä¸åŒçš„ K8s ç‰ˆæœ¬å¯¹è¯¥ token æ–‡ä»¶çš„ä½¿ç”¨æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ†å‡ ä¸ªç‰ˆæœ¬æ¥åˆ†åˆ«è®¨è®ºä¸‹ã€‚
#### <= 1.20 ç‰ˆæœ¬
ä½¿ç”¨ kind å¿«é€Ÿåˆ›å»ºä¸€ä¸ªå°äºç­‰äº v1.20 ç‰ˆæœ¬çš„é›†ç¾¤ï¼š
```sh
[root@localhost ~]#  kind create cluster --name kind120 --image kindest/node:v1.20.15
Creating cluster "kind120" ...
 âœ“ Ensuring node image (kindest/node:v1.20.15) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦
 âœ“ Writing configuration ğŸ“œ
 âœ“ Starting control-plane ğŸ•¹ï¸
 âœ“ Installing CNI ğŸ”Œ
 âœ“ Installing StorageClass ğŸ’¾
Set kubectl context to "kind-kind120"
You can now use your cluster with:

kubectl cluster-info --context kind-kind120

Thanks for using kind! ğŸ˜Š
[root@localhost ~]# kubectl get nodes
NAME                    STATUS     ROLES                  AGE   VERSION
kind120-control-plane   NotReady   control-plane,master   12s   v1.20.15
```
æˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªå­—ä¸º sa-demo çš„ ServiceAccount å¯¹è±¡ï¼š
```sh
[root@localhost ~]# kubectl create sa sa-demo
serviceaccount/sa-demo created
[root@localhost ~]# kubectl get sa
NAME      SECRETS   AGE
default   1         38m
sa-demo   1         5s
[root@localhost ~]# kubectl get secret
NAME                  TYPE                                  DATA   AGE
default-token-44bb9   kubernetes.io/service-account-token   3      38m
sa-demo-token-69txr   kubernetes.io/service-account-token   3      15s
```
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åˆ›å»º sa åè‡ªåŠ¨ç”Ÿæˆäº†ä¸€ä¸ª secretï¼Œæ ¼å¼ä¸º `<saname>-token-xxxx` ï¼Œæ¯”å¦‚æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåå­—ä¸º sademo çš„ sa ä¹‹åï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºäº†ä¸€ä¸ªåå­—ä¸º sa-demo-token-69txr çš„ secretï¼Œè¿™ä¸ª secret é‡Œå°±åŒ…å«äº†ä¸€ä¸ªtokenã€‚
```sh
[root@localhost ~]# kubectl describe secrets sa-demo-token-69txr
Name:         sa-demo-token-69txr
Namespace:    default
Labels:       <none>
Annotations:  kubernetes.io/service-account.name: sa-demo
              kubernetes.io/service-account.uid: 0cfc1037-6acd-4f05-8fe1-3be87d21aa1a

Type:  kubernetes.io/service-account-token

Data
====
ca.crt:     1066 bytes
namespace:  7 bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6Il81VGI3bDBRX0lwMVUyNFh0YUY1Sld1c1JwbUFEYzRmRFFCamlGbWxLS0UifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6InNhLWRlbW8tdG9rZW4tNjl0eHIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoic2EtZGVtbyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjBjZmMxMDM3LTZhY2QtNGYwNS04ZmUxLTNiZTg3ZDIxYWExYSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OnNhLWRlbW8ifQ.Xco0O5xTHqvLVgwUzfbVCxbDNqKsKcxPO1UccP5zvPKjg18x5Dnnz2yR3pLKUMVbxdiJRJf6w1FLEoGtrvurmc6VRDgNEL0NIxBzHH_sz-XXEMxJAOq_5IUpzO1T2wJqb4nzLBk6TEU2EVUb0g0tRy_rCVs2eMw1xSyFr_J3_iO5XAHGk-Kb5w1iGWNzYAlzm4KoJsZ-3bslHzZ5UsS3uwXnlJnsuVFRnuugzmAOXIDql5WgqEYK4LRQg_lWh6DnVBDToTtZZygxxspUruiSlF86hV0oFyoRd1EE0XpY79tTUW-PnUHppHW2d8mWXMOOv-42aKlX1VUHoaybIh_zHw
```
å¯ä»¥çœ‹åˆ°è‡ªåŠ¨ç”Ÿæˆçš„è¿™ä¸ª secret å¯¹è±¡é‡Œé¢åŒ…å«ä¸€ä¸ª tokenï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥è·å–ï¼š
```sh
[root@localhost ~]# kubectl get secrets sa-demo-token-69txr  -o jsonpath='{.data.token}' | base64 -d
eyJhbGciOiJSUzI1NiIsImtpZCI6Il81VGI3bDBRX0lwMVUyNFh0YUY1Sld1c1JwbUFEYzRmRFFCamlGbWxLS0UifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6InNhLWRlbW8tdG9rZW4tNjl0eHIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoic2EtZGVtbyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjBjZmMxMDM3LTZhY2QtNGYwNS04ZmUxLTNiZTg3ZDIxYWExYSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OnNhLWRlbW8ifQ.Xco0O5xTHqvLVgwUzfbVCxbDNqKsKcxPO1UccP5zvPKjg18x5Dnnz2yR3pLKUMVbxdiJRJf6w1FLEoGtrvurmc6VRDgNEL0NIxBzHH_sz-XXEMxJAOq_5IUpzO1T2wJqb4nzLBk6TEU2EVUb0g0tRy_rCVs2eMw1xSyFr_J3_iO5XAHGk-Kb5w1iGWNzYAlzm4KoJsZ-3bslHzZ5UsS3uwXnlJnsuVFRnuugzmAOXIDql5WgqEYK4LRQg_lWh6DnVBDToTtZZygxxspUruiSlF86hV0oFyoRd1EE0XpY79tTUW-PnUHppHW2d8mWXMOOv-42aKlX1VUHoaybIh_zHw
```
è¿™ä¸ª token æ˜¯ JWT ç»“æ„çš„ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ª token å¤åˆ¶åˆ° jwt.io ç½‘ç«™è¿›è¡Œè§£ç ã€‚
![](image/2024-03-02-19-58-36.png)

å³ä¾§éƒ¨åˆ†æ˜¾ç¤ºäº† token è¢«è§£ç ä¹‹åçš„å†…å®¹ï¼Œå…¶ä¸­ PAYLOAD éƒ¨åˆ†æ˜¯ token é‡ŒåŒ…å«çš„ sa-demo çš„ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°é‡Œé¢æ²¡æœ‰è¿‡æœŸæ—¶é—´ï¼Œä¹Ÿè¯´æ˜äº†è¯¥ token æ˜¯æ°¸ä¸è¿‡æœŸçš„ã€‚

ç°åœ¨æˆ‘ä»¬ä½¿ç”¨ä¸Šé¢æˆ‘ä»¬åˆ›å»ºçš„ sa æ¥è¿è¡Œä¸€ä¸ª Podï¼š
```yaml
# demo-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: demo
spec:
  serviceAccount: sa-demo
  containers:
    - name: demo
      image: nginx:1.7.9
      ports:
        - containerPort: 80
```
ç›´æ¥åˆ›å»ºè¯¥ Pod å³å¯ï¼š
```sh
[root@localhost ~]# kubectl apply -f demo-pod.yaml
pod/demo created
[root@localhost ~]# kubectl get pods
NAME   READY   STATUS    RESTARTS   AGE
demo   1/1     Running   0          72s
[root@localhost ~]# kubectl get pod demo -oyaml
apiVersion: v1
kind: Pod
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{},"name":"demo","namespace":"default"},"spec":{"containers":[{"image":"nginx:1.7.9","name":"demo","ports":[{"containerPort":80}]}],"serviceAccount":"sa-demo"}}
  creationTimestamp: "2024-03-02T12:03:00Z"
  name: demo
  namespace: default
  resourceVersion: "17555"
  uid: d51773bc-db44-4fef-871f-70d13c4fb533
spec:
  containers:
  - image: nginx:1.7.9
    imagePullPolicy: IfNotPresent
    name: demo
    ports:
    - containerPort: 80
      protocol: TCP
    resources: {}
    terminationMessagePath: /dev/termination-log
    terminationMessagePolicy: File
    volumeMounts:
    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
      name: sa-demo-token-69txr
      readOnly: true
    ......
  volumes:
  - name: sa-demo-token-69txr
    secret:
      defaultMode: 420
      secretName: sa-demo-token-69txr
  ......
```
Pod åˆ›å»ºåæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¼šè‡ªåŠ¨å°†æŒ‡å®š sa å¯¹åº”çš„ secret æŒ‚è½½åˆ°å®¹å™¨çš„/var/run/secrets/kubernetes.io/serviceaccount ç›®å½•ä¸‹å»ï¼Œæ‰€ä»¥ç°åœ¨è¯¥ç›®å½•ä¸‹é¢è‚¯å®šåŒ…å«å¯¹åº”çš„ token æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹è¯¥å€¼æ¥éªŒè¯ä¸‹ï¼š
```sh
[root@localhost ~]# kubectl exec -it demo -- ls /run/secrets/kubernetes.io/serviceaccount
ca.crt  namespace  token
[root@localhost ~]# kubectl exec -it demo -- cat /run/secrets/kubernetes.io/serviceaccount/token
eyJhbGciOiJSUzI1NiIsImtpZCI6Il81VGI3bDBRX0lwMVUyNFh0YUY1Sld1c1JwbUFEYzRmRFFCamlGbWxLS0UifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6InNhLWRlbW8tdG9rZW4tNjl0eHIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoic2EtZGVtbyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjBjZmMxMDM3LTZhY2QtNGYwNS04ZmUxLTNiZTg3ZDIxYWExYSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OnNhLWRlbW8ifQ.Xco0O5xTHqvLVgwUzfbVCxbDNqKsKcxPO1UccP5zvPKjg18x5Dnnz2yR3pLKUMVbxdiJRJf6w1FLEoGtrvurmc6VRDgNEL0NIxBzHH_sz-XXEMxJAOq_5IUpzO1T2wJqb4nzLBk6TEU2EVUb0g0tRy_rCVs2eMw1xSyFr_J3_iO5XAHGk-Kb5w1iGWNzYAlzm4KoJsZ-3bslHzZ5UsS3uwXnlJnsuVFRnuugzmAOXIDql5WgqEYK4LRQg_lWh6DnVBDToTtZZygxxspUruiSlF86hV0oFyoRd1EE0XpY79tTUW-PnUHppHW2d8mWXMOOv-42aKlX1VUHoaybIh_zHw
```
å¯ä»¥çœ‹åˆ° Pod é‡Œé€šè¿‡æŠ•å°„å·æ‰€æŒ‚è½½çš„ token è·Ÿ sa-demo å¯¹åº”çš„ secret åŒ…å«çš„ token æ˜¯æ¨¡ä¸€æ ·çš„ï¼Œè¿™ä¸ª tokenæ˜¯æ°¸ä¸è¿‡æœŸçš„ï¼Œæ‰€ä»¥å³ä½¿åˆ é™¤äº† Pod ä¹‹åé‡æ–°åˆ›å»ºï¼ŒPod é‡Œçš„ token ä»ç„¶æ˜¯ä¸å˜çš„ï¼Œå› ä¸º secret å¯¹è±¡é‡Œé¢çš„ tokenæ•°æ®å¹¶æ²¡æœ‰å˜åŒ–ã€‚

å¦‚æœéœ€è¦åœ¨ Pod ä¸­å»è®¿é—® K8s é›†ç¾¤çš„èµ„æºå¯¹è±¡ï¼Œç°åœ¨å°±å¯ä»¥ä¸ºä½¿ç”¨çš„ sa ç»‘å®šä¸Šç›¸åº”çš„æƒé™ï¼Œç„¶ååœ¨ Pod åº”ç”¨ä¸­ä½¿ç”¨è¯¥å¯¹åº”çš„ token å»å’Œ APIServer è¿›è¡Œé€šä¿¡å°±å¯ä»¥äº†ï¼Œè¿™ä¸ªæ—¶å€™çš„ token å°±èƒ½è¯†åˆ«åˆ°å¯¹åº”çš„æƒé™äº†ã€‚

#### >= 1.21 ç‰ˆæœ¬ && <= 1.23 ç‰ˆæœ¬
æ¥ä¸‹æ¥æˆ‘ä»¬åŸºäº >= 1.21 && <= 1.23 ç‰ˆæœ¬çš„ K8s é›†ç¾¤è¿›è¡Œæµ‹è¯•ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ kind å¿«é€Ÿåˆ›å»ºä¸€ä¸ª v1.22.15 ç‰ˆæœ¬çš„é›†ç¾¤ï¼š
```sh
â˜¸ âœ kind create cluster --name kind122 --image kindest/node:v1.22.15
â˜¸ âœ kubectl get nodes
NAME                    STATUS  ROLES                   AGE         VERSION
kind122-control-plane   Ready   control-plane,master    115s        v1.22.15
```
åŒæ ·é¦–å…ˆåˆ›å»ºä¸€ä¸ªåä¸º sa-demo çš„ ServiceAccount å¯¹è±¡ï¼š
```sh
[root@localhost ~]# kubectl create sa sa-demo
serviceaccount/sa-demo created
[root@localhost ~]# kubectl get sa
NAME      SECRETS   AGE
default   1         2m45s
sa-demo   1         11s
[root@localhost ~]# kubectl get secret
NAME                  TYPE                                  DATA   AGE
default-token-mfkt9   kubernetes.io/service-account-token   3      2m56s
sa-demo-token-zdt4p   kubernetes.io/service-account-token   3      21s
```
åŒæ ·å¯ä»¥çœ‹åˆ°åˆ›å»º sa åç³»ç»Ÿä¹Ÿè‡ªåŠ¨åˆ›å»ºäº†ä¸€ä¸ªå¯¹åº”çš„ secret å¯¹è±¡ï¼Œå’Œä»¥å‰ç‰ˆæœ¬æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥è·å¾—è¯¥ secret å¯¹è±¡é‡Œé¢åŒ…å«çš„ token å€¼ï¼š
```sh
[root@localhost ~]# kubectl get secrets sa-demo-token-zdt4p  -o jsonpath='{.data.token}' | base64 -d
eyJhbGciOiJSUzI1NiIsImtpZCI6InJTUWd0TWhNR2MxUm4zRk1mVmo2VkFDaUNBdE5PSXVfU2RidmJVb3ItVFkifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6InNhLWRlbW8tdG9rZW4temR0NHAiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoic2EtZGVtbyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjBhNmQxNzBkLTA4MzktNGZjNi1iMzUxLTMxOWE1YzZkMzAxMiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OnNhLWRlbW8ifQ.Hsd43KUBg8zM5dVFyzn7VmVmPGgZ6bU0RZGUWVJf3JjeXN7EW2S3_unbdgT-pyiV0_6APJlrRB12CTmzTlzOkrxU03NtXinqYXAhKhBYH6CryooXpbnHQ-bBYABP0xS1Dxxd09E_TZFykzI8Un1yvXQryx_TuErZ8JKAiQ6bcuc8w53BII7VkddfpexN4NvB7su1P54QCN7bsBBFrHCtoQlZU4FIlB3Ve4ArDzGLmdTIzOeskXLnBxHcYRwfx0YRKIc2hPUEC4qiQpTnK7kCyQ2rSEQiey80pvTHYAtFFTDoottK7pFGgetN-LknCBXY9nWEKv23i_aa8zH6zzxK-w
```
åŒæ ·å°†è¯¥ token å€¼æ‹·è´åˆ° jwt.io ç½‘ç«™è¿›è¡Œè§£ç ã€‚
![](image/2024-03-02-20-34-32.png)

ä»è§£ç åçš„å€¼å¯ä»¥çœ‹åˆ°è¯¥ token å€¼é‡Œé¢åŒæ ·ä¸åŒ…å«ä»»ä½•è¿‡æœŸæ—¶é—´ï¼Œä¹Ÿè¯´æ˜äº†æˆ‘ä»¬åˆ›å»º sa ä¹‹åï¼Œæ‰€å¯¹åº”çš„ token æ˜¯æ°¸ä¸è¿‡æœŸçš„ã€‚åŒæ ·æˆ‘ä»¬å†æ¬¡ä½¿ç”¨ä¸Šé¢çš„ sa æ¥åˆ›å»ºä¸€ä¸ª Podï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```yaml
# demo-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: demo
spec:
  serviceAccount: sa-demo
  containers:
    - name: demo
      image: nginx:1.7.9
      ports:
        - containerPort: 80
```
ç›´æ¥åˆ›å»ºè¯¥ Podï¼š
```sh
[root@localhost ~]# kubectl apply -f demo-pod.yaml
pod/demo created
[root@localhost ~]# kubectl get pods
NAME   READY   STATUS    RESTARTS   AGE
demo   1/1     Running   0          41s
[root@localhost ~]# kubectl get pod demo -oyaml
apiVersion: v1
kind: Pod
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{},"name":"demo","namespace":"default"},"spec":{"containers":[{"image":"nginx:1.7.9","name":"demo","ports":[{"containerPort":80}]}],"serviceAccount":"sa-demo"}}
  creationTimestamp: "2024-03-02T12:35:21Z"
  name: demo
  namespace: default
  resourceVersion: "1135"
  uid: 0d9847b0-74b5-4ef8-b156-598ef1d20bbe
spec:
  containers:
  - image: nginx:1.7.9
    imagePullPolicy: IfNotPresent
    name: demo
    ports:
    - containerPort: 80
      protocol: TCP
    resources: {}
    terminationMessagePath: /dev/termination-log
    terminationMessagePolicy: File
    volumeMounts:
    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
      name: kube-api-access-nqcxk
      readOnly: true
    ......
  volumes:
  - name: kube-api-access-nqcxk
    projected:
      defaultMode: 420
      sources:
      - serviceAccountToken:
          expirationSeconds: 3607
          path: token
      - configMap:
          items:
          - key: ca.crt
            path: ca.crt
          name: kube-root-ca.crt
      - downwardAPI:
          items:
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
            path: namespace
    ......
```
å½“ Pod åˆ›å»ºåæŸ¥çœ‹å¯¹åº”çš„èµ„æºå¯¹è±¡ï¼Œå¯ä»¥çœ‹åˆ°å’Œä¹‹å‰çš„ç‰ˆæœ¬å·²ç»æœ‰ä¸€ä¸ªå¾ˆå¤§çš„åŒºåˆ«äº†ï¼Œå¹¶ä¸æ˜¯å°†ä¸Šé¢è‡ªåŠ¨åˆ›å»ºçš„ secretæŒ‚è½½åˆ°å®¹å™¨çš„ /var/run/secrets/kubernetes.io/serviceaccount ç›®å½•ã€‚æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ä¸‹ Pod ä¸­çš„ token å€¼æ¥å’Œ secret åŒ…å«çš„ token å€¼è¿›è¡Œå¯¹æ¯”ï¼š
```sh
[root@localhost ~]# kubectl exec -it demo --  ls /run/secrets/kubernetes.io/serviceaccount
ca.crt  namespace  token
[root@localhost ~]# kubectl exec -it demo -- cat  /run/secrets/kubernetes.io/serviceaccount/token
eyJhbGciOiJSUzI1NiIsImtpZCI6InJTUWd0TWhNR2MxUm4zRk1mVmo2VkFDaUNBdE5PSXVfU2RidmJVb3ItVFkifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzQwOTE4OTIxLCJpYXQiOjE3MDkzODI5MjEsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJkZWZhdWx0IiwicG9kIjp7Im5hbWUiOiJkZW1vIiwidWlkIjoiMGQ5ODQ3YjAtNzRiNS00ZWY4LWIxNTYtNTk4ZWYxZDIwYmJlIn0sInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJzYS1kZW1vIiwidWlkIjoiMGE2ZDE3MGQtMDgzOS00ZmM2LWIzNTEtMzE5YTVjNmQzMDEyIn0sIndhcm5hZnRlciI6MTcwOTM4NjUyOH0sIm5iZiI6MTcwOTM4MjkyMSwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRlZmF1bHQ6c2EtZGVtbyJ9.TrxAG_EdDAWraEmcvVnkrfrKfPhqiCeiSv0NxeUqVl1mSj2XSrzefyjtO2OgaBHac63sND0-0MPe3DRkQ7jpCr0m_I1W5tZnGsaqCa_-f6IbZKfapLZvxZCT0TcP_YkCCEkHlifRmD9HVibIfIHKP4psTkgWjxZLr841Etr17JjqxKKKxKWv6hdqQDD9PeX-Z0N6QiDwHqqU0B2iS6bolPjhjsTDx4Ey_ww8Bp-AcaSx98qM8q6tJGbA0ZvsJS9wuRZG44wdOthcDYvEr_4Mt12fgqOc29enFNyIO2Dx1fZ6xlC8RJFe_rtfeDl5LftBO5yChmfjLxWoIN3kQUG3pw
```
å¯ä»¥å¾ˆæ˜æ˜¾çœ‹åˆ°ç°åœ¨ Pod ä¸­çš„ token å€¼å’Œè‡ªåŠ¨åˆ›å»º secret çš„ token å€¼ä¸ä¸€æ ·äº†ï¼ŒåŒæ ·åœ¨ jwt.io è§£ç è¯¥ tokenå€¼ã€‚
![](image/2024-03-02-20-42-14.png)

å¯ä»¥çœ‹åˆ°è¯¥ token å€¼è§£ç åçš„ PAYLOAD æ•°æ®ä¸­åŒ…å«äº†å¾ˆå¤šä¸åŒçš„æ•°æ®ï¼Œå…¶ä¸­çš„ exp å­—æ®µè¡¨ç¤ºè¯¥ token çš„è¿‡æœŸæ—¶é—´ï¼Œå¯ä»¥çœ‹åˆ°è¿‡æœŸæ—¶é—´æ˜¯ 1 å¹´ã€‚

è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ€»ç»“ä¸‹åœ¨ v1.21 åˆ° v1.23 ç‰ˆæœ¬çš„ K8s é›†ç¾¤ï¼Œå½“åˆ›å»º ServiceAccount å¯¹è±¡åï¼Œç³»ç»Ÿä»ç„¶ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª secret å¯¹è±¡ï¼Œè¯¥ secret å¯¹è±¡é‡Œé¢åŒ…å«çš„ token ä»ç„¶æ˜¯æ°¸ä¸è¿‡æœŸçš„ï¼Œä½†æ˜¯ Pod é‡Œé¢å¹¶ä¸ä¼šä½¿ç”¨è¯¥ secret çš„token å€¼äº†ã€‚

åœ¨Kubernetesä¸­ï¼ŒæŠ•å°„å·ï¼ˆprojected volumeï¼‰å…è®¸ä½ å°†å¤šä¸ªä¸åŒæ¥æºçš„æ•°æ®â€œæŠ•å°„â€åˆ°åŒä¸€ä¸ªç›®å½•ä¸‹ï¼Œè¿™ä¸‰ä¸ªæ•°æ®æºåˆ†åˆ«ç”¨äºä¸åŒçš„ç›®çš„ï¼š
- serviceAccountToken æ•°æ®æºï¼šè¿™ä¸ªæ•°æ®æºæ˜¯ä¸€ä¸ªæ—¶é—´é™åˆ¶çš„æœåŠ¡è´¦æˆ·ä»¤ç‰Œï¼Œç”±kubeletä½¿ç”¨TokenRequest APIä»kube-apiserverè·å–ã€‚è¿™ä¸ªä»¤ç‰Œæ˜¯ä¸´æ—¶çš„ï¼Œå¹¶ä¸”ä¼šåœ¨Podè¢«åˆ é™¤æˆ–è€…ä»¤ç‰Œæœ¬èº«çš„ç”Ÿå‘½å‘¨æœŸç»“æŸåè¿‡æœŸã€‚è¿™ä¸ªè¿‡æœŸæœºåˆ¶å¢åŠ äº†å®‰å…¨æ€§ï¼Œå› ä¸ºå³ä½¿ä»¤ç‰Œè¢«æ³„æ¼ï¼Œå®ƒä¹Ÿåªåœ¨æœ‰é™çš„æ—¶é—´é‡Œæœ‰æ•ˆã€‚è¯¥ä»¤ç‰Œæ˜¯ä¸Podç»‘å®šçš„ï¼Œå¹¶ä¸”å°†å…¶audience(å—ä¼—)è®¾ç½®ä¸ºä¸kube-apiserverç›¸åŒ¹é…ï¼Œç¡®ä¿ä»¤ç‰Œåªèƒ½ç”¨äºè®¿é—®APIæœåŠ¡å™¨ã€‚è¿™ç§æœºåˆ¶å–ä»£äº†ä»¥å‰çš„åšæ³•ï¼Œå³é€šè¿‡Secretæä¾›ä¸ä¼šè¿‡æœŸçš„æœåŠ¡è´¦æˆ·ä»¤ç‰Œã€‚

- configMap æ•°æ®æºï¼šConfigMapé€šå¸¸ç”¨æ¥å­˜å‚¨é…ç½®æ•°æ®ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒå­˜å‚¨äº†è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰çš„æ•°æ®ã€‚è¿™äº›æ•°æ®åŒ…æ‹¬ç”¨äºéªŒè¯ä¸é›†ç¾¤çš„kube-apiserveré€šä¿¡çš„è¯ä¹¦ï¼Œç¡®ä¿Podsåœ¨ä¸APIæœåŠ¡å™¨é€šä¿¡æ—¶ä¸ä¼šè¢«ä¸­é—´äººæ”»å‡»æˆ–è¢«å¼•å¯¼åˆ°é”™è¯¯çš„æœåŠ¡å™¨ã€‚åŸºæœ¬ä¸Šï¼Œå®ƒæä¾›äº†é›†ç¾¤çš„æ ¹è¯ä¹¦é¢å‘æœºæ„çš„è¯ä¹¦ï¼ŒPodå¯ä»¥ä¿¡ä»»è¿™ä¸ªè¯ä¹¦é¢å‘æœºæ„ç­¾å‘çš„æ‰€æœ‰è¯ä¹¦ã€‚

- downwardAPI æ•°æ®æºï¼šdownwardAPIæ˜¯ä¸€ç§å…è®¸Podè®¿é—®æœ‰å…³å…¶è‡ªèº«æˆ–å…¶ç¯å¢ƒä¿¡æ¯çš„æœºåˆ¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒç”¨äºå°†Podæ‰€åœ¨çš„å‘½åç©ºé—´æš´éœ²ç»™Podå†…çš„åº”ç”¨ç¨‹åºã€‚è¿™å…è®¸åº”ç”¨ç¨‹åºçŸ¥é“è‡ªå·±åœ¨Kubernetesé›†ç¾¤ä¸­çš„ä½ç½®ï¼Œå¯èƒ½å¯¹äºç­–ç•¥æ‰§è¡Œã€æ—¥å¿—è®°å½•æˆ–å…¶ä»–ä¾èµ–äºçŸ¥é“å…¶æ‰€åœ¨å‘½åç©ºé—´çš„æ“ä½œå¾ˆæœ‰ç”¨ã€‚

æ€»ç»“æ¥è¯´ï¼Œè¿™ä¸‰ä¸ªæ•°æ®æºé€šè¿‡æŠ•å°„å·çš„å½¢å¼æä¾›äº†ä¸‰ä¸ªå…³é”®çš„åŠŸèƒ½ï¼šå®‰å…¨çš„æœåŠ¡è´¦æˆ·ä»¤ç‰Œã€è¯ä¹¦é¢å‘æœºæ„æ•°æ®ã€ä»¥åŠPodçš„å‘½åç©ºé—´ä¿¡æ¯ã€‚è¿™äº›æ•°æ®æºç»“åˆä½¿ç”¨ï¼Œæé«˜äº†Kubernetes Podçš„å®‰å…¨æ€§ï¼Œä¾¿æ·æ€§ï¼Œä»¥åŠå¯¹é›†ç¾¤ç¯å¢ƒçš„é€æ˜åº¦ã€‚

æ‰€ä»¥å½“å‰ç‰ˆæœ¬ K8s é›†ç¾¤åˆ›å»ºçš„ Pod é‡Œé¢åŒ…å«çš„ token ä¸æ˜¯ä½¿ç”¨ ServiceAccount è‡ªåŠ¨å…³è”secret å¯¹è±¡é‡Œé¢çš„ token ï¼Œè€Œæ˜¯ kubelet å‘ TokenRequest API å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œç”³è¯·ä¸€ä¸ªæ–°çš„ token æ”¾åœ¨ Pod çš„ /run/secrets/kubernetes.io/serviceaccount/token é‡Œã€‚è¿™ä¸ª token ä¼šåœ¨ 1 ä¸ªå°æ—¶åç”±kubelet é‡æ–°å»ç”³é¢†ä¸€ä¸ªæ–°çš„ tokenï¼Œæ‰€ä»¥ 1 å°æ—¶ä¹‹åå†æ¬¡æŸ¥çœ‹è¿™ä¸ª token çš„è¯ä¼šå‘ç° token çš„å†…å®¹æ˜¯å˜åŒ–çš„ï¼Œå¦‚æœåˆ é™¤æ­¤ Pod é‡æ–°åˆ›å»ºçš„è¯ï¼Œåˆ™ä¼šé‡æ–°ç”³é¢† tokenï¼Œè¢«åˆ é™¤ Pod é‡Œçš„ token ä¼šç«‹å³è¿‡æœŸã€‚è€Œä¸”æˆ‘ä»¬è¿˜å¯ä»¥æ‰‹åŠ¨ä½¿ç”¨ `kubectl create token <sa>` å‘½ä»¤æ¥è¯·æ±‚ ServiceAccount çš„ tokenï¼Œå¯ä»¥æŒ‡å®šæœ‰æ•ˆæœŸç­‰ï¼š
```sh
[root@localhost ~]# kubectl create token -h
Request a service account token.

Examples:
  # Request a token to authenticate to the kube-apiserver as the service account "myapp" in the current namespace
  kubectl create token myapp

  # Request a token for a service account in a custom namespace
  kubectl create token myapp --namespace myns

  # Request a token with a custom expiration
  kubectl create token myapp --duration 10m

  # Request a token with a custom audience
  kubectl create token myapp --audience https://example.com

  # Request a token bound to an instance of a Secret object
  kubectl create token myapp --bound-object-kind Secret --bound-object-name mysecret

  # Request a token bound to an instance of a Secret object with a specific UID
  kubectl create token myapp --bound-object-kind Secret --bound-object-name mysecret --bound-object-uid
0d4691ed-659b-4935-a832-355f77ee47cc
...
```

#### >= 1.24 ç‰ˆæœ¬
ç°åœ¨æˆ‘ä»¬å†æ¥çœ‹ä¸‹ v1.24 ç‰ˆæœ¬ä»¥ä¸Šçš„ K8s é›†ç¾¤ä¸­çš„ ServiceAccount token æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ kind å¿«é€Ÿåˆ›å»ºä¸€ä¸ª v1.25.3 ç‰ˆæœ¬çš„é›†ç¾¤ï¼š
```sh
â˜¸ âœ kind create cluster --name kind125 --image kindest/node:v1.25.3
â˜¸ âœ kubectl get nodes
NAME                    STATUS  ROLES                   AGE     VERSION
kind125-control-plane   Ready   control-plane,master    115s    v1.25.3
```
åŒæ ·åˆ›å»ºä¸€ä¸ªåä¸º sa-demo çš„ ServiceAccountï¼š
```sh
[root@localhost ~]# kubectl create sa sa-demo
serviceaccount/sa-demo created
[root@localhost ~]# kubectl get sa
NAME      SECRETS   AGE
default   0         5h40m
sa-demo   0         8s
[root@localhost ~]# kubectl get secrets
No resources found in default namespace.
```
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥ ServiceAccount åˆ›å»ºåå¹¶æ²¡æœ‰åˆ›å»ºå¯¹åº”çš„ Secret å¯¹è±¡ã€‚åŒæ ·æ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„ Podï¼š
```yaml
# demo-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: demo
spec:
  serviceAccount: sa-demo
  containers:
    - name: demo
      image: nginx:1.7.9
      ports:
        - containerPort: 80
```
åˆ›å»ºä¸Šé¢çš„ Pod åæŸ¥çœ‹è¯¦æƒ…ï¼š
```sh
[root@localhost ~]# kubectl apply -f demo-pod.yaml
pod/demo created
[root@localhost ~]# kubectl get pod
NAME   READY   STATUS    RESTARTS   AGE
demo   1/1     Running   0          38s
[root@localhost ~]# kubectl get pod demo -oyaml
apiVersion: v1
kind: Pod
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","kind":"Pod","metadata":{"annotations":{},"name":"demo","namespace":"default"},"spec":{"containers":[{"image":"nginx:1.7.9","name":"demo","ports":[{"containerPort":80}]}],"serviceAccount":"sa-demo"}}
  creationTimestamp: "2024-03-02T13:28:26Z"
  name: demo
  namespace: default
  resourceVersion: "23144"
  uid: 3b7a953e-4441-4b49-a8d0-ed0d9dc7878f
spec:
  containers:
  - image: nginx:1.7.9
    imagePullPolicy: IfNotPresent
    name: demo
    ports:
    - containerPort: 80
      protocol: TCP
    resources: {}
    terminationMessagePath: /dev/termination-log
    terminationMessagePolicy: File
    volumeMounts:
    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
      name: kube-api-access-k298c
      readOnly: true
......
  volumes:
  - name: kube-api-access-k298c
    projected:
      defaultMode: 420
      sources:
      - serviceAccountToken:
          expirationSeconds: 3607
          path: token
      - configMap:
          items:
          - key: ca.crt
            path: ca.crt
          name: kube-root-ca.crt
      - downwardAPI:
          items:
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
            path: namespace
            ......
```
å¯ä»¥çœ‹åˆ°åˆ›å»º Pod ååŒæ ·ä¼šè‡ªåŠ¨æ·»åŠ ä¸€ä¸ªæŠ•å°„å·åˆ° Podï¼Œæ­¤å·åŒ…æ‹¬äº†è®¿é—® Kubernetes API çš„ä»¤ç‰Œï¼Œå’Œ >=1.21 ç‰ˆæœ¬ && <=1.23 ç‰ˆæœ¬è¡¨ç°æ˜¯ä¸€è‡´çš„ã€‚åŒæ ·æˆ‘ä»¬å¯ä»¥ä¸‹æŸ¥çœ‹ Pod ä¸­çš„ token å€¼æ¥è¿›è¡ŒéªŒè¯ï¼š
```sh
[root@localhost ~]# kubectl exec -it demo -- cat /run/secrets/kubernetes.io/serviceaccount/token
eyJhbGciOiJSUzI1NiIsImtpZCI6InptcXlDdVBidXBkSE4wanJCZE1EMTZRcHRaemJrWE5GamR6c2tacENpcjgifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzQwOTIyMTA2LCJpYXQiOjE3MDkzODYxMDYsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJkZWZhdWx0IiwicG9kIjp7Im5hbWUiOiJkZW1vIiwidWlkIjoiM2I3YTk1M2UtNDQ0MS00YjQ5LWE4ZDAtZWQwZDlkYzc4NzhmIn0sInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJzYS1kZW1vIiwidWlkIjoiNjc4YTAyYjEtMDkwMy00MjI3LThlODktOTVjYjExNGQyODY3In0sIndhcm5hZnRlciI6MTcwOTM4OTcxM30sIm5iZiI6MTcwOTM4NjEwNiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRlZmF1bHQ6c2EtZGVtbyJ9.B74VmOKR2bK6IgpbbeA4lLf7bI6sNBo_BK0ODQuJwMF-YEsIXEi2-9CU3gz1RlcYXJ1b0uOpkWTpTX_dvNVLspRzYIeNbQkbN2VQ5-nt1gPukoTZtMxQw1XI331t53603Qe_zIO7udf79DMIV7CjbDDo3p4wqOPsgPdFU6Y_NEvpPg7vsaLmw94_AVeSnO79bK8hcWS26X147IKPjuACAf1FWAHDl0yr_-fT4aEVC2hlz3Zts66RgYSQrz25uZDdQZyXm3ByV2FoWitKulznN1r4oobDERPQBcef30qEl_-WdwK9YzRQ_Zzex0vLsKAE5mxnlJfeck-jQF001aUmlw
```
æˆ‘ä»¬å¯ä»¥æŠŠä¸Šé¢è¾“å‡ºçš„ token å€¼æ‹·è´åˆ° jwt.io é‡Œè¿›è¡Œè§£ç ã€‚
![](image/2024-03-02-21-33-11.png)

ä»ä¸Šé¢çš„æ•°æ®å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ token çš„æœ‰æ•ˆæœŸä¹Ÿä¸º 1 å¹´ï¼Œè¿™ä¸ª token åœ¨ Pod é‡Œä¹Ÿæ˜¯æ¯ 1 å°æ—¶ä¼šæ›´æ–°ä¸€æ¬¡ï¼Œå¦‚æœPod è¢«åˆ é™¤é‡å»ºï¼Œé‚£ä¹ˆä¼šé‡æ–°ç”³é¢†ä¸€ä¸ªæ–°çš„ tokenï¼Œè¢«åˆ é™¤ Pod é‡Œçš„ token ç«‹å³è¿‡æœŸã€‚éœ€è¦æ³¨æ„çš„æ²¡æœ‰ç‰¹å®šçš„æœºåˆ¶ä½¿é€šè¿‡ TokenRequest ç­¾å‘çš„ä»¤ç‰Œæ— æ•ˆï¼Œå¦‚æœä½ ä¸å†ä¿¡ä»»ä¸ºæŸä¸ª Pod ç»‘å®šçš„ServiceAccount ä»¤ç‰Œï¼Œä½ å¯ä»¥åˆ é™¤è¯¥ Podï¼Œåˆ é™¤ Pod å°†ä½¿å…¶ç»‘å®šçš„ä»¤ç‰Œè¿‡æœŸã€‚

æˆ‘ä»¬å¯ä»¥ç®€å•æ€»ç»“ä¸‹ä¸åŒç‰ˆæœ¬çš„ K8s é›†ç¾¤ä¸‹é¢çš„ ServiceAccount Token æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚
- 1.20ï¼ˆå« 1.20ï¼‰ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œåœ¨åˆ›å»º sa æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª secretï¼Œç„¶åè¿™ä¸ªä¼šæŠŠè¿™ä¸ª secret é€šè¿‡æŠ•å°„å·æŒ‚è½½åˆ° pod é‡Œï¼Œè¯¥ secret é‡Œé¢åŒ…å«çš„ token æ˜¯æ°¸ä¹…æœ‰æ•ˆçš„ã€‚
- 1.21~1.23 ç‰ˆæœ¬ï¼Œåœ¨åˆ›å»º sa æ—¶ä¹Ÿä¼šè‡ªåŠ¨åˆ›å»º secretï¼Œä½†æ˜¯åœ¨ pod é‡Œå¹¶ä¸ä¼šä½¿ç”¨ secret é‡Œçš„ tokenï¼Œè€Œæ˜¯ç”±kubelet åˆ° TokenRequest API å»ç”³è¯·ä¸€ä¸ª tokenï¼Œè¯¥ token é»˜è®¤æœ‰æ•ˆæœŸä¸ºä¸€å¹´ï¼Œä½†æ˜¯ pod æ¯ä¸€ä¸ªå°æ—¶ä¼šæ›´æ–°ä¸€æ¬¡ tokenã€‚
- 1.24 ç‰ˆæœ¬åŠä»¥ä¸Šï¼Œåœ¨åˆ›å»º sa æ—¶ä¸å†è‡ªåŠ¨åˆ›å»º secret äº†ï¼Œåªä¿ç•™ç”± kubelet åˆ° TokenRequest API å»ç”³è¯·tokenã€‚

å½“ç„¶æˆ‘ä»¬ä»ç„¶å¯ä»¥æ‰‹åŠ¨åˆ›å»º Secret æ¥ä¿å­˜ ServiceAccount ä»¤ç‰Œï¼Œä¾‹å¦‚åœ¨ä½ éœ€è¦ä¸€ä¸ªæ°¸ä¸è¿‡æœŸçš„ä»¤ç‰Œçš„æ—¶å€™ã€‚ä¸€æ—¦æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª Secret å¹¶å°†å…¶å…³è”åˆ° ServiceAccountï¼ŒKubernetes æ§åˆ¶å¹³é¢å°±ä¼šè‡ªåŠ¨å°†ä»¤ç‰Œå¡«å……åˆ°è¯¥ Secret ä¸­ã€‚
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: my-service-account-token
  annotations:
    kubernetes.io/service-account.name: "my-service-account"
type: kubernetes.io/service-account-token
```
å®šä¹‰ä¸€ä¸ª Secret çš„ YAML æ–‡ä»¶ï¼Œç¡®ä¿æŒ‡å®š type ä¸º kubernetes.io/service-account-tokenã€‚åœ¨è¿™ä¸ª YAML æ–‡ä»¶ä¸­ï¼Œname æ˜¯ä½ ä¸º Secret é€‰æ‹©çš„åç§°ï¼Œannotations å­—æ®µæŒ‡å®šè¿™ä¸ª Secret ä¸å“ªä¸ª ServiceAccount ç›¸å…³è”ã€‚Secret è¢«åˆ›å»ºåï¼ŒKubernetes æ§åˆ¶å¹³é¢ä¼šå¡«å…… token å­—æ®µã€‚ä½ å¯ä»¥é€šè¿‡è¿è¡Œ kubectl describe secret my-service-account-token æ¥æ£€æŸ¥å®ƒã€‚

å°½ç®¡å­˜åœ¨æ‰‹åŠ¨åˆ›å»ºé•¿ä¹… ServiceAccount ä»¤ç‰Œçš„æœºåˆ¶ï¼Œä½†è¿˜æ˜¯æ¨èä½¿ç”¨ TokenRequest è·å¾—çŸ­æœŸçš„ API è®¿é—®ä»¤ç‰Œã€‚

### ä¸º ServiceAccount åˆ†é…æƒé™
ä¸Šé¢æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåªèƒ½è®¿é—®æŸä¸ªå‘½åç©ºé—´ä¸‹é¢çš„æ™®é€šç”¨æˆ·ï¼Œæˆ‘ä»¬å‰é¢ä¹Ÿæåˆ°è¿‡ subjects ä¸‹é¢è¿˜æœ‰ä¸€ç§ç±»å‹çš„ä¸»é¢˜èµ„æºï¼š ServiceAccount ï¼Œç°åœ¨æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªé›†ç¾¤å†…éƒ¨çš„ç”¨æˆ·åªèƒ½æ“ä½œ kube-system è¿™ä¸ªå‘½åç©ºé—´ä¸‹é¢çš„ pods å’Œdeploymentsï¼Œé¦–å…ˆæ¥åˆ›å»ºä¸€ä¸ª ServiceAccount å¯¹è±¡ï¼š
```sh
kubectl create sa cnych-sa -n kube-system
```
å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å®šä¹‰æˆ YAML æ–‡ä»¶çš„å½¢å¼æ¥åˆ›å»ºï¼š
```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cnych-sa
  namespace: kube-system
```
ç„¶åæ–°å»ºä¸€ä¸ª Role å¯¹è±¡ï¼š
```yaml
# cnych-sa-role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: cnych-sa-role
  namespace: kube-system
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "watch", "list"]
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
```
å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¿™é‡Œå®šä¹‰çš„è§’è‰²æ²¡æœ‰åˆ›å»ºã€åˆ é™¤ã€æ›´æ–° Pod çš„æƒé™ï¼Œå¾…ä¼šæˆ‘ä»¬å¯ä»¥é‡ç‚¹æµ‹è¯•ä¸€ä¸‹ï¼Œåˆ›å»ºè¯¥ Role å¯¹è±¡ï¼š
```sh
[root@localhost ~]# kubectl apply -f cnych-sa-role.yaml
role.rbac.authorization.k8s.io/cnych-sa-role created
```
ç„¶ååˆ›å»ºä¸€ä¸ª RoleBinding å¯¹è±¡ï¼Œå°†ä¸Šé¢çš„ cnych-sa å’Œè§’è‰² cnych-sa-role è¿›è¡Œç»‘å®šï¼š
```yaml
# cnych-sa-rolebinding.yaml
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: cnych-sa-rolebinding
  namespace: kube-system
subjects:
  - kind: ServiceAccount
    name: cnych-sa
    namespace: kube-system
roleRef:
  kind: Role
  name: cnych-sa-role
  apiGroup: rbac.authorization.k8s.io
```
æ·»åŠ è¿™ä¸ªèµ„æºå¯¹è±¡ï¼š
```sh
[root@localhost ~]# kubectl create -f cnych-sa-rolebinding.yaml
rolebinding.rbac.authorization.k8s.io/cnych-sa-rolebinding created
```
ç„¶åæˆ‘ä»¬æ€ä¹ˆå»éªŒè¯è¿™ä¸ª ServiceAccount å‘¢ï¼Ÿä»¥å‰çš„ç‰ˆæœ¬ ServiceAccount ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª Secret å¯¹è±¡å’Œå®ƒè¿›è¡Œæ˜ å°„ï¼Œè¿™ä¸ª Secret é‡Œé¢åŒ…å«ä¸€ä¸ª tokenï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ª token å»ç™»å½• Dashboardï¼Œç„¶åå°±å¯ä»¥åœ¨ Dashboard ä¸­æ¥éªŒè¯æˆ‘ä»¬çš„åŠŸèƒ½æ˜¯å¦ç¬¦åˆé¢„æœŸäº†ï¼Œä½†æ˜¯ç°åœ¨çš„ç‰ˆæœ¬é»˜è®¤å·²ç»ä¸æ”¯æŒè¿™ç§æ–¹å¼äº†ã€‚

ä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªé•¿ä¹…æœ‰æ•ˆçš„ ServiceAccount ä»¤ç‰Œï¼Œè¦ä¸º ServiceAccount åˆ›å»ºä¸€ä¸ªä¸è¿‡æœŸã€æŒä¹…åŒ–çš„API ä»¤ç‰Œï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªç±»å‹ä¸º kubernetes.io/service-account-token çš„ Secretï¼Œé™„å¸¦å¼•ç”¨ServiceAccount çš„æ³¨è§£ã€‚æ§åˆ¶å¹³é¢éšåç”Ÿæˆä¸€ä¸ªé•¿ä¹…çš„ä»¤ç‰Œï¼Œå¹¶ä½¿ç”¨ç”Ÿæˆçš„ä»¤ç‰Œæ•°æ®æ›´æ–°è¯¥ Secretã€‚æ¯”å¦‚æˆ‘ä»¬è¿™é‡Œå¯ä»¥åˆ›å»ºä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„ Secret èµ„æºå¯¹è±¡ï¼š
```yaml
# cnych-token.yaml
apiVersion: v1
kind: Secret
metadata:
  name: cnych-sec
  namespace: kube-system
  annotations:
    kubernetes.io/service-account.name: cnych-sa
type: kubernetes.io/service-account-token
```
ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ `kubectl create token cnych-sa --duration 10m -n kube-system` å‘½ä»¤æ¥åˆ›å»º tokenã€‚

åˆ›å»ºåæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¯¥ Secret å¯¹è±¡åŒ…å«çš„ token å»ç™»å½•æˆ‘ä»¬çš„ Dashboardã€‚
```sh
[root@master rbac]# kubectl get secret cnych-sec -o jsonpath={.data.token} -n kube-system |base64 -d
eyJhbGciOiJSUzI1NiIsImtpZCI6IjRMcGFKbEFtZmlKWEtNQ09VZTd4NEN3S0pSN3NCYUZoMkloYlJDU0Z4ZnMifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJjbnljaC1zZWMiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiY255Y2gtc2EiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJkZWFjZGI4Yy0wYjg2LTQyNTQtOGY2NC0yYTAwZDY3MTgyZTQiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06Y255Y2gtc2EifQ.qfVdH_TS2LaeEIwvklx0vIfcGuaJtP1t7lt6_deRtiBMftJzR-rSEuAPLVGB3cqIG6nCs7Je0qeUGt0SlwImSWHSqnOJm8kmXtFJUSq0EGYVH2rxShhsEQ0Ee4XWnuTHuA922NkTyq05HYKDuODpIKhdJZY8Vybh_ycloiySGaN-f3fbfXlcZsxvDcwrD01O1n2GmMz_pd89F0m1lkFfIrsf99-e4k62wa-QkN1lJl8dSZGBGXpJid-9090iu4gUQwYLZdeUIdxxcNdCC3mWRqL8bIzo4J76wq__PJm0U_vlGaZO3QEVp-NSFq1X_O0xR8SkDvCotvK2xC88SpO8bw
```
ä½¿ç”¨è¿™é‡Œçš„ token å» Dashboard é¡µé¢è¿›è¡Œç™»å½•ï¼š
![](image/2024-03-04-14-58-00.png)
![](image/2024-03-04-14-58-47.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„æç¤ºä¿¡æ¯è¯´æˆ‘ä»¬ç°åœ¨ä½¿ç”¨çš„è¿™ä¸ª ServiceAccount æ²¡æœ‰æƒé™è·å–å½“å‰å‘½åç©ºé—´ä¸‹é¢çš„èµ„æºå¯¹è±¡ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬ç™»å½•è¿›æ¥åé»˜è®¤è·³è½¬åˆ° default å‘½åç©ºé—´ï¼Œæˆ‘ä»¬åˆ‡æ¢åˆ° kube-system å‘½åç©ºé—´ä¸‹é¢å°±å¯ä»¥äº†ï¼ˆéœ€è¦æ‰‹åŠ¨ä¿®æ”¹æµè§ˆå™¨ä¸­çš„ url åœ°å€ï¼Œå› ä¸ºæ²¡æœ‰æƒé™è·å¾—æ‰€æœ‰å‘½åç©ºé—´ï¼‰ï¼š
![](image/2024-03-04-15-02-33.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯ä»¥è®¿é—® pod åˆ—è¡¨äº†ï¼Œä½†æ˜¯ä¹Ÿä¼šæœ‰ä¸€äº›å…¶ä»–é¢å¤–çš„æç¤ºï¼šstatefulsets.apps is forbidden: User "system:serviceaccount:kube-system:cnych-sa" cannot list resource "statefulsets" in API group "apps" in the namespace "kube-system" ï¼Œè¿™æ˜¯å› ä¸ºå½“å‰ç™»å½•ç”¨åªè¢«æƒäº†è®¿é—® pod å’Œ deployment çš„æƒé™ï¼ŒåŒæ ·çš„ï¼Œè®¿é—®ä¸‹ deployment çœ‹çœ‹å¯ä»¥äº†å—ï¼Ÿ

åŒæ ·çš„ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥å¯¹è®¿é—®ç”¨æˆ·çš„æƒé™è¿›è¡Œé™åˆ¶ï¼Œå¯ä»¥è‡ªå·±é€šè¿‡ Role å®šä¹‰æ›´åŠ ç»†ç²’åº¦çš„æƒé™ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç³»ç»Ÿå†…ç½®çš„ä¸€äº›æƒé™â€¦â€¦

## å¯ä»¥å…¨å±€è®¿é—®çš„ ServiceAccount
åˆšåˆšæˆ‘ä»¬åˆ›å»ºçš„ cnych-sa è¿™ä¸ª ServiceAccount å’Œä¸€ä¸ª Role è§’è‰²è¿›è¡Œç»‘å®šçš„ï¼Œå¦‚æœæˆ‘ä»¬ç°åœ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ ServiceAccountï¼Œéœ€è¦ä»–æ“ä½œçš„æƒé™ä½œç”¨äºæ‰€æœ‰çš„ namespaceï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨åˆ° ClusterRole å’Œ ClusterRoleBinding è¿™ä¸¤ç§èµ„æºå¯¹è±¡äº†ã€‚åŒæ ·ï¼Œé¦–å…ˆæ–°å»ºä¸€ä¸ª ServiceAcount å¯¹è±¡ï¼š
```yaml
# cnych-sa2.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cnych-sa2
  namespace: kube-system
```
åˆ›å»ºï¼š
```sh
[root@master rbac]# kubectl apply -f cnych-sa2.yaml
serviceaccount/cnych-sa2 created
```
ç„¶ååˆ›å»ºä¸€ä¸ª ClusterRoleBinding å¯¹è±¡
```yaml
# cnych-clusterolebinding.yaml
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: cnych-sa2-clusterrolebinding
subjects:
  - kind: ServiceAccount
    name: cnych-sa2
    namespace: kube-system
roleRef:
  kind: ClusterRole
  name: cluster-admin
  apiGroup: rbac.authorization.k8s.io
```
ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ²¡æœ‰ä¸ºè¿™ä¸ªèµ„æºå¯¹è±¡å£°æ˜ namespaceï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ª ClusterRoleBinding èµ„æºå¯¹è±¡ï¼Œæ˜¯ä½œç”¨äºæ•´ä¸ªé›†ç¾¤çš„ï¼Œæˆ‘ä»¬ä¹Ÿæ²¡æœ‰å•ç‹¬æ–°å»ºä¸€ä¸ª ClusterRole å¯¹è±¡ï¼Œè€Œæ˜¯ä½¿ç”¨çš„ cluster-admin è¿™ä¸ªå¯¹è±¡ï¼Œè¿™æ˜¯ Kubernetes é›†ç¾¤å†…ç½®çš„ ClusterRole å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `kubectl get clusterrole` å’Œ `kubectl get clusterrolebinding` æŸ¥çœ‹ç³»ç»Ÿå†…ç½®çš„ä¸€äº›é›†ç¾¤è§’è‰²å’Œé›†ç¾¤è§’è‰²ç»‘å®šï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„ cluster-admin è¿™ä¸ªé›†ç¾¤è§’è‰²æ˜¯æ‹¥æœ‰æœ€é«˜æƒé™çš„é›†ç¾¤è§’è‰²ï¼Œæ‰€ä»¥ä¸€èˆ¬éœ€è¦è°¨æ…ä½¿ç”¨è¯¥é›†ç¾¤è§’è‰²ã€‚

åˆ›å»ºä¸Šé¢é›†ç¾¤è§’è‰²ç»‘å®šèµ„æºå¯¹è±¡ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ kubectl create token å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ token å»ç™»å½• Dashboardï¼š
```sh
[root@master rbac]# kubectl create token cnych-sa2 -n kube-system
eyJhbGciOiJSUzI1NiIsImtpZCI6IjRMcGFKbEFtZmlKWEtNQ09VZTd4NEN3S0pSN3NCYUZoMkloYlJDU0Z4ZnMifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzA5NTQwMTI5LCJpYXQiOjE3MDk1MzY1MjksImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJjbnljaC1zYTIiLCJ1aWQiOiI4MDA3ZTRkNi1hMjU2LTQxZmUtYmY1ZS04MTA0OGY3ZDQwZjgifX0sIm5iZiI6MTcwOTUzNjUyOSwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmNueWNoLXNhMiJ9.HfUd1teieQSNLOes0BfzYztWj8S-tXLCDKrt66mpLM9mt162faF1ciI7g8F-Jq-3QUVIv3DrkDXY0nVNSj_Tmn7FR62OmkuPe_M0ga2QO2f9sqyHzhrwfftqwRixZ15xUGWAN_C-1BKbO0sefDitZ2x7pJw9FEy7o0KSpf-DNWBeLHlXPMJ1e1P-HnYXfc5Q5Pb24LsYzWn1s5zAnfWsvTASYhs7K-35R_LCvuqKEnKB-rwmryPTHpfNKyUtQmD7a9282eRdFn2pHF-oSoYFnvM0f3PIVMnC1liJdd59LFXy6g--PI425NRIyHyeK_G0QiTRsHznlT9-mFu6u9PYeg
```
å¯ä»¥çœ‹åˆ°ä½¿ç”¨è¯¥ token ç™»å½•åæ²¡æœ‰å‡ºç°ä»»ä½•æƒé™ç›¸å…³é”™è¯¯äº†ï¼š
![](image/2024-03-04-15-17-18.png)

æˆ‘ä»¬åœ¨æœ€å¼€å§‹æ¥è§¦åˆ° RBAC è®¤è¯çš„æ—¶å€™ï¼Œå¯èƒ½ä¸å¤ªç†Ÿæ‚‰ï¼Œç‰¹åˆ«æ˜¯ä¸çŸ¥é“åº”è¯¥æ€ä¹ˆå»ç¼–å†™ rules è§„åˆ™ï¼Œå¤§å®¶å¯ä»¥å»åˆ†æç³»ç»Ÿè‡ªå¸¦çš„ clusterroleã€clusterrolebinding è¿™äº›èµ„æºå¯¹è±¡çš„ç¼–å†™æ–¹æ³•ï¼Œæ€ä¹ˆåˆ†æï¼Ÿè¿˜æ˜¯åˆ©ç”¨ kubectl çš„ getã€describeã€-oyaml è¿™äº›æ“ä½œï¼Œæ‰€ä»¥ kubectl æœ€åŸºæœ¬çš„æ“ä½œç”¨æˆ·ä¸€å®šè¦æŒæ¡å¥½ã€‚