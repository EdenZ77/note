# **第四部分 自己扩展**

## **列式存储**

参考资料：https://zhuanlan.zhihu.com/p/35622907

**列式存储（Column-oriented Storage）**并不是一项新技术，最早可以追溯到 1983 年的论文 Cantor。然而，受限于早期的硬件条件和使用场景，主流的事务型数据库（OLTP）大多采用行式存储，直到近几年分析型数据库（OLAP）的兴起，列式存储这一概念又变得流行。

总的来说，列式存储的优势一方面体现在存储上能节约空间、减少 IO，另一方面依靠列式数据结构做了计算上的优化。本文中着重介绍列式存储的数据组织方式，包括数据的布局、编码、压缩等。在下一篇文章中将介绍计算层以及 DBMS 整体架构设计。

### **什么是列式存储**

传统 OLTP 数据库通常采用行式存储。以下图为例，所有的列依次排列构成一行，以行为单位存储，再配合以 B+ 树或 SS-Table 作为索引，就能快速通过主键找到相应的行数据。

​    ![0](https://note.youdao.com/yws/res/23825/WEBRESOURCE1032d840723de2cc7e8cbb1a8a5d7a62)

行式存储对于 OLTP 场景是很自然的：大多数操作都以实体（entity）为单位，即大多为增删改查一整行记录，显然把一行数据存在物理上相邻的位置是个很好的选择。

然而，对于 OLAP 场景，一个典型的查询需要遍历整个表，进行分组、排序、聚合等操作，这样一来按行存储的优势就不复存在了。更糟糕的是，分析型 SQL 常常不会用到所有的列，而仅仅对其中某些感兴趣的列做运算，那一行中那些无关的列也不得不参与扫描。

列式存储就是为这样的需求设计的。如下图所示，同一列的数据被一个接一个紧挨着存放在一起，表的每列构成一个长数组。

​    ![0](https://note.youdao.com/yws/res/23829/WEBRESOURCE50208f35be4bca43ac2b7621fc8a7209)

显然，列式存储对于 OLTP 不友好，一行数据的写入需要同时修改多个列。但对 OLAP 场景有着很大的优势：

- 当查询语句只涉及部分列时，只需要扫描相关的列
- 每一列的数据都是相同类型的，彼此间相关性更大，对列数据压缩的效率较高

### **BigTable（HBase）是列式存储吗？**

两者关系： Bigtable（由 Google 开发的一个分布式存储系统，Bigtable 的设计细节首次在 2006 年的一篇研究论文中被公开，并且它对后续的 NoSQL 数据库设计产生了很大影响。） 和 HBase （HBase 是一个开源的非关系型分布式数据库（NoSQL），它是 Apache 软件基金会的一个项目，设计上受到了 Google Bigtable 的启发。HBase 是 Hadoop 生态系统的一部分，它在 Hadoop 分布式文件系统（HDFS）之上提供了 Bigtable 类似的能力。）是不同的产品（一个是商业服务，另一个是开源项目），但 HBase 模仿了 Bigtable 的设计；Bigtable 是 Google 的专有技术，而 HBase 是受 Bigtable 影响的开源实现，是对 Bigtable 概念的一种开源应用。

很多文章将 BigTable 归为列式存储。但严格地说，BigTable 并非列式存储，虽然论文中提到借鉴了 C-Store 等列式存储的某些设计，但 BigTable 本身按 Key-Value Pair 存储数据，和列式存储并无关系。

有一点迷惑的是 BigTable 的列簇（column family）概念，列簇可以被指定给某个 locality group，决定了该列簇数据的物理位置，从而可以让同一主键的各个列簇分别存放在最优的物理节点上。由于 column family 内的数据通常具有相似性，对它做压缩要比对整个表压缩效果更好。

另外，值得强调的一点是：列式数据库可以是关系型、也可以是 NoSQL，这和是否是列式并无关系。本文中讨论的 C-Store 就采用了关系模型。

​    ![0](https://note.youdao.com/yws/res/23843/WEBRESOURCEdb57f6c07cce834396f26171d82a12d5)

让GPT帮我们解释一下上面的内容吧

------

确实，Bigtable 中的列簇（column family）概念对于理解其数据模型是非常关键的。列簇是 Bigtable 存储结构的核心组成部分，它影响数据的存储方式和访问性能。下面我会详细解释列簇和 locality group 的概念，以及它们如何影响数据的物理存储。

**列簇（Column Family）：**

在 Bigtable 中，所有数据都组织在表格中，而表格由行和列组成。列被进一步组织为列簇，这意味着每个列簇包含一组列。列簇内的列通常具有相关的数据类型或访问模式。例如，一个人的个人信息可以是一个列簇，而他的交易记录可以是另一个列簇。

**Locality Group：**

Bigtable 允许将列簇分配给所谓的 locality group。Locality group 是物理存储的概念，它决定了列簇中的数据如何在磁盘上存储。通过将列簇分配给不同的 locality group，可以优化数据的访问模式，因为相关的数据可以被存储在一起，提高数据读取的局部性。例如，频繁访问的列簇可以放在快速存储介质上，而不经常访问的数据可以放在慢速存储上。

**压缩：**

由于列簇内的数据通常具有相似性，对列簇进行压缩通常比对整个表进行压缩效果更好。这是因为相似的数据更容易压缩，而且列簇内的数据模式和访问模式的一致性使得压缩算法能够更高效地工作。

**列式存储与关系模型：**

您提到的另一个重要点是列式存储（column-oriented storage）可以用于关系型数据库和 NoSQL 数据库。列式存储的关键优势是它能够高效地执行针对特定列的查询，因为它只需要读取相关的列，而不是整行数据。这在分析和报表生成等操作中特别有用。C-Store 是一个采用关系模型的列式数据库的例子，它证明了列式存储不仅限于 NoSQL 数据库。

总的来说，Bigtable 的列簇和 locality group 功能提供了一种灵活的方法来优化数据的物理存储和访问。而列式存储的概念可以跨越不同类型的数据库系统，无论它们是基于关系模型还是非关系模型（NoSQL）。

#### **C-Store简介**

大多数 DBMS 都是为写优化，而 C-Store 是第一个为读优化的 OLTP 数据库系统，虽然从今天的视角看它应当算作 HTAP 。C-Store 可能是第一个现代的列式存储数据库实现，其的设计启发了无数后来的商业或开源数据库，就比如 Vertica。

C-Store 是关系型数据库，它的逻辑表和其他数据库中的并没有什么不同。但是在 C-Store 内部，逻辑表被纵向拆分成 projections，每个 projection 可以包含一个或多个列，甚至可以包含来自其他逻辑表的列。当然，每个列至少会存在于一个 projections 上。

​    ![0](https://note.youdao.com/yws/res/23862/WEBRESOURCEa43daad4936ba1530ebda39411372827)

Projection 内是以列式存储的：里面的每个列分别用一个数据结构存放。为了避免列太长引起问题，也支持每个 projection 以 sort key 的值做横向切分。

## **NoSQL**

NoSQL（通常解释为"Not Only SQL"）是一类数据库管理系统，它们与传统的关系型数据库（如MySQL、PostgreSQL等）不同，不一定遵循严格的关系模型。NoSQL数据库设计用于处理大规模数据分布式存储和操作的需求，特别是在需要高性能、可伸缩性、灵活的数据模型和简单设计时。

基于 BASE 理论支撑的 NoSQL 运动坚持创造各种可用性优先、数据一致性其次的方案，而传统数据库则坚守 ACID 特性（原子性、一致性、隔离性、持久性），优先数据一致性，在必要的时候，可以放弃系统可用性。当时 BASE 理论还没有被广泛接受，人们还是不愿意放弃 ACID 的优点。

当 CAP 理论提出后，我们明白了在分布式系统中，只能在强一致性和 100% 的可用性之间二选一，不能两个都要。从此 BASE 理论也逐渐被人们所接受，在大规模存储的场景中广泛应用，并且开创了从 2000 年到 2010 年， NoSQL 运动的黄金十年。这十年里，工业界产生了大量优秀的 NoSQL 系统，比如 BigTable 、 HBase 、 MongoDB 、 Cassandra ，解决了人们当时遇到的大规模数据存储的问题。

CAP 理论的出现是有历史使命的，让人们能够在分布式系统中，放弃以关系数据库为代表的 ACID 强一致性系统，接受以 NoSQL 为代表的 BASE 理论，并且暂时解决了人们在 2000 年前后对于分布式系统中，数据一致性和可用性之间的争论，让人们能够更加务实地解决当时由于互联网爆发式发展，产生的海量用户和数据的分布式计算与存储的问题。

NoSQL数据库主要有以下几种类型：

\1. 键值存储（Key-Value Stores）

键值存储是最简单的NoSQL数据库类型，以键值对的形式存储数据。它们提供快速查询和简单的数据模型，使其非常适合用于存储会话信息、用户配置、缓存等。代表性的键值存储数据库包括Redis和Amazon DynamoDB。

\2. 列存储（Column-Family Stores）

列存储数据库将数据以列族的形式存储在行中，这使得对大量数据的聚合操作变得非常高效。它们适合处理大数据量的分析工作负载，例如时间序列数据、大型数据仓库等。Apache Cassandra和HBase是这类数据库的例子。

\3. 文档型数据库（Document Stores）

文档型数据库以文档（通常是JSON、XML或BSON格式）的形式存储数据。每个文档都是一个独立的数据单元，它们可以嵌套复杂的数据结构。文档数据库非常适合内容管理系统、电子商务应用等。MongoDB和Couchbase是流行的文档型数据库。

\4. 图数据库（Graph Stores）

图数据库专门用于处理图结构数据，如社交网络、推荐系统和网络拓扑等。它们通过节点、边和属性来存储和查询关系密集的数据。Neo4j和Amazon Neptune是图数据库的例子。

NoSQL数据库的特点：

- 灵活性：NoSQL数据库通常不需要预先定义模式（Schema），这使得在快速迭代和开发时可以更灵活地处理数据结构的变化。
- 水平可伸缩性：许多NoSQL数据库被设计为易于水平扩展，通过在多个服务器或节点上分布数据来处理更大的数据集和更高的吞吐量。
- 高性能：对于特定类型的查询和操作，NoSQL数据库通常提供更高的性能，尤其是在数据分布式存储和高并发访问的场景中。
- 高可用性和容错性：NoSQL数据库设计为支持复制、分区和分布式存储，以提供高可用性和容错性。

使用场景：

NoSQL数据库适用于很多不同的场景，尤其是当应用程序需要处理大量数据、快速开发、灵活的数据模型或者分布式架构时。它们在大数据、实时Web应用、云计算和移动应用中尤为流行。

总结：

NoSQL数据库是一组多样化的技术，旨在解决传统关系型数据库在某些情况下可能遇到的问题，如可伸缩性、性能和模式的灵活性。它们不是为了替代传统的SQL数据库，而是作为在处理某些类型的数据和应用程序时的补充或替代方案。根据应用程序的特定需求和数据工作负载选择合适的数据库类型是至关重要的。

## **NewSQL**

NewSQL 是一种数据库技术，旨在结合传统关系型数据库系统的良好特性（如SQL兼容性、ACID事务和关系数据模型）与NoSQL系统的可伸缩性和高性能。NewSQL数据库试图在不牺牲事务一致性和数据完整性的前提下，解决关系型数据库在大型分布式系统中扩展性的限制。

**核心特性**

1. ACID事务：NewSQL数据库支持原子性、一致性、隔离性、持久性（ACID）事务，确保了数据的可靠性和一致性，特别是在并发操作和分布式系统中。
2. 可扩展性：通过分布式架构，NewSQL数据库可以水平扩展到多个服务器或节点，以处理大量数据和高并发事务。
3. SQL兼容性：尽管具有分布式特性，NewSQL数据库通常兼容SQL标准，这意味着它们可以无缝地与支持SQL的应用程序集成。
4. 高性能：NewSQL数据库旨在提供低延迟和高吞吐量的在线事务处理（OLTP），同时也支持复杂查询和在线分析处理（OLAP）。

**实现方式**

NewSQL数据库的实现方式不尽相同，但它们通常涉及以下几个关键技术：

1. 分布式架构：能够在多个实例或节点之间分发数据和负载，从而提高系统的并发能力和容错性。
2. 分区（Sharding）：将数据水平切分成多个分区，并将它们分布在不同的节点上，以优化查询性能和数据管理。
3. 复制（Replication）：为了提高数据的可用性和耐久性，数据可以在不同节点之间复制。
4. 两阶段提交（2PC）或共识协议：为保证分布式事务的一致性，NewSQL数据库可能会实现两阶段提交或其他共识协议，如Paxos或Raft。
5. 存储引擎优化：高效的存储引擎可以提供快速的数据访问和修改，特别是对于索引和查询优化。

**代表性NewSQL数据库**

- Google Spanner：是Google开发的全球分布式数据库，支持SQL查询语言，并提供了外部一致性和全球事务。
- CockroachDB：是一个分布式SQL数据库，支持ACID事务，并且自动处理数据的分割和复制。
- TiDB：是一个开源的分布式SQL数据库，支持水平扩展，兼容MySQL协议。
- VoltDB：是一个面向快速数据处理的内存数据库系统，支持SQL和ACID事务。
- NuoDB：称为"新一代SQL数据库"，提供了一个分布式对象架构，旨在适应云应用程序的需求。

**使用场景**

NewSQL数据库通常在需要强事务保证和SQL接口的同时要求高性能和良好扩展性的场景中使用。它们适合于金融服务、电子商务、实时分析和任何需要高效事务处理的大型分布式应用程序。

**总结**

NewSQL数据库提供了一种折衷的解决方案，结合了关系型数据库的可靠事务和数据完整性，以及NoSQL数据库的可伸缩性和高性能。对许多企业来说，NewSQL是在大规模操作和复杂查询需求上的现代化选择，它们支持传统SQL的优势而不牺牲关系型数据库的关键特性。

